
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymchelper.flair.common.csg &#8212; pymchelper 1.10.0+rev3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymchelper 1.10.0+rev3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymchelper.flair.common.csg</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymchelper.flair.common.csg</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright and User License</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># Copyright Vasilis.Vlachoudis@cern.ch for the</span>
<span class="c1"># European Organization for Nuclear Research (CERN)</span>
<span class="c1">#</span>
<span class="c1"># All rights not expressly granted under this license are reserved.</span>
<span class="c1">#</span>
<span class="c1"># Installation, use, reproduction, display of the</span>
<span class="c1"># software (&quot;flair&quot;), in source and binary forms, are</span>
<span class="c1"># permitted free of charge on a non-exclusive basis for</span>
<span class="c1"># internal scientific, non-commercial and non-weapon-related</span>
<span class="c1"># use by non-profit organizations only.</span>
<span class="c1">#</span>
<span class="c1"># For commercial use of the software, please contact the main</span>
<span class="c1"># author Vasilis.Vlachoudis@cern.ch for further information.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#    documentation and/or other materials provided with the</span>
<span class="c1">#    distribution.</span>
<span class="c1">#</span>
<span class="c1"># DISCLAIMER</span>
<span class="c1"># ~~~~~~~~~~</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE AUTHOR &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT</span>
<span class="c1"># NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY, OF</span>
<span class="c1"># SATISFACTORY QUALITY, AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># OR USE ARE DISCLAIMED. THE COPYRIGHT HOLDERS AND THE</span>
<span class="c1"># AUTHORS MAKE NO REPRESENTATION THAT THE SOFTWARE AND</span>
<span class="c1"># MODIFICATIONS THEREOF, WILL NOT INFRINGE ANY PATENT,</span>
<span class="c1"># COPYRIGHT, TRADE SECRET OR OTHER PROPRIETARY RIGHT.</span>
<span class="c1">#</span>
<span class="c1"># LIMITATION OF LIABILITY</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># THE COPYRIGHT HOLDERS AND THE AUTHORS SHALL HAVE NO</span>
<span class="c1"># LIABILITY FOR DIRECT, INDIRECT, SPECIAL, INCIDENTAL,</span>
<span class="c1"># CONSEQUENTIAL, EXEMPLARY, OR PUNITIVE DAMAGES OF ANY</span>
<span class="c1"># CHARACTER INCLUDING, WITHOUT LIMITATION, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES, LOSS OF USE, DATA OR PROFITS,</span>
<span class="c1"># OR BUSINESS INTERRUPTION, HOWEVER CAUSED AND ON ANY THEORY</span>
<span class="c1"># OF CONTRACT, WARRANTY, TORT (INCLUDING NEGLIGENCE), PRODUCT</span>
<span class="c1"># LIABILITY OR OTHERWISE, ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="c1"># THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<span class="c1"># Author:	Vasilis.Vlachoudis@cern.ch</span>
<span class="c1"># Date:	18-May-2004</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Vasilis Vlachoudis&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;Vasilis.Vlachoudis@cern.ch&quot;</span>


<div class="viewcode-block" id="CSGException"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.CSGException">[docs]</a><span class="k">class</span> <span class="nc">CSGException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="n">MAXEXPR</span> <span class="o">=</span> <span class="mi">10000</span>


<div class="viewcode-block" id="tokenize"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.tokenize">[docs]</a><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return a list of expression tokens&quot;&quot;&quot;</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Skip comments</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot; + &quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; - &quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot; # &quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot; | &quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot; ( &quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot; ) &quot;</span><span class="p">)</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">lst</span></div>


<div class="viewcode-block" id="splitZones"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.splitZones">[docs]</a><span class="k">def</span> <span class="nf">splitZones</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;split a tokenized expression into zones&quot;&quot;&quot;</span>
    <span class="n">zones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zone</span><span class="p">:</span>
                <span class="n">zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
                <span class="n">zone</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">continue</span>

        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;)&quot;</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CSGException</span><span class="p">(</span><span class="s2">&quot;Too many closing parenthesis&quot;</span><span class="p">)</span>

        <span class="n">zone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">zone</span><span class="p">:</span>
        <span class="n">zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">zones</span></div>


<div class="viewcode-block" id="toString"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.toString">[docs]</a><span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return a string version of a tokenize expression&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; | &quot;</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">token</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="check"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.check">[docs]</a><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check depth of an rpn expression&quot;&quot;&quot;</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">):</span>
            <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="exp2rpn"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.exp2rpn">[docs]</a><span class="k">def</span> <span class="nf">exp2rpn</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the FLUKA Boolean expression to Reverse Polish Notation (RPN)</span>
<span class="sd">    Since the normalization routine does not accept the +/- as signs to</span>
<span class="sd">    objects, the routine is converting the leading - to @- (Universe minus)</span>
<span class="sd">    where the special symbol @ is treated as the universe.</span>
<span class="sd">    Furthermore the leading + is ignored as well as the leading | which is</span>
<span class="sd">    accepted by fluka.</span>

<span class="sd">    WARNING: No check is done for the correctness of the expression apart</span>
<span class="sd">             from the parenthesis nesting</span>

<span class="sd">    ie.</span>
<span class="sd">           A+B         -&gt; A B +</span>
<span class="sd">          (A+B)|C      -&gt; A B + C |</span>
<span class="sd">          (A|B)|C+D|E  -&gt; A B | C D + | E |</span>
<span class="sd">          -A           -&gt; @ A -</span>
<span class="sd">          -(-A)        -&gt; @ @ A - -</span>

<span class="sd">    The routine is using the same array for returning the Reverse Polish</span>
<span class="sd">    expression, since the format is more compact.</span>
<span class="sd">    This is generally true apart one case -A -&gt; @ A -</span>

<span class="sd">    Priorities are treated as:</span>
<span class="sd">        Operator  Priority         In     Out</span>
<span class="sd">        --------  --------        ---     ---</span>
<span class="sd">          |       lower             1       2</span>
<span class="sd">          +       high              3       4</span>
<span class="sd">          -       high              3       4</span>
<span class="sd">          (       higher           99       0</span>
<span class="sd">          )       higher            0      99</span>
<span class="sd">          object  highest         101     100</span>

<span class="sd">    Algorithm</span>
<span class="sd">     Consider the expression as a train moving on a railroad with a</span>
<span class="sd">     T-shape, where each token is one wagon</span>

<span class="sd">                         &lt;-  (A|B)|C+D</span>
<span class="sd">         ------------.   .------------</span>
<span class="sd">         RPN-End      | /      Exp-End</span>
<span class="sd">                       |</span>
<span class="sd">                      S|</span>
<span class="sd">                      t|</span>
<span class="sd">                      a|</span>
<span class="sd">                      c|</span>
<span class="sd">                      k|</span>

<span class="sd">     Each wagon to move from the Exp-End to the RPN-End it has to make</span>
<span class="sd">     a stop first in the Stack-End. Before entering in the stack, the</span>
<span class="sd">     priority-IN will be checked against the objects in the stack.</span>
<span class="sd">     All top-most objects currently present in the stack with</span>
<span class="sd">     higher priority-OUT will be transfered from the stack to the</span>
<span class="sd">     RPN-End. Apart from the opening parenthesis ( which is discarded.</span>

<span class="sd">     Example:</span>
<span class="sd">     (1)                         A+B|C (1)</span>
<span class="sd">     (2) A                        +B|C (2)</span>
<span class="sd">     (3) A                         B|C (3)</span>
<span class="sd">     (4) A                          |C (4)</span>
<span class="sd">     (5) A B +                       C (5)</span>
<span class="sd">     (6) A B + C</span>
<span class="sd">     (7) A B + C |</span>
<span class="sd">         ------------.   .------------</span>
<span class="sd">         RPN-End      | /      Exp-End</span>
<span class="sd">                       |</span>
<span class="sd">                      S|</span>
<span class="sd">                      t|</span>
<span class="sd">                      a|</span>
<span class="sd">                      c|     B   C</span>
<span class="sd">                      k| A + + | | |</span>
<span class="sd">                         1 2 3 4 5 6 7</span>
<span class="sd">    :param expr:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;Replace expression list expr to rpn format&quot;&quot;&quot;</span>
    <span class="c1">#              Operator In Out</span>
    <span class="n">priorities</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;(&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">99</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;)&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">101</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newproduct</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="n">tcur</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Check for special leading chars</span>
        <span class="k">if</span> <span class="n">newproduct</span> <span class="ow">and</span> <span class="n">tcur</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">):</span>
            <span class="n">newproduct</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcur</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">newproduct</span> <span class="ow">and</span> <span class="n">tcur</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>  <span class="c1"># insert space in ith position</span>
            <span class="n">tcur</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span>  <span class="c1"># Universe</span>

        <span class="n">newproduct</span> <span class="o">=</span> <span class="n">tcur</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>

        <span class="c1"># Find priorities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prio</span> <span class="o">=</span> <span class="n">priorities</span><span class="p">[</span><span class="n">tcur</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">prio</span> <span class="o">=</span> <span class="n">priorities</span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">]</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">prio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">prio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Remove from the stack everything with higher priority</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ip</span> <span class="o">&lt;</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                <span class="n">expr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Push it into the stack</span>
        <span class="k">if</span> <span class="n">tcur</span> <span class="o">!=</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tcur</span><span class="p">,</span> <span class="n">op</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Should be an opening parenthesis</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CSGException</span><span class="p">(</span><span class="s2">&quot;Unbalanced parenthesis&quot;</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Empty Stack</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CSGException</span><span class="p">(</span><span class="s2">&quot;Unbalanced parenthesis&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Delete unwanted items</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>


<div class="viewcode-block" id="rpnorm"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.rpnorm">[docs]</a><span class="k">def</span> <span class="nf">rpnorm</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a CG expression given in Reverse Polish Notation.</span>
<span class="sd">    Normalized CG expression is an expression given as sum (Boolean OR) of</span>
<span class="sd">    products (Boolean intersection or subtraction).</span>
<span class="sd">    The normalization (expansion of parenthesis and operator priorities)</span>
<span class="sd">    should be performed by recursively calling the RPNRULE subroutine.</span>
<span class="sd">    Since Fortran-77 doesn&#39;t have recursion, call the RPNRULE for every</span>
<span class="sd">    operator starting from the right-most one, until no rule is found.</span>
<span class="sd">    :param expr:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Loop until there is no any extra change needed</span>
    <span class="c1"># Scan to find the first operators</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tx</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">):</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="n">_rpnrule</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rule</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">-</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAXEXPR</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CSGException</span><span class="p">(</span><span class="s2">&quot;Expansion failed. Too many terms&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_subTerms</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routine returns the pointers in the RPN terms array of the</span>
<span class="sd">    starting point of the left sub-expression LOWLEFT and right</span>
<span class="sd">    sub-expression LOWRIGHT given the pointer of the expr-operator NTX.</span>
<span class="sd">    The searching is performed by scanning from right to left the number</span>
<span class="sd">    of operators and objects pushed into the stack</span>

<span class="sd">    EXP          (expr-left) op (expr-right)</span>

<span class="sd">    RPN ...... | expr-left | expr-right | op | .......</span>
<span class="sd">              Lowleft      LowRight  op-1 ntx</span>
<span class="sd">    :param expr:</span>
<span class="sd">    :param n:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nop</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lowRight</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lowLeft</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">):</span>
            <span class="n">nop</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nop</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lowRight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lowRight</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">nop</span> <span class="o">=</span> <span class="n">nop</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lowLeft</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="n">lowLeft</span><span class="p">,</span> <span class="n">lowRight</span>
    <span class="k">return</span> <span class="n">lowLeft</span><span class="p">,</span> <span class="n">lowRight</span>


<span class="k">def</span> <span class="nf">_rpnrule</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find a matching rule and apply it on the sub-expression starting from</span>
<span class="sd">    the N position in the Reverse Polish Notation</span>

<span class="sd">    An expression is in normal form when all the parenthesis are expanded</span>
<span class="sd">    and the expression is described as a sum (UNIONS) of products</span>
<span class="sd">    (INTERSECTIONS and/or SUBTRACTIONS)</span>

<span class="sd">    An expression can be converted to normal form by repeatedly applying</span>
<span class="sd">    the following set of production rules to the expression and then to its</span>
<span class="sd">    sub-expressions:</span>

<span class="sd">       Normal Form                        Reverse Polish Notation</span>
<span class="sd">     1. X-(Y|Z) -&gt; (X-Y)-Z                X Y Z | -  -&gt;  X Y - Z -</span>
<span class="sd">     2. X+(Y|Z) -&gt; (X+Y)|(X+Z)            X Y Z | +  -&gt;  X Y + X Z + |</span>
<span class="sd">     3. X-(Y+Z) -&gt; (X-Y)|(X-Z)            X Y Z + -  -&gt;  X Y - X Z - |</span>
<span class="sd">     4. X+(Y+Z) -&gt; (X+Y)+Z                X Y Z + +  -&gt;  X Y + Z +</span>
<span class="sd">     5. X-(Y-Z) -&gt; (X-Y)|(X+Z)            X Y Z - -  -&gt;  X Y - X Z + |</span>
<span class="sd">     6. X+(Y-Z) -&gt; (X+Y)-Z                X Y Z - +  -&gt;  X Y + Z -</span>
<span class="sd">     7. X|(Y|Z) -&gt; (X|Y)|Z                X Y Z | |  -&gt;  X Y | Z |</span>
<span class="sd">     8. (X-Y)+Z -&gt; (X+Z)-Y                X Y - Z +  -&gt;  X Z + Y -</span>
<span class="sd">     9. (X|Y)-Z -&gt; (X-Z)|(Y-Z)            X Y | Z -  -&gt;  X Z - Y Z - |</span>
<span class="sd">    10. (X|Y)+Z -&gt; (X+Z)|(Y+Z)            X Y | Z +  -&gt;  X Z + Y Z + |</span>
<span class="sd">    X,Y, and Z here match both primitives or sub-expressions.</span>
<span class="sd">    :param expr:</span>
<span class="sd">    :param n:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reset rule</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Top-most operator</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rule</span>

    <span class="c1"># Right operator</span>
    <span class="n">rop</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Find left and right sub-trees</span>
    <span class="n">ll</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">_subTerms</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Left operator</span>
    <span class="n">lop</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
    <span class="k">if</span> <span class="n">lr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lop</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">lr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Find Rule</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span> <span class="ow">and</span> <span class="n">rop</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">and</span> <span class="n">lop</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">lop</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="ow">and</span> <span class="n">lop</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rule</span>

    <span class="c1"># Find sub expressions X Y Z</span>
    <span class="k">if</span> <span class="n">rule</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># X op (Y rop Z)</span>
        <span class="n">Xu</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Xl</span> <span class="o">=</span> <span class="n">ll</span>

        <span class="n">ll</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">_subTerms</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Yu = lr - 1    # TODO why not used ?</span>
        <span class="c1"># Yl = ll        # TODO why not used ?</span>
        <span class="n">Zu</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">Zl</span> <span class="o">=</span> <span class="n">lr</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># (X lop Y) op Z</span>
        <span class="n">Zu</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Zl</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ll</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">_subTerms</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">Xu</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Xl</span> <span class="o">=</span> <span class="n">ll</span>
        <span class="c1"># Yu = L - 1  # TODO why not used ?</span>
        <span class="c1"># Yl = lr     # TODO why not used ?</span>

    <span class="c1"># Expand the rule</span>
    <span class="c1"># 1. X-(Y|Z) -&gt; (X-Y)-Z	 X Y Z | -  -&gt;  X Y - Z -</span>
    <span class="k">if</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a - operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="c1"># Chop length by 1</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Change the last operator to -</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

    <span class="c1"># 2. X+(Y|Z) -&gt; (X+Y)|(X+Z)     X Y Z + |  -&gt;  X Y + X Z + |</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a + operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="c1"># Copy X after the + operator</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">Zl</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">to</span><span class="p">:</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">Xl</span><span class="p">:</span><span class="n">Xu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Zu</span> <span class="o">+=</span> <span class="n">Xu</span> <span class="o">-</span> <span class="n">Xl</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="c1"># Change last 2 operators to + |</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>

    <span class="c1"># 3. X-(Y+Z) -&gt; (X-Y)|(X-Z)     X Y Z + -  -&gt;  X Y - X Z - |</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a - operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="c1"># Copy X after the - operator</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">Zl</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">to</span><span class="p">:</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">Xl</span><span class="p">:</span><span class="n">Xu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Zu</span> <span class="o">+=</span> <span class="n">Xu</span> <span class="o">-</span> <span class="n">Xl</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="c1"># Change last 2 operators to - |</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>

    <span class="c1"># 4. X+(Y+Z) -&gt; (X+Y)+Z	 X Y Z + +  -&gt;  X Y + Z +</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a + operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="c1"># Chop length by 1</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Change the last operator to +</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>

    <span class="c1"># 5. X-(Y-Z) -&gt; (X-Y)|(X+Z)     X Y Z - -  -&gt;  X Y - X Z + |</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a - operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="c1"># Copy X after the - operator</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">Zl</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">to</span><span class="p">:</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">Xl</span><span class="p">:</span><span class="n">Xu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">Zu</span> <span class="o">+=</span> <span class="n">Xu</span> <span class="o">-</span> <span class="n">Xl</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="c1"># Change last 2 operators to + |</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>

    <span class="c1"># 6. X+(Y-Z) -&gt; (X+Y)-Z	 X Y Z - +  -&gt;  X Y + Z -</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a + operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
        <span class="c1"># Chop length by 1</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Change the last operator to -</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

    <span class="c1"># 7. X|(Y|Z) -&gt; (X|Y)|Z	 X Y Z | |  -&gt;  X Y | Z |</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="c1"># Leave X Y</span>
        <span class="c1"># Insert a | operator after Y</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zl</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="c1"># Chop length by 1</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Change the last operator to |</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>

    <span class="c1"># 8. (X-Y)+Z -&gt; (X+Z)-Y	 X Y - Z +  -&gt;  X Z + Y -</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="c1"># Leave X</span>
        <span class="c1"># Copy &quot;Z +&quot; after X</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">Zu</span> <span class="o">-</span> <span class="n">Zl</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">Xu</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">to</span><span class="p">:</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zl</span><span class="p">:</span><span class="n">Zl</span> <span class="o">+</span> <span class="n">L</span><span class="p">]</span>
        <span class="c1"># Delete old &quot;Z +&quot;</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zl</span> <span class="o">+</span> <span class="n">L</span><span class="p">:</span><span class="n">Zl</span> <span class="o">+</span> <span class="n">L</span> <span class="o">+</span> <span class="n">L</span><span class="p">]</span>

    <span class="c1">#  9. (X|Y)-Z -&gt; (X-Z)|(Y-Z)     X Y | Z -  -&gt;  X Z - Y Z - |</span>
    <span class="c1"># 10. (X|Y)+Z -&gt; (X+Z)|(Y+Z)     X Y | Z +  -&gt;  X Z + Y Z + |</span>
    <span class="k">elif</span> <span class="n">rule</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Leave X</span>
        <span class="c1"># Copy &quot;Z -&quot; or &quot;Z +&quot; after X</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">Zu</span> <span class="o">-</span> <span class="n">Zl</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">to</span> <span class="o">=</span> <span class="n">Xu</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">to</span><span class="p">:</span><span class="n">to</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zl</span><span class="p">:</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Correct Z position</span>
        <span class="n">Zl</span> <span class="o">+=</span> <span class="n">L</span>
        <span class="n">Zu</span> <span class="o">+=</span> <span class="n">L</span>
        <span class="c1"># Delete the | infront of Z</span>
        <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="n">Zl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Add | at the end</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Zu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rule</span>


<div class="viewcode-block" id="rpn2exp"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.rpn2exp">[docs]</a><span class="k">def</span> <span class="nf">rpn2exp</span><span class="p">(</span><span class="n">rpn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a NORMALIZED Reverse Polish notation to a standard expression</span>
<span class="sd">    WARNING: The routine expects an expression where for each UNION</span>
<span class="sd">    operator the right-sub-expression is a product while the left can be</span>
<span class="sd">    UNION or a product</span>
<span class="sd">    :param rpn:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plus</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">minus</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nstack</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">endprod</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpn</span><span class="p">):</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">rpn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tx</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">):</span>
            <span class="n">nstack</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># First term is always a plus</span>
            <span class="c1"># .. peek then next operator to check for sign</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rpn</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">plus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
                <span class="n">lastPlus</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">rpn</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">minus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
                <span class="n">lastPlus</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nstack</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nstack</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">endprod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">nstack</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lastPlus</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">plus</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">minus</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">endprod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">tx</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">endprod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">endprod</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">endprod</span><span class="p">:</span>
            <span class="n">optZone</span><span class="p">(</span><span class="n">plus</span><span class="p">,</span> <span class="n">minus</span><span class="p">)</span>
            <span class="c1"># remove None terms</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">plus</span><span class="p">)</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">minus</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">minus</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">zones</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plus</span><span class="p">,</span> <span class="n">minus</span><span class="p">))</span>
            <span class="n">plus</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">minus</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nstack</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">endprod</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Remove duplicates of products</span>
    <span class="n">rmDoubles</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span>

    <span class="c1"># Reconstruct expression</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">plus</span><span class="p">,</span> <span class="n">minus</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">expr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="c1"># Fill the new array</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">plus</span><span class="p">:</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">minus</span><span class="p">:</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">expr</span></div>


<div class="viewcode-block" id="optZone"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.optZone">[docs]</a><span class="k">def</span> <span class="nf">optZone</span><span class="p">(</span><span class="n">plus</span><span class="p">,</span> <span class="n">minus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize a product, by removing the universe @, duplicated terms like</span>
<span class="sd">    A+A, A-A, -A-A, and finally calling the geometrical optimizations and</span>
<span class="sd">    sorting by name the primitives in both the plus and minus terms.</span>

<span class="sd">    The product is described by 2 arrays the PLUS,NPLUS and MINUS,NMINUS</span>
<span class="sd">    with all the plus and minus terms of the product</span>

<span class="sd">    WARNING: It doesn&#39;t delete the term from the arrays but changes the</span>
<span class="sd">    name to space.</span>
<span class="sd">    :param plus:</span>
<span class="sd">    :param minus:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Remove Universe @ from PLUS</span>
    <span class="c1"># and</span>
    <span class="c1"># remove duplicate terms A+A=A, A-A={}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plus</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">plus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">plus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">plus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">plus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">plus</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">plus</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minus</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">plus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">minus</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="c1"># Remove everything</span>
                    <span class="k">del</span> <span class="n">plus</span><span class="p">[:]</span>
                    <span class="k">del</span> <span class="n">minus</span><span class="p">[:]</span>
                    <span class="k">return</span>

    <span class="c1"># Discard product if universe @ exists in MINUS</span>
    <span class="c1"># Check for duplicates in MINUS like -A-A=-A</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minus</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">minus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
            <span class="c1"># Remove everything</span>
            <span class="k">del</span> <span class="n">plus</span><span class="p">[:]</span>
            <span class="k">del</span> <span class="n">minus</span><span class="p">[:]</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">minus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">minus</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">minus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">minus</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">minus</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Perform the Geometrical optimization in the product</span>
    <span class="c1"># call OptGeo(nplus,plus,nminus,minus)</span>

    <span class="c1"># Peform a bubble sort on product terms</span>
    <span class="n">plus</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">minus</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span></div>


<div class="viewcode-block" id="rmDoubles"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.rmDoubles">[docs]</a><span class="k">def</span> <span class="nf">rmDoubles</span><span class="p">(</span><span class="n">zones</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove duplicates of products A+B|A+B|C+D  -&gt;  A+B|C+D</span>
<span class="sd">    :param zones:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">plus1</span><span class="p">,</span> <span class="n">minus1</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">plus2</span><span class="p">,</span> <span class="n">minus2</span> <span class="o">=</span> <span class="n">zones</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># Check if they are the same</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plus2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">minus1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">minus2</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">diffplus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plus1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">plus1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">plus2</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">diffplus</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="k">break</span>

            <span class="n">diffminus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minus1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">minus1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">minus2</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">diffminus</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">diffplus</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">diffminus</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">zones</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">continue</span></div>


<div class="viewcode-block" id="split"><a class="viewcode-back" href="../../../../apidoc/pymchelper.flair.common.csg.html#pymchelper.flair.common.csg.split">[docs]</a><span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Break products into lists</span>
<span class="sd">    :param expr:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">brk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[:]</span>  <span class="c1"># Make a copy of the expression</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
            <span class="n">brk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">p</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">brk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">brk</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymchelper 1.10.0+rev3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pymchelper.flair.common.csg</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Leszek Grzanka.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.0.
    </div>
  </body>
</html>