
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymchelper.flair.Input &#8212; pymchelper 1.11.0 documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">pymchelper</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide.html">
  Userâ€™s Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../install.html">
  Installation Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../developer.html">
  Developer documentation
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for pymchelper.flair.Input</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright and User License</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># Copyright Vasilis.Vlachoudis@cern.ch for the</span>
<span class="c1"># European Organization for Nuclear Research (CERN)</span>
<span class="c1">#</span>
<span class="c1"># All rights not expressly granted under this license are reserved.</span>
<span class="c1">#</span>
<span class="c1"># Installation, use, reproduction, display of the</span>
<span class="c1"># software (&quot;flair&quot;), in source and binary forms, are</span>
<span class="c1"># permitted free of charge on a non-exclusive basis for</span>
<span class="c1"># internal scientific, non-commercial and non-weapon-related</span>
<span class="c1"># use by non-profit organizations only.</span>
<span class="c1">#</span>
<span class="c1"># For commercial use of the software, please contact the main</span>
<span class="c1"># author Vasilis.Vlachoudis@cern.ch for further information.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#    notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#    documentation and/or other materials provided with the</span>
<span class="c1">#    distribution.</span>
<span class="c1">#</span>
<span class="c1"># DISCLAIMER</span>
<span class="c1"># ~~~~~~~~~~</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE AUTHOR &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT</span>
<span class="c1"># NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY, OF</span>
<span class="c1"># SATISFACTORY QUALITY, AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># OR USE ARE DISCLAIMED. THE COPYRIGHT HOLDERS AND THE</span>
<span class="c1"># AUTHORS MAKE NO REPRESENTATION THAT THE SOFTWARE AND</span>
<span class="c1"># MODIFICATIONS THEREOF, WILL NOT INFRINGE ANY PATENT,</span>
<span class="c1"># COPYRIGHT, TRADE SECRET OR OTHER PROPRIETARY RIGHT.</span>
<span class="c1">#</span>
<span class="c1"># LIMITATION OF LIABILITY</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># THE COPYRIGHT HOLDERS AND THE AUTHORS SHALL HAVE NO</span>
<span class="c1"># LIABILITY FOR DIRECT, INDIRECT, SPECIAL, INCIDENTAL,</span>
<span class="c1"># CONSEQUENTIAL, EXEMPLARY, OR PUNITIVE DAMAGES OF ANY</span>
<span class="c1"># CHARACTER INCLUDING, WITHOUT LIMITATION, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES, LOSS OF USE, DATA OR PROFITS,</span>
<span class="c1"># OR BUSINESS INTERRUPTION, HOWEVER CAUSED AND ON ANY THEORY</span>
<span class="c1"># OF CONTRACT, WARRANTY, TORT (INCLUDING NEGLIGENCE), PRODUCT</span>
<span class="c1"># LIABILITY OR OTHERWISE, ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="c1"># THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<span class="c1"># DAMAGES.</span>
<span class="c1">#</span>

<span class="c1"># input useful functions:</span>
<span class="c1">#  - read/write : read/write an input file</span>
<span class="c1">#  - clone</span>
<span class="c1"># - checkFormat(card) FORMAT_FREE / FORMAT_SINGLE</span>
<span class="c1"># - addCard(card)</span>
<span class="c1"># - delCard(card)</span>
<span class="c1"># - delTag(tag) - delete all cards with specific tag</span>
<span class="c1"># - delGeometryCards</span>
<span class="c1"># - replaceCard(position, card)</span>
<span class="c1"># - convert2Names - Convert input to names and check for obsolete and/or non-valid cards</span>
<span class="c1"># - validate - ??</span>
<span class="c1"># - checkNumbering - ??</span>
<span class="c1"># - minimumInput</span>
<span class="c1"># - renumber</span>
<span class="c1">#</span>
<span class="c1"># Card useful functions:</span>
<span class="c1"># - __init__(self, tag, what=None, comment=&quot;&quot;, extra=&quot;&quot;)</span>
<span class="c1"># - clone</span>
<span class="c1"># - appendWhats(self, what, pos=None)</span>
<span class="c1"># - appendComment(self, comment):</span>
<span class="c1"># - validate(self, case=None):</span>
<span class="c1"># - convert(self, tonames=True)</span>
<span class="c1"># - whats(self), nwhats()</span>
<span class="c1"># - sdum</span>
<span class="c1"># - extra</span>
<span class="c1"># - comment</span>
<span class="c1"># - isGeo</span>
<span class="c1"># - type</span>
<span class="c1"># - tag</span>
<span class="c1"># - what(self, n)</span>
<span class="c1"># - setComment(self, comment=&quot;&quot;)</span>
<span class="c1"># - setWhats(self, whats)</span>
<span class="c1"># - setSdum(self, s)</span>
<span class="c1"># - setExtra(self, e)</span>
<span class="c1"># - setWhat(self, w, v)</span>
<span class="c1"># - units(self, absolute=True) units used by card</span>
<span class="c1"># - commentStr(self)</span>
<span class="c1"># - def toStr(self, fmt=None)</span>
<span class="c1"># - addZone(self, zone)</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">string</span>


<span class="kn">import</span> <span class="nn">pymchelper.flair.common.fortran</span> <span class="k">as</span> <span class="nn">fortran</span>
<span class="kn">import</span> <span class="nn">pymchelper.flair.common.bmath</span> <span class="k">as</span> <span class="nn">bmath</span>
<span class="kn">import</span> <span class="nn">pymchelper.flair.common.csg</span> <span class="k">as</span> <span class="nn">csg</span>
<span class="kn">from</span> <span class="nn">pymchelper.flair.common.log</span> <span class="k">import</span> <span class="n">say</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">IntType</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">LongType</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">FloatType</span> <span class="o">=</span> <span class="nb">float</span>
    <span class="n">BooleanType</span> <span class="o">=</span> <span class="nb">bool</span>
    <span class="n">StringType</span> <span class="o">=</span> <span class="nb">bytes</span>
    <span class="n">UnicodeType</span> <span class="o">=</span> <span class="nb">str</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="k">import</span> <span class="n">IntType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">BooleanType</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">UnicodeType</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">configparser</span> <span class="k">as</span> <span class="nn">ConfigParser</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Vasilis Vlachoudis&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;Vasilis.Vlachoudis@cern.ch&quot;</span>


<span class="n">__first</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># -------------------------------------------------------------------------------</span>
<span class="c1"># Activate untest developer code</span>
<span class="n">_developer</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_useQUA</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">_database</span> <span class="o">=</span> <span class="s2">&quot;db/card.ini&quot;</span>

<span class="n">_NAMEPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[A-Za-z_][A-Za-z0-9_.:!\$]*$&quot;</span><span class="p">)</span>
<span class="n">_REGIONPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*([A-Za-z_][A-Za-z0-9_.:!\$]*)\s*(-?\d+)\s*(.*)$&quot;</span><span class="p">)</span>
<span class="n">_VOXELPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^VOX[E]?[L]?(\d+)$&quot;</span><span class="p">)</span>
<span class="n">_CWHAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[*!]@what\.(-?\d+)(=.*)$&quot;</span><span class="p">)</span>
<span class="n">_OPT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^!@(\w+)=(.*)$&quot;</span><span class="p">)</span>
<span class="n">_wPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bw\(&quot;</span><span class="p">)</span>
<span class="n">_WPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bW\(&quot;</span><span class="p">)</span>
<span class="n">_WNPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b([wW])\((-?\d+)\)&quot;</span><span class="p">)</span>
<span class="n">_ROTPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^ROT?#(\d+)$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="c1"># _PRPPAT    = re.compile(r&quot;^(#\w+)\b *(\w*)[ ,/;\\:] *(.*)$&quot;)</span>
<span class="n">_PRPPAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(#\w+)\b *([A-Za-z0-9_.@-]*) *(.*)$&quot;</span><span class="p">)</span>

<span class="c1"># -------------------------------------------------------------------------------</span>
<span class="c1"># Configuration</span>
<span class="n">commentedCards</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Parse comments for disabled cards</span>
<span class="n">warnMultMat</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Warn user on multiple materials</span>

<span class="c1"># transformation values</span>
<span class="n">zero</span> <span class="o">=</span> <span class="mf">1.0E-10</span>
<span class="n">infinite</span> <span class="o">=</span> <span class="mf">1.0E10</span>

<span class="c1"># -------------------------------------------------------------------------------</span>
<span class="c1"># Global variables</span>
<span class="n">_defaultMaterials</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Default material list (cards)</span>
<span class="n">_defaultMatDict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_icruMaterials</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ICRU special compounds (cards)</span>
<span class="n">_icruMatDict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_neutronGroups</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Neutron energy groups as numbers</span>
<span class="n">_neutronGroupsS</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Neutron energy groups as strings with units</span>
<span class="n">_lowMaterials</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># LOW-NEUT material cross sections</span>
<span class="n">_usermvax</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Description of user routines</span>

<span class="c1"># File formats</span>
<span class="n">FORMAT_SINGLE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FORMAT_DOUBLE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FORMAT_FREE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">FORMAT_VOXEL</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">BODY_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span>
<span class="n">REGION_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>

<span class="n">SCALE</span> <span class="o">=</span> <span class="s2">&quot;*...+....1....+....2....+....3....+....4....+....5....+....6....+....7....+....</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="c1"># SCALE=&quot;*tag-----&gt;&lt;----1---&gt;&lt;---2----&gt;&lt;---3----&gt;&lt;---4----&gt;&lt;---5----&gt;&lt;---6----&gt;&lt;--sdum--\n&quot;</span>
<span class="n">REGSCALE</span> <span class="o">=</span> <span class="s2">&quot;*_..._____.._____.._____.._____.._____.._____.._____.._____.._____.._____</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="n">BODY_TAGS</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Including VOXELS</span>
<span class="n">BODY_NOVXL_TAGS</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Without VOXELS</span>
<span class="n">FLAIR_TAGS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">OBJECT_TAGS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">TRANSFORM_TAGS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">DETECTOR_TAGS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;DETECT&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENTBIN&quot;</span><span class="p">,</span> <span class="s2">&quot;RESNUCLE&quot;</span><span class="p">,</span> <span class="s2">&quot;USRBDX&quot;</span><span class="p">,</span> <span class="s2">&quot;USRBIN&quot;</span><span class="p">,</span> <span class="s2">&quot;USRCOLL&quot;</span><span class="p">,</span> <span class="s2">&quot;USRTRACK&quot;</span><span class="p">,</span> <span class="s2">&quot;USRYIELD&quot;</span><span class="p">)</span>
<span class="n">NGROUPS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Preprocessor cards that increase or decrease the indent</span>
<span class="n">_INDENT_INC</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;#if&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifdef&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifndef&quot;</span><span class="p">,</span> <span class="s2">&quot;#elif&quot;</span><span class="p">,</span> <span class="s2">&quot;#else&quot;</span><span class="p">,</span> <span class="s2">&quot;#include&quot;</span><span class="p">,</span> <span class="s2">&quot;$start_expansion&quot;</span><span class="p">,</span> <span class="s2">&quot;$start_translat&quot;</span><span class="p">,</span>
               <span class="s2">&quot;$start_transform&quot;</span><span class="p">)</span>
<span class="n">_INDENT_DEC</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;#elif&quot;</span><span class="p">,</span> <span class="s2">&quot;#else&quot;</span><span class="p">,</span> <span class="s2">&quot;#endif&quot;</span><span class="p">,</span> <span class="s2">&quot;#endinclude&quot;</span><span class="p">,</span> <span class="s2">&quot;$end_expansion&quot;</span><span class="p">,</span> <span class="s2">&quot;$end_translat&quot;</span><span class="p">,</span> <span class="s2">&quot;$end_transform&quot;</span><span class="p">)</span>
<span class="n">_PREPRO_BLOCK</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;#if&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifdef&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifndef&quot;</span><span class="p">,</span> <span class="s2">&quot;#elif&quot;</span><span class="p">,</span> <span class="s2">&quot;#else&quot;</span><span class="p">,</span> <span class="s2">&quot;#endif&quot;</span><span class="p">)</span>

<span class="c1"># Region types</span>
<span class="n">REGION_NORMAL</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">REGION_BLACKHOLE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">REGION_LATTICE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">REGION_VOXEL</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
<span class="n">_VOLUME</span> <span class="o">=</span> <span class="s2">&quot;@volume&quot;</span>


<div class="viewcode-block" id="Vector"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Vector">[docs]</a><span class="k">class</span> <span class="nc">Vector</span><span class="p">(</span><span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;flair vector returning a string with {} representation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">list</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<span class="n">_globalDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Mathematical constants</span>
    <span class="s2">&quot;fwhm&quot;</span><span class="p">:</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)),</span>

    <span class="c1"># Physics constants</span>
    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">137.035989561</span><span class="p">,</span>
    <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mf">4.135667516e-15</span><span class="p">,</span>  <span class="c1"># eV s</span>
    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mf">299792458e2</span><span class="p">,</span>
    <span class="s2">&quot;Na&quot;</span><span class="p">:</span> <span class="mf">6.0221367e23</span><span class="p">,</span>
    <span class="s2">&quot;qe&quot;</span><span class="p">:</span> <span class="mf">1.60217646e-19</span><span class="p">,</span>
    <span class="s2">&quot;re&quot;</span><span class="p">:</span> <span class="mf">2.8179409183694872e-13</span><span class="p">,</span>

    <span class="c1"># Masses</span>
    <span class="s2">&quot;amu&quot;</span><span class="p">:</span> <span class="mf">0.93149432</span><span class="p">,</span>
    <span class="s2">&quot;amuC12&quot;</span><span class="p">:</span> <span class="mf">0.93123890</span><span class="p">,</span>
    <span class="s2">&quot;amugr&quot;</span><span class="p">:</span> <span class="mf">1.6605402E-24</span><span class="p">,</span>
    <span class="s2">&quot;Mp&quot;</span><span class="p">:</span> <span class="mf">0.93827231</span><span class="p">,</span>
    <span class="s2">&quot;Mn&quot;</span><span class="p">:</span> <span class="mf">0.93956563</span><span class="p">,</span>
    <span class="s2">&quot;Me&quot;</span><span class="p">:</span> <span class="mf">0.510998910e-3</span><span class="p">,</span>

    <span class="c1"># Distances</span>
    <span class="s2">&quot;nm&quot;</span><span class="p">:</span> <span class="mf">0.1E-6</span><span class="p">,</span>
    <span class="s2">&quot;um&quot;</span><span class="p">:</span> <span class="mf">0.1E-3</span><span class="p">,</span>
    <span class="s2">&quot;mm&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s2">&quot;cm&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;dm&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="s2">&quot;km&quot;</span><span class="p">:</span> <span class="mf">100.0e3</span><span class="p">,</span>

    <span class="c1"># Imperial system distances</span>
    <span class="s2">&quot;inch&quot;</span><span class="p">:</span> <span class="mf">2.54</span><span class="p">,</span>
    <span class="s2">&quot;feet&quot;</span><span class="p">:</span> <span class="mf">30.48</span><span class="p">,</span>
    <span class="s2">&quot;ft&quot;</span><span class="p">:</span> <span class="mf">30.48</span><span class="p">,</span>
    <span class="s2">&quot;mile&quot;</span><span class="p">:</span> <span class="mf">160934.4</span><span class="p">,</span>
    <span class="s2">&quot;mi&quot;</span><span class="p">:</span> <span class="mf">160934.4</span><span class="p">,</span>

    <span class="c1"># Time</span>
    <span class="s2">&quot;ns&quot;</span><span class="p">:</span> <span class="mf">1.0e-9</span><span class="p">,</span>
    <span class="s2">&quot;us&quot;</span><span class="p">:</span> <span class="mf">1.0e-6</span><span class="p">,</span>
    <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mf">60.0</span><span class="p">,</span>
    <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mf">86400.0</span><span class="p">,</span>
    <span class="s2">&quot;week&quot;</span><span class="p">:</span> <span class="mf">7.0</span> <span class="o">*</span> <span class="mf">86400.0</span><span class="p">,</span>
    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="mf">365.25</span> <span class="o">/</span> <span class="mf">12.0</span> <span class="o">*</span> <span class="mf">86400.0</span><span class="p">,</span>
    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mf">365.25</span> <span class="o">*</span> <span class="mf">86400.0</span><span class="p">,</span>

    <span class="c1"># Prefixes</span>
    <span class="s2">&quot;yotta&quot;</span><span class="p">:</span> <span class="mf">1e24</span><span class="p">,</span>
    <span class="s2">&quot;zetta&quot;</span><span class="p">:</span> <span class="mf">1e21</span><span class="p">,</span>
    <span class="s2">&quot;exa&quot;</span><span class="p">:</span> <span class="mf">1e18</span><span class="p">,</span>
    <span class="s2">&quot;peta&quot;</span><span class="p">:</span> <span class="mf">1e15</span><span class="p">,</span>
    <span class="s2">&quot;tera&quot;</span><span class="p">:</span> <span class="mf">1e12</span><span class="p">,</span>
    <span class="s2">&quot;giga&quot;</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">,</span>
    <span class="s2">&quot;mega&quot;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>
    <span class="s2">&quot;kilo&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;hecto&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span>
    <span class="s2">&quot;deca&quot;</span><span class="p">:</span> <span class="mf">1e1</span><span class="p">,</span>
    <span class="s2">&quot;deci&quot;</span><span class="p">:</span> <span class="mf">1e-1</span><span class="p">,</span>
    <span class="s2">&quot;centi&quot;</span><span class="p">:</span> <span class="mf">1e-2</span><span class="p">,</span>
    <span class="s2">&quot;milli&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;micro&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="s2">&quot;nano&quot;</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
    <span class="s2">&quot;pico&quot;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
    <span class="s2">&quot;femto&quot;</span><span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
    <span class="s2">&quot;atto&quot;</span><span class="p">:</span> <span class="mf">1e-18</span><span class="p">,</span>
    <span class="s2">&quot;zepto&quot;</span><span class="p">:</span> <span class="mf">1e-21</span><span class="p">,</span>
    <span class="s2">&quot;yocto&quot;</span><span class="p">:</span> <span class="mf">1e-24</span><span class="p">,</span>

    <span class="c1"># Energy</span>
    <span class="s2">&quot;eV&quot;</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span>
    <span class="s2">&quot;keV&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span>
    <span class="s2">&quot;MeV&quot;</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="s2">&quot;GeV&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;TeV&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
    <span class="s2">&quot;PeV&quot;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>
    <span class="s2">&quot;J&quot;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">1.60217646e-10</span><span class="p">,</span>

    <span class="c1"># Angle</span>
    <span class="s2">&quot;deg&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span><span class="p">,</span>
    <span class="s2">&quot;rad&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;mrad&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>

    <span class="c1"># Trig functions in degrees</span>
    <span class="s2">&quot;sind&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s2">&quot;cosd&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s2">&quot;tand&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s2">&quot;asind&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="s2">&quot;acosd&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="s2">&quot;atand&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>

    <span class="c1"># Generic functions</span>
    <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">,</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
    <span class="s2">&quot;str&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>

    <span class="c1"># Physics functions</span>
    <span class="s2">&quot;T2g&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">T</span> <span class="o">/</span> <span class="n">m</span><span class="p">,</span>
    <span class="s2">&quot;g2b&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;b2g&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;p2T&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span>
    <span class="s2">&quot;T2p&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">T</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">T</span><span class="p">),</span>
    <span class="s2">&quot;dT2dp&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">T</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">dT</span><span class="p">,</span>
    <span class="s2">&quot;omega&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
    <span class="s2">&quot;omegad&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span>
    <span class="s2">&quot;X0&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">Z</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="mf">716.4</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Z</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">287.</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Z</span><span class="p">)))),</span>

    <span class="c1"># Vector and matrices</span>
    <span class="s2">&quot;Vector&quot;</span><span class="p">:</span> <span class="n">Vector</span><span class="p">,</span>
    <span class="s2">&quot;Matrix&quot;</span><span class="p">:</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Populate math functions on the local dict</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">math</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">_globalDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<div class="viewcode-block" id="LocalDict"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LocalDict">[docs]</a><span class="k">class</span> <span class="nc">LocalDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement the local dictionary&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">card</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="LocalDict.clear"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LocalDict.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear dictionary and set default variables&quot;&quot;&quot;</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">bodyWhat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">cardWhat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default getitem&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># check defines</span>
            <span class="n">defines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="s2">&quot;#define&quot;</span><span class="p">)</span>
            <span class="c1"># dummy linear search</span>
            <span class="k">for</span> <span class="n">define</span> <span class="ow">in</span> <span class="n">defines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">define</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">define</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">item</span><span class="p">:</span>
                    <span class="c1"># Convert to int or float if possible</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">define</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">f</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_globalDict</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="c1"># FIXME check for a card like BEAM(0,1)</span>
            <span class="c1"># if cards: return lambda n,w,t=item,s=self: s.cardWhat(t,n,w)</span>
            <span class="c1"># return str(item)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="LocalDict.bodyWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LocalDict.bodyWhat">[docs]</a>    <span class="k">def</span> <span class="nf">bodyWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">bodies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="s2">&quot;bodies&quot;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">what</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalDict.cardWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LocalDict.cardWhat">[docs]</a>    <span class="k">def</span> <span class="nf">cardWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cards</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Card </span><span class="si">%s</span><span class="s2"> do not exist&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c1"># return card.numWhat(what)</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No card </span><span class="si">%s</span><span class="s2"> with sdum=</span><span class="si">%s</span><span class="s2"> found</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># return cards[name].numWhat(what)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>

        <span class="c1"># return a float or int otherwise as is</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">val</span></div></div>


<div class="viewcode-block" id="utfWrite"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.utfWrite">[docs]</a><span class="k">def</span> <span class="nf">utfWrite</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write in utf format if necessary&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="utfWriteln"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.utfWriteln">[docs]</a><span class="k">def</span> <span class="nf">utfWriteln</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeln"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.writeln">[docs]</a><span class="k">def</span> <span class="nf">writeln</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="utfReadline"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.utfReadline">[docs]</a><span class="k">def</span> <span class="nf">utfReadline</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Readline and convert it to unicode if necessary&quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># sline = str(uline) # TODO never used ?</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">uline</span></div>


<div class="viewcode-block" id="isEvalStr"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.isEvalStr">[docs]</a><span class="k">def</span> <span class="nf">isEvalStr</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return is the what string is an evaluated function&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LowNeutMaterial"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LowNeutMaterial">[docs]</a><span class="k">class</span> <span class="nc">LowNeutMaterial</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Structures as placeholders&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="CardInfo"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo">[docs]</a><span class="k">class</span> <span class="nc">CardInfo</span><span class="p">:</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Card information dictionary</span>
    <span class="n">_funcs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Caching compiled functions</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">assert_</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">meaning</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">range_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span> <span class="o">=</span> <span class="n">assert_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">extra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meaning</span> <span class="o">=</span> <span class="n">meaning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="mi">99999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disableComment</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Comment disabled cards instead</span>
        <span class="c1"># of #if 0..#endif</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">underline</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># process range for units, particles, materials and regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rangeCode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">range_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">nwhats</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rangeCode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compileConditions</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">w</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">nwhats</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nwhats</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span> <span class="o">=</span> <span class="n">nwhats</span>

        <span class="c1"># compile assertion code</span>
        <span class="k">for</span> <span class="n">assertList</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">:</span>
            <span class="n">ass</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assertList</span><span class="p">:</span>
                <span class="n">ass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compileAssert</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertCode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ass</span><span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="CardInfo.setDisableComment"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.setDisableComment">[docs]</a>    <span class="k">def</span> <span class="nf">setDisableComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disableComment</span> <span class="o">=</span> <span class="n">c</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Compile conditions</span>
    <span class="c1"># The code which is generated is in the form i.e.:</span>
    <span class="c1"># lambda x: x&gt;0</span>
    <span class="c1"># and should be executed with:</span>
    <span class="c1"># eval(code)(x)</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="CardInfo.compileConditions"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.compileConditions">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compileConditions</span><span class="p">(</span><span class="n">rng</span><span class="p">):</span>
        <span class="c1"># the switch condition is given by the f() fields and</span>
        <span class="c1"># by the sdum if is defined</span>

        <span class="c1"># Check sdums</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">sdums</span> <span class="o">=</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sdums</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">maxlen</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;lambda x:x==</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_compileFunc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;lambda x:x[:8] in (&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sdums</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_compileFunc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

        <span class="c1"># Check if all [fri]() conditions are met</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">rng</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;lambda x:</span><span class="si">%s</span><span class="s2">&quot;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; or &#39;</span><span class="p">))</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_compileFunc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;lambda x:len(str(x))&lt;=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_compileFunc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">code</span></div>

<div class="viewcode-block" id="CardInfo.compileAssert"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.compileAssert">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compileAssert</span><span class="p">(</span><span class="n">assertStatement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compile assert statement</span>
<span class="sd">        First detect all what references w(#) and replace them with:</span>
<span class="sd">            w(#) -&gt; c.numWhat(#)</span>
<span class="sd">            W(#) -&gt; c.what(#)</span>
<span class="sd">        identify all what-indexes to report as problems</span>
<span class="sd">        and request in the code that are not zero!</span>

<span class="sd">        finally compile the code</span>
<span class="sd">        example: w(8)&gt;w(7)</span>
<span class="sd">            lambda c: c.numWhat(7)==0 or c.numWhat(8)==0 or c.numWhat(8)&gt;c.numWhat(7)</span>
<span class="sd">        :param assertStatement:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">whatUsed</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">21</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">_WNPAT</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">assertStatement</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">whatUsed</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">ass</span> <span class="o">=</span> <span class="n">_wPAT</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;c.numWhat(&#39;</span><span class="p">,</span> <span class="n">assertStatement</span><span class="p">)</span>
        <span class="n">ass</span> <span class="o">=</span> <span class="n">_WPAT</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;c.what(&#39;</span><span class="p">,</span> <span class="n">ass</span><span class="p">)</span>

        <span class="n">whats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;lambda c:&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">whatUsed</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="n">whats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">expr</span> <span class="o">+=</span> <span class="s2">&quot;c.what(</span><span class="si">%d</span><span class="s2">)==&#39;&#39; or &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">whats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expr</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">ass</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">whats</span><span class="p">,</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_compileFunc</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compileFunc</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compile or use pre-defined function&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">)</span>
            <span class="n">CardInfo</span><span class="o">.</span><span class="n">_funcs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">return</span> <span class="n">c</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compileFuncName</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return name of compiled function (used for debugging)&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>

<div class="viewcode-block" id="CardInfo.findCase"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.findCase">[docs]</a>    <span class="k">def</span> <span class="nf">findCase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find card&#39;s range(case)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rangeCode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rangeCode</span><span class="p">):</span>
            <span class="c1"># Check all &#39;f&#39;-flags</span>
            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span> <span class="ow">and</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">eval</span><span class="p">(</span><span class="n">c</span><span class="p">)(</span><span class="n">v</span><span class="p">):</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># All conditions met</span>
                <span class="k">return</span> <span class="n">r</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># return default case</span></div>

<div class="viewcode-block" id="CardInfo.validate"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate card: return a list of failing variables.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Error card&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findCase</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># No case found!</span>

        <span class="c1"># FIXME check special cases</span>
        <span class="c1"># 1. Regions check body names inside</span>
        <span class="c1"># 2. All references of names if they exist mi, ri, bi, di, vi, ti</span>
        <span class="c1"># 3. Check step for ranges to be &gt;= 0</span>
        <span class="c1"># 4. Check limits in USRxxx cards</span>
        <span class="c1"># 5. Check logical units usage</span>
        <span class="c1"># 6. Check duplicate name definition of bodies, regions...</span>

        <span class="c1"># Check all fields</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rangeCode</span><span class="p">[</span><span class="n">case</span><span class="p">]:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Use default</span>

            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
                        <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">xi</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># x = 0</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xi</span> <span class="o">=</span> <span class="n">long</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">xi</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
                        <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">xi</span>
                    <span class="c1"># Special patch for RADDECAY to restore</span>
                    <span class="c1"># the long type instead of float</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># x = 0</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Check if it is a fortran number with D or internal spaces</span>
                    <span class="c1"># try: x = float(re.sub(&quot;[dD]&quot;,&quot;e&quot;,x.replace(&quot; &quot;,&quot;&quot;)))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[dD]&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                        <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="s2">&quot;spi&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
                        <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
                            <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="c1"># FIXME ri, mi, bi, di, vi</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">eval</span><span class="p">(</span><span class="n">c</span><span class="p">)(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="c1"># Check all assert statements</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">whats</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assertCode</span><span class="p">[</span><span class="n">case</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">whats</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">)(</span><span class="n">card</span><span class="p">):</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">whats</span><span class="p">)</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Assertion failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">[</span><span class="n">case</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># Special check for regions</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
            <span class="n">sdum</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sdum</span> <span class="o">!=</span> <span class="s2">&quot;&amp;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_NAMEPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sdum</span><span class="p">):</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">csg</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">extra</span><span class="p">())</span>
            <span class="c1"># Check expression</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">csg</span><span class="o">.</span><span class="n">exp2rpn</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">csg</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid expression&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bodies</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="s2">&quot;bodies&quot;</span><span class="p">)</span>
                    <span class="n">notadded</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">_NAMEPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                            <span class="c1"># XXX Check in body list</span>
                            <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">notadded</span><span class="p">:</span>
                                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">notadded</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid body </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">notadded</span><span class="p">:</span>
                                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">notadded</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid token </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">csg</span><span class="o">.</span><span class="n">CSGException</span><span class="p">:</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Unbalanced parenthesis&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">isGeo</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_NAMEPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()):</span>
                <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;COMPOUND&quot;</span><span class="p">:</span>
            <span class="c1"># Check for nesting compounds</span>
            <span class="c1"># XXX for them moment on level checking</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">():</span>
                    <span class="n">pb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pb</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># convert to names</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="CardInfo.toNames"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.toNames">[docs]</a>    <span class="k">def</span> <span class="nf">toNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findCase</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="n">case</span><span class="p">]</span>

        <span class="c1"># Special cases</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;LATTICE&quot;</span><span class="p">:</span>
            <span class="c1"># Check the sdum and convert it to something that flair</span>
            <span class="c1"># and FREE format of FLUKA likes</span>
            <span class="n">sdum</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sdum</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ROT#&quot;</span> <span class="ow">or</span> <span class="n">sdum</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;RO#&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sdum</span><span class="p">[</span><span class="n">sdum</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="mi">999</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setSdum</span><span class="p">(</span><span class="s2">&quot;rot#</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">))</span>

        <span class="c1"># Go through the various whats</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_</span><span class="p">))):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">range_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mi&quot;</span><span class="p">,</span> <span class="s2">&quot;smi&quot;</span><span class="p">):</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">aw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># FIXME to correct treatment of defines...</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">materialList</span><span class="p">()</span>
                <span class="n">aw</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">aw</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;@LASTMAT&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lst</span><span class="p">[</span><span class="n">aw</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ri&quot;</span><span class="p">,</span> <span class="s2">&quot;sri&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;ri&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;@ALLREGS&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">aw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="n">aw</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">aw</span><span class="p">)</span>

                <span class="c1"># FIXME to correct treatment of defines...</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">regions</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">)</span>
                    <span class="n">aw</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="c1"># Normally should not enter here unless if the voxel is not found</span>
                    <span class="k">if</span> <span class="n">aw</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s2">&quot;VOXELS&quot;</span> <span class="ow">in</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span>
                            <span class="c1"># FIXME no way to know about @LASTREG!</span>
                            <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
                                <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;VOXEL&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">aw</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                                    <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;VOXEL</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aw</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)))</span>
                                <span class="k">elif</span> <span class="p">(</span><span class="n">aw</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
                                    <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;VOXE</span><span class="si">%04d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aw</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;VOX</span><span class="si">%05d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aw</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;@LASTREG&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">regions</span><span class="p">[</span><span class="n">aw</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">elif</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="s2">&quot;spi&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;RAY&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;spi&quot;</span><span class="p">:</span>
                    <span class="c1"># Special treatment for DISCARD and negative particle id&#39;s</span>
                    <span class="k">if</span> <span class="n">aw</span> <span class="o">&gt;</span> <span class="mi">980</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">aw</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">setSign</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">aw</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="mi">1000</span> <span class="o">-</span> <span class="n">aw</span><span class="p">)</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">aw</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">setAbsWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">aw</span><span class="p">),</span> <span class="kc">True</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">aw</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;di&quot;</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">aw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Type of detector in sdum</span>
                <span class="n">detectors</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">detectors</span><span class="p">:</span>
                    <span class="n">aw</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aw</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">aw</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">detectors</span><span class="p">[</span><span class="n">aw</span><span class="p">]</span>
                        <span class="c1"># Ensure that there is only one reference</span>
                        <span class="k">if</span> <span class="n">detectors</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">aw</span><span class="p">:</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;bi&quot;</span><span class="p">:</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">aw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">aw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># FIXME detectors EVENTBIN &amp; USRBIN</span>
                <span class="n">detectors</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="s2">&quot;USRBIN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">detectors</span><span class="p">:</span>
                    <span class="n">aw</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aw</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">aw</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">detectors</span><span class="p">[</span><span class="n">aw</span><span class="p">]</span>
                        <span class="c1"># Ensure that there is only one reference</span>
                        <span class="k">if</span> <span class="n">detectors</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">aw</span><span class="p">:</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="CardInfo.find"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find</span>
<span class="sd">        :param target:</span>
<span class="sd">        :param case:</span>
<span class="sd">        :return: list  - of references, tuple - for a range</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">starget</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="o">+</span> <span class="n">target</span>

        <span class="c1"># Go through the various whats</span>
        <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">found</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="n">case</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">range_</span><span class="p">)):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">range_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">starget</span><span class="p">):</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">found</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># get card information</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="CardInfo.get"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.get">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">card</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">Card</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">card</span> <span class="ow">and</span> <span class="n">card</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">):</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="CardInfo.none"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.CardInfo.none">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">none</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span></div></div>


<span class="c1"># ===============================================================================</span>
<span class="c1"># Logical Units</span>
<span class="c1"># ===============================================================================</span>
<div class="viewcode-block" id="LogicalUnits"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits">[docs]</a><span class="k">class</span> <span class="nc">LogicalUnits</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Reset to default units</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="LogicalUnits.reset"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Add some default units:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;RANDOMIZ&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># stdin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;LOW-NEUT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;EMFFLUO&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;DETECT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;DPMJET&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>
        <span class="c1"># self.list[49] = (True,  &quot;USERDUMP&quot;,	None)</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Assign a new unit type</span>
    <span class="c1"># ----------------------------------------------------------------------</span>

<div class="viewcode-block" id="LogicalUnits.assign"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign a new unit to tag&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>

<div class="viewcode-block" id="LogicalUnits.clear"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear a unit from list&quot;&quot;&quot;</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return unit type</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="LogicalUnits.get"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return unit information&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Find first free</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="LogicalUnits.free"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.free">[docs]</a>    <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return first free unit&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span></div>

    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="c1"># FIXME needs optimisation, we should find all cards using units in the</span>
    <span class="c1"># CardInfo and search only those cards</span>
    <span class="c1"># -----------------------------------------------------------------------</span>
<div class="viewcode-block" id="LogicalUnits.scan"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.scan">[docs]</a>    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">card</span><span class="o">.</span><span class="n">units</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

                <span class="c1"># check for a possible conflict!</span>
                <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">=</span> <span class="n">unit</span>

                    <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b</span> <span class="o">^</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)):</span>
                        <span class="c1"># Find what with units</span>
                        <span class="n">case</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">case</span><span class="p">()</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;lu&quot;</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Possible conflict with unit: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;is used by: </span><span class="si">%s</span><span class="s2">  #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">u</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                        <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

        <span class="c1"># For all open cards assign the correct name</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">[</span><span class="s2">&quot;OPEN&quot;</span><span class="p">]:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">extra</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="o">.</span><span class="n">extra</span><span class="p">())</span></div>

<div class="viewcode-block" id="LogicalUnits.filterList"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.LogicalUnits.filterList">[docs]</a>    <span class="k">def</span> <span class="nf">filterList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">bin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all units, filtered for a card&quot;&quot;&quot;</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">card</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">card</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">bin</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2"> ASC&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2"> BIN&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">-</span><span class="n">i</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lst</span></div></div>


<span class="c1"># ===============================================================================</span>
<span class="c1"># Particle class</span>
<span class="c1"># ===============================================================================</span>
<div class="viewcode-block" id="Particle"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Particle">[docs]</a><span class="k">class</span> <span class="nc">Particle</span><span class="p">:</span>
    <span class="c1"># Particles dictionary</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">beam</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">listAll</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">signedList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">signedListAll</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">particles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdg</span> <span class="o">=</span> <span class="n">pdg</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># add particle</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Particle.add"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Particle.add">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">pdg</span><span class="p">)</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

        <span class="c1"># Populate also _baseLocalDict</span>
        <span class="k">if</span> <span class="n">mass</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;n&quot;</span>
            <span class="k">elif</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">_globalDict</span><span class="p">[</span><span class="s2">&quot;m</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="k">return</span> <span class="n">p</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Particle</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Particle.get"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Particle.get">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># create lists</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Particle.makeLists"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Particle.makeLists">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">makeLists</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">lastpar</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;@LASTPAR&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># All particles</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">listAll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s2">&quot;@LASTPAR&quot;</span><span class="p">:</span>
                    <span class="n">Particle</span><span class="o">.</span><span class="n">listAll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">lastpar</span><span class="p">:</span>
                    <span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Beam particles</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="p">[:]</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ISOTOPE&quot;</span><span class="p">)</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># Only real particles + generalized ones</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">228</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">222</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">Particle</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Sort</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;@LASTPAR&quot;</span><span class="p">)</span>

        <span class="n">Particle</span><span class="o">.</span><span class="n">listAll</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">listAll</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;@LASTPAR&quot;</span><span class="p">)</span>

        <span class="n">Particle</span><span class="o">.</span><span class="n">particles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># Create signed list</span>
        <span class="n">Particle</span><span class="o">.</span><span class="n">signedList</span> <span class="o">+=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">list</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Particle</span><span class="o">.</span><span class="n">signedList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">signedList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
                <span class="n">Particle</span><span class="o">.</span><span class="n">signedList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span>

        <span class="n">Particle</span><span class="o">.</span><span class="n">signedListAll</span> <span class="o">+=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">listAll</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Particle</span><span class="o">.</span><span class="n">signedListAll</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">signedListAll</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
                <span class="n">Particle</span><span class="o">.</span><span class="n">signedListAll</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Convert to integer or string</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Particle.convert"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Particle.convert">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">tonames</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert particle from name to number</span>
<span class="sd">        particle type</span>
<span class="sd">        :param tonames: True/False</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
            <span class="n">isInt</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">isInt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isInt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">tonames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isInt</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Particle </span><span class="si">%s</span><span class="s2"> not found!&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
                    <span class="k">return</span> <span class="s2">&quot;UNKNOWN&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isInt</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">idx</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Particle</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Particle </span><span class="si">%s</span><span class="s2"> not found!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">))</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># scan input for particles</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Particle.scan"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Particle.scan">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
        <span class="c1"># FIXME for the moment return everything</span>
        <span class="k">return</span> <span class="n">Particle</span><span class="o">.</span><span class="n">listAll</span></div></div>


<div class="viewcode-block" id="Voxel"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Voxel">[docs]</a><span class="k">class</span> <span class="nc">Voxel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Voxel class</span>
<span class="sd">        parse the voxel file and create fake cards for the</span>
<span class="sd">            materials, assignmats and corrfact</span>
<span class="sd">        that might be embedded in the voxel file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Clean up voxel structure</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Voxel.cleanup"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Voxel.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kreg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roiN</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roiName</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># roi structure names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roiColor</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># colors of rois</span>
        <span class="c1"># self.roiComb = {}	# roi dictionary of combination of structures</span>
        <span class="c1"># self.roiData = None	# roi structure data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">()</span>  <span class="c1"># Input cards embedded in voxel file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_VOXEL</span>  <span class="c1"># Mark as voxel</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Read voxel information</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Voxel.read"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Voxel.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Title CHAR*80</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid voxel file. No title found&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Memory Size nx,ny,nz,no,mo</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">36</span><span class="p">):</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid voxel file. Wrong memory size&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> \
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=5i&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roiN</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">roiPlanar</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roiN</span><span class="p">,</span> <span class="n">roiCombN</span><span class="p">,</span> <span class="n">roiMaxLen</span><span class="p">,</span> <span class="n">roiPlanar</span> <span class="o">=</span> \
                <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=9i&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

        <span class="c1"># Create voxel regions</span>
        <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;VOXEL&quot;</span><span class="p">])</span>
        <span class="c1"># card[&quot;@id&quot;] = 0</span>
        <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGION_VOXEL</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setExtra</span><span class="p">(</span><span class="s2">&quot;+VOXEL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># +1 to include organ 0</span>
            <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">Voxel</span><span class="o">.</span><span class="n">regionName</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
            <span class="c1"># card[&quot;@id&quot;] = i+1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGION_VOXEL</span>

        <span class="c1"># Voxel dimension</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid voxel file. Wrong dimensions&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=3d&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>

        <span class="c1"># Voxel data (skip)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid voxel file. Data size do not match&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># kreg</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid voxel file. Wrong kreg array&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kreg</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=</span><span class="si">%d</span><span class="s2">H&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">record</span><span class="p">)</span>

        <span class="c1"># roiStruct</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">roiN</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># structures</span>
            <span class="c1"># try:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roiN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">color</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=i64s&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">roiColor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">roiName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="c1"># for the moment skip everything</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roiCombN</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># skip index</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># skip data</span>

            <span class="c1"># Read planar structures</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roiPlanar</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># skip index</span>
                <span class="n">roi</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;=ii&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># skip data</span>

        <span class="c1"># Read embedded cards</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">fortran</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid voxel file. Wrong card found &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">record</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">record</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">sdum</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">sdum</span><span class="p">,</span>  <span class="c1"># sdum</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>  <span class="c1"># what(1)</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>  <span class="c1"># what(2)</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>  <span class="c1"># what(3)</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">40</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>  <span class="c1"># what(4)</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>  <span class="c1"># what(5)</span>
                    <span class="n">record</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">70</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>  <span class="c1"># what(6)</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;COMPOUND&quot;</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">tag</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="n">sdum</span><span class="p">:</span>
                <span class="c1"># append whats to previous card</span>
                <span class="n">card</span><span class="o">.</span><span class="n">appendWhats</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if COMPOUND check for existing to append</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Voxel</span><span class="se">\n</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;File:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;Title:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;nxyz:</span><span class="se">\t</span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;no,mo:</span><span class="se">\t</span><span class="si">%d</span><span class="se">\t</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> \
               <span class="s2">&quot;dxyz:</span><span class="se">\t</span><span class="si">%g</span><span class="s2"> x </span><span class="si">%g</span><span class="s2"> </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> \
               <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nz</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">)</span>

<div class="viewcode-block" id="Voxel.regionName"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Voxel.regionName">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">regionName</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a valid region name&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;VOXEL&quot;</span>
        <span class="n">num</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;VOXEL&quot;</span> <span class="p">[:(</span><span class="mi">8</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">))],</span> <span class="n">num</span><span class="p">)</span></div></div>


<span class="c1"># ===============================================================================</span>
<span class="c1"># Card</span>
<span class="c1"># ===============================================================================</span>
<div class="viewcode-block" id="Card"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card">[docs]</a><span class="k">class</span> <span class="nc">Card</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for a fluka card&quot;&quot;&quot;</span>

    <span class="n">GENERIC</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># card types</span>
    <span class="n">BODY</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">REGION</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">OBJECT</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise a fluka card</span>
<span class="sd">        Each card contains a tag, whats, one multi-line comment and sometimes some extra information</span>
<span class="sd">        sdum=what[0] continuation cards have multiple whats of 1+6*lines.</span>
<span class="sd">        extra is used for TITLE, GEOBEGIN and REGION</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">what</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Enable or Disabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Preprocessor activate/deactivate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Valid or invalid card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># User properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># input class holding card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>  <span class="c1"># card tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_what</span> <span class="o">=</span> <span class="n">what</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">extra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># if -1 the card is most probably deleted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># preprocessor indent level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">GENERIC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setComment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="Card.setModified"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setModified">[docs]</a>    <span class="k">def</span> <span class="nf">setModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set last time modified&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modified</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Change tag of card, reduce the number of whats to the new card</span>
    <span class="c1"># XXX Do not forget to update the Input.cards... before</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.changeTag"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.changeTag">[docs]</a>    <span class="k">def</span> <span class="nf">changeTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;change tag of card&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="c1"># find card information from _cardInfo dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ERROR</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incompatible tag </span><span class="se">\&quot;</span><span class="si">{:s}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="s2">&quot;Geometry&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geo</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="s2">&quot;LATTICE&quot;</span><span class="p">,</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span>  <span class="c1"># transform types</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">BODY_TAGS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">BODY</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">FLAIR_TAGS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">OBJECT</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">REGION</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">Card</span><span class="o">.</span><span class="n">GENERIC</span>

        <span class="c1"># Cut extra whats</span>
        <span class="k">if</span> <span class="n">truncate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">nwhats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNWhats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">nwhats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Card.clone"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;clone card object&quot;&quot;&quot;</span>
        <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="p">)</span>
        <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span>
        <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Swallow copy</span>
        <span class="k">return</span> <span class="n">card</span></div>

<div class="viewcode-block" id="Card.copyProperties"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.copyProperties">[docs]</a>    <span class="k">def</span> <span class="nf">copyProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy properties from card&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Swallow copy</span></div>

<div class="viewcode-block" id="Card.appendWhats"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.appendWhats">[docs]</a>    <span class="k">def</span> <span class="nf">appendWhats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;append what&#39;s&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Card.appendComment"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.appendComment">[docs]</a>    <span class="k">def</span> <span class="nf">appendComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;append comment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setComment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setComment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">comment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Card.test"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test card against a filter-function</span>
<span class="sd">        Filter format  type [function] \n what \n value</span>
<span class="sd">        func: [type][function]</span>
<span class="sd">            type:	i=int</span>
<span class="sd">                f=float</span>
<span class="sd">                s=string</span>
<span class="sd">            function:</span>
<span class="sd">                a=abs</span>
<span class="sd">        var:</span>
<span class="sd">            0..9 = whats</span>
<span class="sd">                *  = anywhere</span>
<span class="sd">              b  = body</span>
<span class="sd">              d  = detector</span>
<span class="sd">              s  = sdum</span>
<span class="sd">                m  = material</span>
<span class="sd">                p  = particle	(range if tuple)</span>
<span class="sd">                r  = region		(range if tuple)</span>
<span class="sd">              t  = transformation</span>
<span class="sd">                u  = unit</span>
<span class="sd">        :param func:</span>
<span class="sd">        :param var:</span>
<span class="sd">        :param val: anything int, float or string</span>
<span class="sd">        :param case: True for matching case</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Search everywhere</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Units</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
            <span class="n">uval</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">uval</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Particle</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;pi&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varlist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># FIXME check for signed...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                    <span class="n">varlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">varlist</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">varlist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">part_from</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">part_from</span> <span class="o">==</span> <span class="n">part</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">part_to</span> <span class="o">=</span> <span class="n">Particle</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">part_to</span> <span class="o">==</span> <span class="n">part</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">part_step</span> <span class="o">=</span> <span class="n">varlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">part_from</span> <span class="o">&lt;</span> <span class="n">part</span> <span class="o">&lt;</span> <span class="n">part_to</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">part</span> <span class="o">-</span> <span class="n">part_from</span><span class="p">)</span> <span class="o">%</span> <span class="n">part_step</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Region</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;ri&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varlist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># FIXME check for signed...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                    <span class="n">varlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">varlist</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">varlist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check for a range</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">reg_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reg_from</span> <span class="o">==</span> <span class="n">reg</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">reg_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">region</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reg_to</span> <span class="o">==</span> <span class="n">reg</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">reg_step</span> <span class="o">=</span> <span class="n">varlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">reg_from</span> <span class="o">&lt;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="n">reg_to</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">reg_from</span><span class="p">)</span> <span class="o">%</span> <span class="n">reg_step</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Material</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;MATERIAL&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;mi&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varlist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># FIXME check for signed...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                    <span class="n">varlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">varlist</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">varlist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">mat_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mat_from</span> <span class="o">==</span> <span class="n">mat</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">mat_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">material</span><span class="p">(</span><span class="n">varlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mat_to</span> <span class="o">==</span> <span class="n">mat</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="n">mat_step</span> <span class="o">=</span> <span class="n">varlist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mat_from</span> <span class="o">&lt;</span> <span class="n">mat</span> <span class="o">&lt;</span> <span class="n">mat_to</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">((</span><span class="n">mat</span> <span class="o">-</span> <span class="n">mat_from</span><span class="p">)</span> <span class="o">%</span> <span class="n">mat_step</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Transformation</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="c1"># FIXME check also what(1) and Rot#\d+</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ROT-DEFI&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;ti&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                <span class="n">varlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">varlist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># Check also -val</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">if</span> <span class="o">-</span><span class="n">val</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Detector</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">DETECTOR_TAGS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span>

            <span class="c1"># FIXME ranges are not supported yet!</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;di&quot;</span><span class="p">))</span>
            <span class="n">varlist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">findType</span><span class="p">(</span><span class="s2">&quot;bi&quot;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                <span class="n">varlist</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">varlist</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">varlist</span>

        <span class="c1"># Body</span>
        <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">|=</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span>
                <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*\b</span><span class="si">%s</span><span class="s2">\b.*&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span>

        <span class="c1"># if var is None: return False</span>
        <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;ia&quot;</span><span class="p">:</span>  <span class="c1"># Absolute integer</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>  <span class="c1"># Floating point</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span>  <span class="c1"># Long integer</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">longWhat</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="n">long</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>  <span class="c1"># Integer</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;sa&#39;</span><span class="p">:</span>  <span class="c1"># Absolute string (remove the minus &#39;-&#39;)</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">w</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">var</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return card&#39;s cardInfo case (range)</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.case"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.case">[docs]</a>    <span class="k">def</span> <span class="nf">case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">findCase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Validate card values</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.validate"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># FIXME this check should be done in the invalid</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.clearUserInvalid"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.clearUserInvalid">[docs]</a>    <span class="k">def</span> <span class="nf">clearUserInvalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># FIXME this check should be done in the invalid</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.addUserInvalid"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.addUserInvalid">[docs]</a>    <span class="k">def</span> <span class="nf">addUserInvalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_userInvalid</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="c1"># Append to the invalid cards</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># @return error message string</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.errorMessage"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.errorMessage">[docs]</a>    <span class="k">def</span> <span class="nf">errorMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">()):</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">case</span><span class="p">()</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="n">case</span><span class="p">]</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="n">case</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">displayed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">displayed</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># skip multiple messages</span>
            <span class="n">displayed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">elif</span> <span class="n">lab</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;What=</span><span class="si">%d</span><span class="s2">  Label=</span><span class="si">%s</span><span class="s2">  Type=</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">range_</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">extra</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;What=</span><span class="si">%d</span><span class="s2">  Type=</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">range_</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">extra</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">msg</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Convert card to names or numbers</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.convert"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tonames</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tonames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">toNames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">toNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># I/O</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.whats"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.whats">[docs]</a>    <span class="k">def</span> <span class="nf">whats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span></div>

<div class="viewcode-block" id="Card.nwhats"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.nwhats">[docs]</a>    <span class="k">def</span> <span class="nf">nwhats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">)</span></div>

<div class="viewcode-block" id="Card.sdum"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.sdum">[docs]</a>    <span class="k">def</span> <span class="nf">sdum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Card.extra"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.extra">[docs]</a>    <span class="k">def</span> <span class="nf">extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span></div>

<div class="viewcode-block" id="Card.comment"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.comment">[docs]</a>    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span></div>

<div class="viewcode-block" id="Card.isGeo"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.isGeo">[docs]</a>    <span class="k">def</span> <span class="nf">isGeo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo</span></div>

<div class="viewcode-block" id="Card.type"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span></div>

<div class="viewcode-block" id="Card.pos"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.pos">[docs]</a>    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span></div>

<div class="viewcode-block" id="Card.indent"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.indent">[docs]</a>    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">)</span></div>

    <span class="n">name</span> <span class="o">=</span> <span class="n">sdum</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Compare position - key</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.cmpPos_key"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.cmpPos_key">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cmpPos_key</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">_pos</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return what value -1=extra, 0=sdum</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.what"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.what">[docs]</a>    <span class="k">def</span> <span class="nf">what</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return absolute value of what</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.absWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.absWhat">[docs]</a>    <span class="k">def</span> <span class="nf">absWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the absolute value of what[w]&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">n</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">n</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return what as integer</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.intWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.intWhat">[docs]</a>    <span class="k">def</span> <span class="nf">intWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;try to return an integer from what&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">n</span><span class="p">))</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return what as long integer</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.longWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.longWhat">[docs]</a>    <span class="k">def</span> <span class="nf">longWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;try to return a long integer from what&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">long</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">n</span><span class="p">))</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return what as floating point number</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.numWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.numWhat">[docs]</a>    <span class="k">def</span> <span class="nf">numWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;try to return a number from what&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Is evaluated what</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.isEvalWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.isEvalWhat">[docs]</a>    <span class="k">def</span> <span class="nf">isEvalWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">isEvalStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">))</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return evaluated what</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.evalWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.evalWhat">[docs]</a>    <span class="k">def</span> <span class="nf">evalWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dollar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return evaluated what if needed&quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">w</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">localDict</span><span class="o">.</span><span class="n">card</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">w</span>
                <span class="c1"># Check for possible vector definitions</span>
                <span class="c1"># replace any { to Vector( and } to )</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;Vector(&quot;</span><span class="p">)</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
                <span class="c1"># expr = expr.replace(&quot;[[&quot;,&quot;Matrix(&quot;)</span>
                <span class="c1"># expr = expr.replace(&quot;]]&quot;,&quot;)&quot;)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">_globalDict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">localDict</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR </span><span class="si">%s</span><span class="s2"> card </span><span class="si">%s</span><span class="s2"> what(</span><span class="si">%d</span><span class="s2">):</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="s2">&quot;?&quot;</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">f</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span>

            <span class="k">elif</span> <span class="n">dollar</span> <span class="ow">and</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c1"># check defines</span>
                <span class="n">defines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardsCache</span><span class="p">(</span><span class="s2">&quot;#define&quot;</span><span class="p">)</span>
                <span class="c1"># dummy linear search</span>
                <span class="k">for</span> <span class="n">define</span> <span class="ow">in</span> <span class="n">defines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">define</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">define</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="n">var</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">define</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># Convert to int or float if possible</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">f</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">w</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return evaluated what,</span>
    <span class="c1"># but NOT empty space (used on $xxx cards)</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.evalWhat0"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.evalWhat0">[docs]</a>    <span class="k">def</span> <span class="nf">evalWhat0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dollar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dollar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">w</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># get card information</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get card information&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sdum&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;extra&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="n">get</span> <span class="o">=</span> <span class="fm">__getitem__</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># set card state</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setEnable"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setEnable">[docs]</a>    <span class="k">def</span> <span class="nf">setEnable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set state enable(True)/disable(False)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Disable card</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.disable"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.disable">[docs]</a>    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;disable card&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set Active state</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setActive"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setActive">[docs]</a>    <span class="k">def</span> <span class="nf">setActive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set active state of card&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">a</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Ignore card if not active or not enabled</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.ignore"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.ignore">[docs]</a>    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.notIgnore"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.notIgnore">[docs]</a>    <span class="k">def</span> <span class="nf">notIgnore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># set comment</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setComment"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setComment">[docs]</a>    <span class="k">def</span> <span class="nf">setComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set comment string&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">comment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set the whats list</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setWhats"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setWhats">[docs]</a>    <span class="k">def</span> <span class="nf">setWhats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whats</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_what</span> <span class="o">=</span> <span class="n">whats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set SDUM to card (what[0])</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setSdum"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setSdum">[docs]</a>    <span class="k">def</span> <span class="nf">setSdum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set sdum&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>

    <span class="n">setName</span> <span class="o">=</span> <span class="n">setSdum</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set extra information to card</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setExtra"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setExtra">[docs]</a>    <span class="k">def</span> <span class="nf">setExtra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set extra information&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set a what value</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setWhat">[docs]</a>    <span class="k">def</span> <span class="nf">setWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set what value&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unicode characters are not accepted</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="c1"># Extend list if needed</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set the total number of whats</span>
    <span class="c1"># Usually to remove whats</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setNWhats"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setNWhats">[docs]</a>    <span class="k">def</span> <span class="nf">setNWhats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set the total number of whats&quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_what</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Set absolute information to card. The &quot;what&quot; will keep the same sign</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setAbsWhat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setAbsWhat">[docs]</a>    <span class="k">def</span> <span class="nf">setAbsWhat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;change the absolute value of what keeping the same sign&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isEvalStr</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Signs are used to avoid cases when the what[w] is ZERO</span>
    <span class="c1"># Should not be used by the user... only in Layout.py</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setSign"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setSign">[docs]</a>    <span class="k">def</span> <span class="nf">setSign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">isEvalStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># return sign of a what</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.sign"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.sign">[docs]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return sign of a number: False=+, True=-&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isEvalStr</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="c1"># special case</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Default numeric value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">s</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">s</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># set information to card</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set value to what(#, sdum, comment, extra)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;sdum&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setSdum</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setComment</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;extra&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setExtra</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="nb">set</span> <span class="o">=</span> <span class="fm">__setitem__</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># set/get user property</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.setProperty"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setProperty">[docs]</a>    <span class="k">def</span> <span class="nf">setProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.getProperty"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.getProperty">[docs]</a>    <span class="k">def</span> <span class="nf">getProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return a specific type from the card, see database from more info</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.findType"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.findType">[docs]</a>    <span class="k">def</span> <span class="nf">findType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return whats with a specific type from the card, pi, mi, ...&quot;&quot;&quot;</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">findCase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lst</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Return units used by card</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.units"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.units">[docs]</a>    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return unit from card&quot;&quot;&quot;</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">findCase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;lu&quot;</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">absolute</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">lst</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>

<div class="viewcode-block" id="Card.commentStr"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.commentStr">[docs]</a>    <span class="k">def</span> <span class="nf">commentStr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a comment string&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cur_line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cur_line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cur_line</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;*</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;*</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">line</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># return bodies in single/double/free format</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_bodyStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&lt;name&gt;&quot;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2"> </span><span class="si">%-10s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">prevlen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">nwhats</span><span class="p">:</span>
                <span class="c1"># use what to keep it as string</span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># num = float(w)  # Force to number TODO not used ?</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;0.0&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">prevlen</span> <span class="o">+</span> <span class="mi">80</span><span class="p">:</span>
                    <span class="n">prevlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">              </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">w</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">line</span>

        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_SINGLE</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">21</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">  </span><span class="si">%3s%5s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">):</span>
            <span class="n">inext</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">step</span>
            <span class="n">imin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">inext</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">imin</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># num = float(w) # TODO not used ?</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="s2">&quot;0.0&quot;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">w</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">          &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># return end string</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_endStr</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;END&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;  END&quot;</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Split a region expression into multi lines</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.splitExpr"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.splitExpr">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">splitExpr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">maxlength</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">cur_line</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>  <span class="c1"># remove trailing spaces</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlength</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxlength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cur_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c1"># split line on char before</span>
                    <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="n">cur_line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">cur_line</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">line</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># return region string</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_regionStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&lt;name&gt;&quot;</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span>  <span class="c1"># Continuation of a region</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;              &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%-10s%4d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">)</span>

            <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">cur_line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>  <span class="c1"># remove trailing spaces</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cur_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="c1"># split line on char before</span>
                        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="n">cur_line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">               </span><span class="si">%s</span><span class="s2">&quot;</span> \
                                    <span class="o">%</span> <span class="p">(</span><span class="n">cur_line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">cur_line</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">               </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_line</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;No parenthesis are allowed in fixed format&quot;</span><span class="p">)</span>

            <span class="n">nop</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">cur_line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="c1"># Remove spaces</span>
                <span class="n">cur_line</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cur_line</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot; +&quot;</span><span class="p">)</span>
                <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; -&quot;</span><span class="p">)</span>
                <span class="n">cur_line</span> <span class="o">=</span> <span class="n">cur_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot; | &quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">nop</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">expr</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">          &quot;</span>
                    <span class="n">nop</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">orbefore</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">cur_line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
                        <span class="n">expr</span> <span class="o">+=</span> <span class="s2">&quot;OR&quot;</span>
                        <span class="n">orbefore</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">orbefore</span><span class="p">:</span>
                            <span class="n">expr</span> <span class="o">+=</span> <span class="s2">&quot;  &quot;</span>
                        <span class="n">orbefore</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sop</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">sop</span> <span class="o">=</span> <span class="n">sop</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">expr</span> <span class="o">+=</span> <span class="n">sop</span>
                    <span class="n">nop</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">nop</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                        <span class="n">expr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">          &quot;</span>
                        <span class="n">nop</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%5s%5d%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_toStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a card string&quot;&quot;&quot;</span>

        <span class="c1"># special cards</span>
        <span class="n">ctag</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">ctag</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                               <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span><span class="p">())]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ctag</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">ctag</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                               <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span><span class="p">())]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ctag</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endStr</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="n">Card</span><span class="o">.</span><span class="n">BODY</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bodyStr</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="n">Card</span><span class="o">.</span><span class="n">REGION</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regionStr</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">22</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c1"># Number of whats</span>
        <span class="n">nwhats</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PLOTGEOM&quot;</span><span class="p">:</span>
            <span class="c1"># Another card with special treatment</span>
            <span class="n">nwhats</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">nwhats</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
            <span class="c1"># Count real whats</span>
            <span class="k">while</span> <span class="n">nwhats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">nwhats</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">nwhats</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="c1"># Add whats in blocks of 6</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">ctag</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%-10s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># Cards with no whats</span>
        <span class="k">if</span> <span class="n">nwhats</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">ctag</span>
            <span class="k">if</span> <span class="n">nwhats</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; , &quot;</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="mi">6</span><span class="p">))</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Cards with many whats</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;COMPOUND&quot;</span><span class="p">:</span>
                <span class="n">cont_sdum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cont_sdum</span> <span class="o">=</span> <span class="s2">&quot; &amp;&quot;</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nwhats</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">ctag</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span>

                <span class="n">inext</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span>
                <span class="n">imin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">inext</span><span class="p">,</span> <span class="n">nwhats</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">imin</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">long</span><span class="p">):</span>  <span class="c1"># for RADDECAY</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># num = float(w) # TODO not used ?</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="n">w</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Check for continuation lines and sdum</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">sdum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">sdum</span> <span class="o">=</span> <span class="n">cont_sdum</span>
                    <span class="k">if</span> <span class="n">sdum</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span>
                        <span class="n">cont_sdum</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Do we need to pad with the line</span>
                <span class="k">if</span> <span class="n">sdum</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inext</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; ,&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">inext</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">inext</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">sdum</span>
                <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                    <span class="c1"># Chop the last comma</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

        <span class="c1"># XXX Double format doesn&#39;t exist for GEOBEGIN</span>
        <span class="c1"># simply triggers the writing of the header inline the input</span>
        <span class="c1"># or in an external file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="s2">&quot;!mesh&quot;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idbg</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idbg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idbg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%5d%5d</span><span class="s2">          </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idbg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PLOTGEOM&quot;</span><span class="p">:</span>
            <span class="n">w6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w6</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%10s%10s%10s%10s%10s%10s</span><span class="s2">&quot;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%10s%10s%10s%10s%10s%10s</span><span class="s2">&quot;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%10s%10s%10s%10s</span><span class="s2">&quot;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
                           <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">line</span>

    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="c1"># return string with only the cards</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.toStr"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.toStr">[docs]</a>    <span class="k">def</span> <span class="nf">toStr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">disableComment</span> <span class="ow">and</span> <span class="n">commentedCards</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toStr</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="c1"># if not self.enable and self.info.disableComment: s = &quot;*&quot;+s</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.evalWhatStr"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.evalWhatStr">[docs]</a>    <span class="k">def</span> <span class="nf">evalWhatStr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return string for special evaluated whats&quot;&quot;&quot;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">isEvalStr</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                <span class="n">es</span> <span class="o">+=</span> <span class="s2">&quot;!@what.</span><span class="si">%d%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;@&#39;</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>  <span class="c1"># skip system values</span>
                    <span class="n">es</span> <span class="o">+=</span> <span class="s2">&quot;!@</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">es</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Convert to string using default format</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a card string with the comment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commentStr</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">toStr</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toStr</span><span class="p">()</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Dump card to pickler</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.dump"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickler</span><span class="p">):</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_what</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">:</span>  <span class="c1"># Skip system variables</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="p">(</span><span class="n">IntType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">BooleanType</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">UnicodeType</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Load card from unpickler</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.load"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unpickler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_what</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">prop</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prop</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>

<div class="viewcode-block" id="Card.diff"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.diff">[docs]</a>    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return differences of the two cards as a list of integers</span>
<span class="sd">        -3 = enable/disable</span>
<span class="sd">        -2 = Comment</span>
<span class="sd">        -1 = Extra</span>
<span class="sd">        0 = Sdum</span>
<span class="sd">        1..n = What&#39;s</span>
<span class="sd">        :param card:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">!=</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commentStr</span><span class="p">()</span> <span class="o">!=</span> <span class="n">card</span><span class="o">.</span><span class="n">commentStr</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">!=</span> <span class="n">card</span><span class="o">.</span><span class="n">_extra</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">minwhats</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span><span class="p">(),</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">())</span>
        <span class="n">maxwhats</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwhats</span><span class="p">(),</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">minwhats</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">!=</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minwhats</span> <span class="o">!=</span> <span class="n">maxwhats</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">minwhats</span><span class="p">,</span> <span class="n">maxwhats</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Special body method returning various geometrical information</span>
    <span class="c1"># ... if they are defined</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyP"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyP">[docs]</a>    <span class="k">def</span> <span class="nf">bodyP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Position of body&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;RPP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PLA&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XYP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XZP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;YZP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XCC&quot;</span><span class="p">,</span> <span class="s2">&quot;XEC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;YCC&quot;</span><span class="p">,</span> <span class="s2">&quot;YEC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ZCC&quot;</span><span class="p">,</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BOX&quot;</span><span class="p">,</span> <span class="s2">&quot;SPH&quot;</span><span class="p">,</span> <span class="s2">&quot;RCC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRC&quot;</span><span class="p">,</span> <span class="s2">&quot;WED&quot;</span><span class="p">,</span> <span class="s2">&quot;REC&quot;</span><span class="p">,</span> <span class="s2">&quot;ELL&quot;</span><span class="p">,</span> <span class="s2">&quot;ARB&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="n">bodyP1</span> <span class="o">=</span> <span class="n">bodyP</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyP2"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyP2">[docs]</a>    <span class="k">def</span> <span class="nf">bodyP2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ELL&quot;</span><span class="p">,</span> <span class="s2">&quot;ARB&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># WARNING index starting from 1</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyPn"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyPn">[docs]</a>    <span class="k">def</span> <span class="nf">bodyPn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ARB&quot;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyN"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyN">[docs]</a>    <span class="k">def</span> <span class="nf">bodyN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normal of body&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PLA&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XYP&quot;</span><span class="p">,</span> <span class="s2">&quot;ZCC&quot;</span><span class="p">,</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">Z</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XZP&quot;</span><span class="p">,</span> <span class="s2">&quot;YCC&quot;</span><span class="p">,</span> <span class="s2">&quot;YEC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">Y</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;YZP&quot;</span><span class="p">,</span> <span class="s2">&quot;XCC&quot;</span><span class="p">,</span> <span class="s2">&quot;XEC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyX"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyX">[docs]</a>    <span class="k">def</span> <span class="nf">bodyX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;X-vector of body&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;RPP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BOX&quot;</span><span class="p">,</span> <span class="s2">&quot;WED&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;YEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyY"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyY">[docs]</a>    <span class="k">def</span> <span class="nf">bodyY</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Y-vector of body&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;RPP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BOX&quot;</span><span class="p">,</span> <span class="s2">&quot;WED&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;YEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyZ"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyZ">[docs]</a>    <span class="k">def</span> <span class="nf">bodyZ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Z-vector of body&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;RPP&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;BOX&quot;</span><span class="p">,</span> <span class="s2">&quot;WED&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RCC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRC&quot;</span><span class="p">,</span> <span class="s2">&quot;REC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.bodyR"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.bodyR">[docs]</a>    <span class="k">def</span> <span class="nf">bodyR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Radius (or x-radius) of body&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;SPH&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;RCC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XCC&quot;</span><span class="p">,</span> <span class="s2">&quot;YCC&quot;</span><span class="p">,</span> <span class="s2">&quot;ZCC&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;YEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Add a Zone to REGION</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Card.addZone"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.addZone">[docs]</a>    <span class="k">def</span> <span class="nf">addZone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zone</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add zone to card&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zone</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Card.setZones"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.setZones">[docs]</a>    <span class="k">def</span> <span class="nf">setZones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zones</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a list of zones as expression... removing empty zones&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setExtra</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">zones</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| &quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Card.loadVoxel"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Card.loadVoxel">[docs]</a>    <span class="k">def</span> <span class="nf">loadVoxel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load voxel information&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Voxel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.vxl&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span></div></div>


<div class="viewcode-block" id="Input"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input">[docs]</a><span class="k">class</span> <span class="nc">Input</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Input file information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Input Filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>

        <span class="c1"># Logical Units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">LogicalUnits</span><span class="p">()</span>

        <span class="c1"># Cards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cards</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Verbosity level (False|True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># parsing initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commentDisable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># File handles used during I/O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># file line number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filesType</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># card opened file type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Commented special whats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Commented card properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Comment preceding card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of whats of last added card</span>

        <span class="c1"># cache card lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span> <span class="o">=</span> <span class="n">LocalDict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="Input.setModified"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.setModified">[docs]</a>    <span class="k">def</span> <span class="nf">setModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set last time modified&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modified</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.clone"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a clone of current input&quot;&quot;&quot;</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">Input</span><span class="p">()</span>

        <span class="n">inp</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">inp</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span>
        <span class="n">inp</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span>

        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>

        <span class="n">inp</span><span class="o">.</span><span class="n">renumber</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inp</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">[])</span>

<div class="viewcode-block" id="Input.minimumInput"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.minimumInput">[docs]</a>    <span class="k">def</span> <span class="nf">minimumInput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create bare minimum input file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;COMBNAME&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;GEOEND&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.setFileTime"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.setFileTime">[docs]</a>    <span class="k">def</span> <span class="nf">setFileTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set as input/modified time the latest time from files&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_modified</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modified</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="Input.checkInputFile"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.checkInputFile">[docs]</a>    <span class="k">def</span> <span class="nf">checkInputFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a new input file exists&quot;&quot;&quot;</span>
        <span class="c1"># FIXME Scan all #include cards</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modified</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Input.filenames"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.filenames">[docs]</a>    <span class="k">def</span> <span class="nf">filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return input filename&quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">)</span>
        <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;#include&quot;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">files</span></div>

    <span class="k">def</span> <span class="nf">_openFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;open file and append it to the file handle list&quot;&quot;&quot;</span>
        <span class="c1"># TODO check for infinite loop!</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: File &#39;</span><span class="si">%s</span><span class="s2">&#39; is recursively loaded&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span> <span class="ow">and</span> <span class="n">backup</span><span class="p">:</span>
                <span class="n">backupname</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">backupname</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">backupname</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>  <span class="c1"># open file</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Cannot open file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filesType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">_closeFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filesType</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_readLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">closeinclude</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;read line from the last opened file&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># end of file?</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filesType</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#include&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">closeinclude</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;#endinclude&quot;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s2">&quot;#endinclude&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">continue</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">uline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">line</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># sline = str(uline) # TODO not used ?</span>
                <span class="k">return</span> <span class="n">line</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">uline</span>

    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="c1"># Read an input file</span>
    <span class="c1"># -----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Input.read"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open and read a fluka input file, return True if error&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Reading input file&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Process input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanUnits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setFileTime</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Input.include"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.include">[docs]</a>    <span class="k">def</span> <span class="nf">include</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">includecard</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        include card has been modified take appropriate action</span>
<span class="sd">        :param includecard:</span>
<span class="sd">        :return: True if #include has modified the input, False if nothing happened</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">includecard</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Check if file exist</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">includecard</span><span class="o">.</span><span class="n">sdum</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># File not exist do nothing</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check if #include contains already imported cards</span>
        <span class="n">fromid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">includecard</span><span class="p">)</span>
        <span class="c1"># Finding ending of #include</span>
        <span class="n">toid</span> <span class="o">=</span> <span class="n">fromid</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">toid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">):</span>
            <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">toid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#include&quot;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endinclude&quot;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">toid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># If range is not empty then return</span>
        <span class="k">if</span> <span class="n">toid</span> <span class="o">-</span> <span class="n">fromid</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Create a temporary input to load the included lines</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">Input</span><span class="p">()</span>
        <span class="n">location</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0=input, 1=bodies, 2=regions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fromid</span><span class="p">):</span>
            <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;FREE&quot;</span><span class="p">:</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>

            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;FIXED&quot;</span><span class="p">:</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>

            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GLOBAL&quot;</span><span class="p">:</span>
                <span class="n">w4</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">w4</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">inp</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">inp</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>

            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COMBNAME&quot;</span><span class="p">:</span>
                    <span class="n">inp</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COMBINAT&quot;</span><span class="p">:</span>
                    <span class="n">inp</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>
                <span class="n">location</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOEND&quot;</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">inp</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">includecard</span><span class="o">.</span><span class="n">sdum</span><span class="p">(),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">_parseBodies</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">_parseRegions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">inp</span><span class="o">.</span><span class="n">_parseVolumes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">fromid</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">inp</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scanUnits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">(</span><span class="n">fromid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Input.parse"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import/parse a file including geometry&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sdum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># current comment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Commented special whats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Number of whats of last added card</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">prev_tag</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="n">prev_sdum</span> <span class="o">=</span> <span class="n">sdum</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">sdum</span> <span class="o">=</span> <span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Handle card exceptions</span>
            <span class="c1"># 1. Continuation</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sdum</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;&amp;&quot;</span> <span class="ow">in</span> <span class="n">sdum</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">prev_tag</span><span class="p">:</span>
                <span class="c1"># Find last card and append whats</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">appendComment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span><span class="p">:</span>
                        <span class="c1"># append cards at the end</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">appendWhats</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># append cards in the middle in case</span>
                        <span class="c1"># that functions are used</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">appendWhats</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># 2. Compound continuation (special case)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;COMPOUND&quot;</span><span class="p">:</span>
                <span class="c1"># check if previous line is COMPOUND same state</span>
                <span class="c1"># and same sdum</span>
                <span class="k">if</span> <span class="n">prev_tag</span> <span class="o">==</span> <span class="n">tag</span> <span class="ow">and</span> <span class="n">prev_sdum</span> <span class="o">==</span> <span class="n">sdum</span><span class="p">:</span>
                    <span class="c1"># find last COMPOUND card with that sdum</span>
                    <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># check state</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span><span class="p">:</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">appendComment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span><span class="p">:</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">appendWhats</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">card</span><span class="o">.</span><span class="n">appendWhats</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">checkCompound</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                        <span class="k">continue</span>  <span class="c1"># skip the rest</span>

            <span class="c1"># 3. Extra line readout</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;TITLE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="s2">&quot;!mesh&quot;</span><span class="p">):</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">extra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="c1"># Handling of special cases needed for parsing</span>
            <span class="c1"># the rest of the file</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;FREE&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;FREE: Input format changed to&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;FIXED&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;FIXED: Input format changed to&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GLOBAL&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span><span class="p">:</span>
                <span class="n">w4</span> <span class="o">=</span> <span class="n">_intWhat</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">w4</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
                <span class="k">if</span> <span class="n">_intWhat</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>

            <span class="c1"># Handle special card PLOTGEOM</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;PLOTGEOM&quot;</span><span class="p">:</span>
                <span class="c1"># w6 = _intWhat(what, 6) # TODO never used</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="s2">&quot;PLG.GFXINDAT&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: cannot open file PLG.GFXINDAT&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                <span class="n">what</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">_str2num</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="mi">10</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">)])</span>

                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                <span class="n">what</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">_str2num</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="mi">10</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">)])</span>

                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                <span class="n">what</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">_str2num</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="mi">10</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">)])</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">:</span>
                <span class="c1"># Add to comments the following lines</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_intWhat</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="mi">1</span><span class="p">))):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">())</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOBEGIN&quot;</span> <span class="ow">and</span> <span class="n">sdum</span> <span class="o">!=</span> <span class="s2">&quot;FLUGG&quot;</span><span class="p">:</span>
                <span class="c1"># Starting position of GEO</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">==</span> <span class="n">FORMAT_SINGLE</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sdum</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COMBNAME&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

                <span class="n">w3</span> <span class="o">=</span> <span class="n">_intWhat</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">w4</span> <span class="o">=</span> <span class="n">_intWhat</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">w3</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">geoFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">geoFile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing geometry&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">=</span> <span class="n">geoFile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># XXX???</span>

                <span class="k">if</span> <span class="n">w4</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
                    <span class="n">geoOutFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">geoOutFile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing geometry&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">=</span> <span class="n">geoOutFile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parseGeometry</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;LATTICE&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parseLattice</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>

            <span class="c1"># Add current card</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">,</span> <span class="n">extra</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_parseGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geobegin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse Geometry&quot;&quot;&quot;</span>
        <span class="n">voxel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># self._cardEnable = True</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing geometry&quot;</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># line = line.rstrip()</span>

            <span class="c1"># if not self._cardEnable or line[0]==&#39;#&#39;:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GEOEND&quot;</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>
                <span class="k">return</span>

            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">loadVoxel</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR loading voxel file </span><span class="si">%s</span><span class="s2">.vxl&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()))</span>
                    <span class="n">say</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">voxel</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Except the title of the GEOBEGIN</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ivopt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ivopt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idbg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">idbg</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Special treatment for GEOBEGIN</span>
        <span class="n">geobegin</span><span class="o">.</span><span class="n">setExtra</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:])</span>
        <span class="c1"># Save vars for use in parsing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="n">ivopt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idbg</span> <span class="o">=</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">idbg</span> <span class="o">=</span> <span class="n">idbg</span>

        <span class="k">if</span> <span class="n">idbg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">==</span> <span class="n">FORMAT_SINGLE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_DOUBLE</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;GEOBEGIN: Geometry format:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parseBodies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parseRegions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parseVolume</span><span class="p">()</span>

        <span class="c1"># Correct last body name to VOXEL</span>
        <span class="k">if</span> <span class="n">voxel</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">!=</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
            <span class="c1"># Count all bodies</span>
            <span class="n">nbodies</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># +1</span>
            <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">BODY_TAGS</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nbodies</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">body</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeName</span><span class="p">(</span><span class="s2">&quot;bn&quot;</span><span class="p">,</span> <span class="n">_body2name</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nbodies</span><span class="p">)),</span> <span class="s2">&quot;VOXEL&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parseBodies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse bodies&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;   Parsing Bodies&quot;</span><span class="p">)</span>
        <span class="c1"># pdb.set_trace()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">what</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseBodyLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">_body2name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;END&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addEND</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR line </span><span class="si">%d</span><span class="s2">: Unknown body type </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tag</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="n">say</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">needwhat</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">nwhats</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># self._whatNeeded(what, needwhat)</span>
            <span class="c1"># Read and parse needed whats</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">needwhat</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing geometry&quot;</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parseBodyLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
            <span class="c1"># delete extra whats if any</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">needwhat</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">what</span><span class="p">[</span><span class="n">needwhat</span><span class="p">:]</span>
            <span class="n">what</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_parseBodyLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a body line&quot;&quot;&quot;</span>
        <span class="n">startWhat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">==</span> <span class="n">FORMAT_SINGLE</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">startWhat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid body definition at line: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">what</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_str2num</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">==</span> <span class="n">FORMAT_DOUBLE</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">startWhat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid body definition at line: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">22</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">what</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_str2num</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">wlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseFreeFormat</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">startWhat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">wlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">wlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wlist</span><span class="p">)):</span>
                <span class="n">what</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_str2num</span><span class="p">(</span><span class="n">wlist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">body</span><span class="p">,</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_parseRegions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse Regions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;   Parsing Regions&quot;</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">expstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># card = None  # active card # TODO never used ?</span>
        <span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># check for duplicate names in FIXED format</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addRegion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GEOEND&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addRegion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addEND</span><span class="p">()</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Error: Parsing geometry END is missing&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Preprocessor</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>  <span class="c1"># Parse defines</span>
                <span class="c1"># Add current region if any</span>
                <span class="n">oldcomment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>  <span class="c1"># Save the comment</span>
                <span class="c1"># card = self._addRegion(name, neighbors, comment, expstr, _cardEnable) # TODO never used ?</span>
                <span class="c1"># Possible region continuation</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span>
                <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">expstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">oldcomment</span>  <span class="c1"># Restore it</span>

                <span class="c1"># Add current card</span>
                <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endinclude&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>

            <span class="c1"># Free format</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                <span class="c1"># Free format</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                    <span class="n">oldcomment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>  <span class="c1"># remember comment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addRegion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">oldcomment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addEND</span><span class="p">()</span>
                    <span class="k">return</span>

                <span class="c1"># Check for region continuation</span>
                <span class="k">elif</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;+-|()&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">:</span>
                        <span class="n">oldcomment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>  <span class="c1"># remember comment</span>
                        <span class="c1"># add region</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addRegion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">)</span>

                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span>  <span class="c1"># continuation card</span>
                        <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">expstr</span> <span class="o">=</span> <span class="n">line</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="n">oldcomment</span>  <span class="c1"># restore comment</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># just for precaution</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># append to region expression</span>
                        <span class="n">expstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="c1"># New region definition</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">_REGIONPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Error in region: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">))</span>
                        <span class="k">continue</span>

                    <span class="n">oldcomment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>  <span class="c1"># remember comment</span>
                    <span class="n">thisProp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span>  <span class="c1"># and properties</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="n">prop</span>  <span class="c1"># restore old properties</span>
                    <span class="c1"># New region definition</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addRegion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">)</span>

                    <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">expstr</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">oldcomment</span>  <span class="c1"># remember comment</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">thisProp</span>  <span class="c1"># and properties</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># just for precaution</span>
                    <span class="n">_cardEnable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span>

            <span class="c1"># Single precision fixed format</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Name</span>

                <span class="c1"># New region definition</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">thisComment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>
                    <span class="c1"># Save previous region</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_addRegion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">)</span>
                    <span class="c1"># level = len(self._files) - 1  # remember level # TODO never used ?</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_addEND</span><span class="p">()</span>
                        <span class="k">return</span>

                    <span class="c1"># New region</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">_region2name</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;R</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span>
                    <span class="n">regions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">expstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">comment</span> <span class="o">=</span> <span class="n">thisComment</span>
                    <span class="n">_cardEnable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comment</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="c1"># get expression</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>

                <span class="c1"># Convert to free format expression string</span>
                <span class="n">efree</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idbg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="mi">7</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">%</span> <span class="n">width</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">%</span> <span class="n">width</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">width</span><span class="p">):</span>
                    <span class="n">orop</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">orop</span> <span class="o">==</span> <span class="s2">&quot;OR&quot;</span><span class="p">:</span>
                        <span class="n">efree</span> <span class="o">+=</span> <span class="s2">&quot; |&quot;</span>

                    <span class="n">body</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">width</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">body</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Bad alignment in region definition: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing region </span><span class="si">%s</span><span class="s2">: Invalid bodyname found </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> column=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                                        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">width</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">sign</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sign</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
                        <span class="n">efree</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">_body2name</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">efree</span> <span class="o">+=</span> <span class="s2">&quot; +</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_body2name</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">expstr</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">expstr</span> <span class="o">=</span> <span class="n">efree</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expstr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">efree</span>  <span class="c1"># Continue region</span>

    <span class="k">def</span> <span class="nf">_addEND</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">Card</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_addRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">,</span> <span class="n">_cardEnable</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span> <span class="ow">and</span> <span class="n">expstr</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">saveEnable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="n">_cardEnable</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">]</span>
        <span class="c1"># XXX should not come where with expstr=&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">expstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">expstr</span> <span class="o">=</span> <span class="n">expstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">expstr</span><span class="p">)</span>
        <span class="n">card</span><span class="p">[</span><span class="n">_VOLUME</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="n">saveEnable</span>
        <span class="k">return</span> <span class="n">card</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parseLattice</span><span class="p">(</span><span class="n">what</span><span class="p">):</span>
        <span class="n">sdum</span> <span class="o">=</span> <span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sdum</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">usdum</span> <span class="o">=</span> <span class="n">sdum</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">usdum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ROT&quot;</span><span class="p">,</span> <span class="s2">&quot;RO&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">usdum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Rot#</span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parseVolume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse Volume data if any&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Expect data in the format 7E10.5</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;   Parsing Volumes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;REGION&quot;</span><span class="p">]</span>
        <span class="n">lst</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Card</span><span class="o">.</span><span class="n">cmpPos_key</span><span class="p">)</span>
        <span class="n">regionList</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">]</span>

        <span class="n">nlines</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regionList</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nlines</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">nlines</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># peek next line</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing geometry&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">):</span>
                <span class="c1"># go back and exit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">_str2num</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">nr</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">regionList</span><span class="p">):</span>
                    <span class="n">regionList</span><span class="p">[</span><span class="n">nr</span><span class="p">][</span><span class="n">_VOLUME</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span>
                <span class="n">nr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">nlines</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_parseComment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">check4Card</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a comment line&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="c1"># if next character is not space</span>
            <span class="c1"># check if it is a valid card</span>
            <span class="n">cstart</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                    <span class="n">cstart</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="s2">&quot;234&quot;</span><span class="p">,</span> <span class="s2">&quot;===&quot;</span><span class="p">,</span> <span class="s2">&quot;---&quot;</span><span class="p">,</span> <span class="s2">&quot;***&quot;</span><span class="p">,</span> <span class="s2">&quot;___&quot;</span><span class="p">,</span> <span class="s2">&quot;_..&quot;</span><span class="p">,</span> <span class="s2">&quot;+++&quot;</span><span class="p">,</span> <span class="s2">&quot;_AA&quot;</span><span class="p">):</span>
                    <span class="n">cstart</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;@what.&quot;</span><span class="p">:</span>
                    <span class="c1"># treat special commented whats</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_CWHAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>

                <span class="k">elif</span> <span class="n">commentedCards</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check4Card</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">):</span>
                    <span class="c1"># Check for commented cards</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">cstart</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                            <span class="n">lline</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">cstart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lline</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">cstart</span><span class="p">:]</span>
                        <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseLine</span><span class="p">(</span><span class="n">lline</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="c1"># Check tag if it exists in CardInfo</span>
                        <span class="n">ci</span> <span class="o">=</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ci</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_commentDisable</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">return</span> <span class="n">lline</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="n">cline</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">cstart</span><span class="p">:]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">cline</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cline</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">cline</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commentDisable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_commentDisable</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;#if 0&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;#endif&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">line</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove inline comments</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">FLAIR_TAGS</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span>
                <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;@&quot;</span><span class="p">:</span>
                    <span class="c1"># treat special commented whats</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_CWHAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>

                    <span class="n">m</span> <span class="o">=</span> <span class="n">_OPT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="kc">None</span>

                    <span class="c1"># if everything fails add it as comment</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">+=</span> <span class="n">line</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">comment</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">+=</span> <span class="n">comment</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">p</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">line</span>

    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="c1"># Parse a single line to card, whats and sdum</span>
    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_parseLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseFreeFormat</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">what</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_PRPPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#include&quot;</span><span class="p">:</span>
                    <span class="c1"># replace the whats</span>
                    <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span> <span class="ow">and</span> <span class="n">enable</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">FORMAT_SINGLE</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">70</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>  <span class="c1"># sdum</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">what</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_str2num</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseFreeFormat</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">sdum</span> <span class="o">=</span> <span class="n">what</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sdum</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">what</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdum</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parseFreeFormat</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove unwanted characters from a free format line and separate everything with comma ,&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; *[;:/,] *&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">what</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; +&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_str2num</span><span class="p">,</span> <span class="n">what</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_whatNeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fgeo</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">needwhat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse needed whats&quot;&quot;&quot;</span>
        <span class="c1"># Read whats</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">needwhat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">utfReadline</span><span class="p">(</span><span class="n">fgeo</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error paring geometry&quot;</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseComment</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_parseBodyLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>

        <span class="c1"># delete extra whats if any</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">needwhat</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">what</span><span class="p">[</span><span class="n">needwhat</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">_addCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used internally while parsing to add a card&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nwhats</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">()</span>

        <span class="c1"># Replace special whats with card whats</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

        <span class="c1"># add properties if any</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">:</span>
            <span class="n">card</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cardEnable</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

        <span class="c1"># Reset comment and special whats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cwhat</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[:]</span>

<div class="viewcode-block" id="Input.writeWithInclude"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.writeWithInclude">[docs]</a>    <span class="k">def</span> <span class="nf">writeWithInclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open and write the input to file (specified either by filename, or by file pointer).</span>
<span class="sd">        Optionally use a different geometry file and a different format</span>
<span class="sd">        # WARNING FIXME no testing is done for the correctness of the file&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Writing input file&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lineNo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="n">backup</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>
        <span class="c1"># Start with single format as unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>

        <span class="c1"># Check for volume data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;REGION&quot;</span><span class="p">]:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">_VOLUME</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vol</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">break</span>

        <span class="c1"># main writting loop</span>
        <span class="n">geoExternal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">geolevel</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0 before geobegin</span>
        <span class="c1"># 1 bodies and VOXELS</span>
        <span class="c1"># 2 regions</span>
        <span class="c1"># 3 lattices</span>
        <span class="c1"># 4 geoend</span>
        <span class="c1"># 5 after</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkFormat</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="n">flugg</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;FLUGG&quot;</span>
                <span class="n">geoline</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">toStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="n">geolevel</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">utfWrite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="o">.</span><span class="n">commentStr</span><span class="p">())</span>
                <span class="n">utfWriteln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">geoline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">flugg</span><span class="p">:</span>
                    <span class="c1"># Do nothing, skip the geometry</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">utfWriteln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">)</span>
                        <span class="n">geoExternal</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Write geo out file before the title</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
                        <span class="n">utfWriteln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">geoExternal</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="n">backup</span><span class="p">)</span>

                <span class="c1"># If VOXELS are present</span>
                <span class="c1"># FIXME not good. Needs to write the cards as is</span>
                <span class="k">if</span> <span class="s2">&quot;VOXELS&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Write title</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">flugg</span><span class="p">:</span>
                    <span class="n">utfWriteln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">geoline</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#include&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="n">backup</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endinclude&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">geolevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">geolevel</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
                    <span class="c1"># XXX Could be problematic with the #if&#39;s</span>
                    <span class="n">geolevel</span> <span class="o">=</span> <span class="mi">2</span>

                <span class="k">elif</span> <span class="n">geolevel</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;REGION&quot;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="c1"># XXX could be problematic if #include is before</span>
                    <span class="c1"># then the END is written in the #include</span>
                    <span class="n">geolevel</span> <span class="o">=</span> <span class="mi">3</span>

                <span class="c1"># XXX insert region volumes? LATTICE or GEOEND</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;LATTICE&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">_geo</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOEND&quot;</span><span class="p">:</span>
                        <span class="n">geolevel</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">geoExternal</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkFormat</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setFileTime</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Input.write"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open and write the input to file (specified either by filename, or by file pointer).</span>
<span class="sd">        Optionally use a different geometry file and a different format&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Writing input file&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;#include&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeWithInclude</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">backup</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">readfile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">readfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">finp</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="n">backup</span><span class="p">)</span>

        <span class="c1"># Expressions</span>
        <span class="c1"># Start with single format as unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>

        <span class="c1"># 1st. Write all input cards before GEOBEGIN</span>
        <span class="c1">#      skipping geometry cards</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">geobegin</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">begin_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">geobegin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># add a GEOBEGIN card</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">w3</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w3</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">w4</span> <span class="o">=</span> <span class="mi">21</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w4</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">geobegin</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;COMBNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">w4</span><span class="p">])</span>
            <span class="c1"># Make a guess of the position before the first geometry card</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">isGeo</span><span class="p">():</span>
                    <span class="n">begin_</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">begin_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span>

        <span class="c1"># Check for volume data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;REGION&quot;</span><span class="p">]:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">_VOLUME</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vol</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">break</span>

        <span class="n">geobegin</span><span class="o">.</span><span class="n">ivopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span>

        <span class="c1"># Do not write any defines!</span>
        <span class="c1"># geolevel defines the position in the input file</span>
        <span class="c1">#   -1 before defines</span>
        <span class="c1">#    0 before geometry</span>
        <span class="c1">#    1 inside geometry</span>
        <span class="c1">#    2 after geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">_geo</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">begin_</span><span class="p">)</span>

        <span class="c1"># if there is no geometry... then exit</span>
        <span class="k">if</span> <span class="n">begin_</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">finp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">setFileTime</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 2nd. Write all non-geometry cards which are inside GEOBEGIN .. GEOEND</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find first GEOEND</span>
            <span class="n">geoend</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;GEOEND&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">end_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">geoend</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">_geo</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">begin_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">geoend</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">end_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span>

        <span class="c1"># 3th. Write the geometry cards</span>
        <span class="n">flugg</span> <span class="o">=</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;FLUGG&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFormat</span><span class="p">(</span><span class="n">geobegin</span><span class="p">)</span>
        <span class="n">geoline</span> <span class="o">=</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">toStr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">utfWrite</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">commentStr</span><span class="p">())</span>
        <span class="n">utfWriteln</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="n">geoline</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">flugg</span><span class="p">:</span>
            <span class="c1"># Do nothing, skip the geometry</span>
            <span class="n">fgeo</span> <span class="o">=</span> <span class="n">finp</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="c1"># Should be GEOBEGIN</span>
            <span class="c1"># XXX no defines!</span>
            <span class="n">utfWriteln</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fgeo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="n">backup</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Cannot open output geometry file </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Write geometry to input&quot;</span><span class="p">)</span>
                <span class="n">fgeo</span> <span class="o">=</span> <span class="n">finp</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Inline geometry</span>
            <span class="n">fgeo</span> <span class="o">=</span> <span class="n">finp</span>

        <span class="c1"># Write geo out file before the title</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">utfWriteln</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">flugg</span><span class="p">:</span>
            <span class="c1"># Write VOXELS are present</span>
            <span class="k">if</span> <span class="s2">&quot;VOXELS&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;VOXELS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Write title</span>
            <span class="n">utfWriteln</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="n">geoline</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># 4th Write geometry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeGeometry</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fgeo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">finp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>

        <span class="c1"># 6th. Write remaining cards including the GEOEND if any</span>
        <span class="k">if</span> <span class="n">geoend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geoend</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;GEOEND&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="n">geoend</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">_geo</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">begin_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">_geo</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end_</span><span class="p">)</span>

        <span class="c1"># Check for STOP at the end</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;STOP&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">finp</span><span class="p">,</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;STOP&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">finp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closeFile</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setFileTime</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Input.checkFormat"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.checkFormat">[docs]</a>    <span class="k">def</span> <span class="nf">checkFormat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find current format</span>
<span class="sd">        FIXME #defines and state!</span>
<span class="sd">        :param card:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;FREE&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;FIXED&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_SINGLE</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GLOBAL&quot;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
            <span class="k">elif</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># XXX XXX Accept only FREE format geometry XXX XXX</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Changing GLOBAL what(5)=1&quot;</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">:</span>
            <span class="c1"># Force free geometry format</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;COMBNAME&quot;</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;FLUGG&quot;</span><span class="p">:</span>
                <span class="c1"># XXX XXX Accept only COMBNAME! XXX XXX</span>
                <span class="c1"># To avoid stupid user errors</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Changing GEOBEGIN sdum=</span><span class="si">%s</span><span class="s2"> to COMBNAME&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setSdum</span><span class="p">(</span><span class="s2">&quot;COMBNAME&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span> <span class="o">=</span> <span class="n">FORMAT_FREE</span></div>

<div class="viewcode-block" id="Input.checkCompound"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.checkCompound">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">checkCompound</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check COMPOUND cards for correct mixture&quot;&quot;&quot;</span>
        <span class="c1"># check sign of whats</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">nwhats</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">6</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">s1</span> <span class="ow">or</span> <span class="n">card</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="n">s2</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Inconsistent compound mixture (Check signs)&quot;</span><span class="p">)</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;	What(</span><span class="si">%d</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">i</span><span class="p">))))</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;	What(</span><span class="si">%d</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">j</span><span class="p">))))</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setSign</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setSign</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Input.writeGeometry"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.writeGeometry">[docs]</a>    <span class="k">def</span> <span class="nf">writeGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fgeo</span><span class="p">,</span> <span class="n">geoFmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write geometry only</span>
<span class="sd">             preprocessor cards are written only when cards</span>
<span class="sd">             are in the correct position</span>
<span class="sd">        :param fgeo:</span>
<span class="sd">        :param geoFmt:</span>
<span class="sd">        :param fmt:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geoFmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">geoFmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoFormat</span>

        <span class="c1"># geolevel = 1 # TODO not used ?</span>

        <span class="c1"># Use the formating of the input</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span>

        <span class="c1"># 1st. Write bodies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">BODY_NOVXL_TAGS</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="n">geoFmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ends</span><span class="p">:</span>
            <span class="c1"># write all END until the first active</span>
            <span class="k">for</span> <span class="n">lastEnd</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ends</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">geoFmt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">():</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geoFmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                <span class="n">fgeo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fgeo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 2nd. Write regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="n">geoFmt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ends</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># write all END after the last one</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">ends</span><span class="p">[</span><span class="n">lastEnd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">geoFmt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">geoFmt</span> <span class="o">==</span> <span class="n">FORMAT_FREE</span><span class="p">:</span>
                <span class="n">fgeo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fgeo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Write volume data if needed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ivopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivopt</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">ivopt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">ivopt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">_VOLUME</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vol</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%10s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bmath</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">70</span><span class="p">:</span>
                    <span class="n">writeln</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">writeln</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>

        <span class="c1"># 3rd. Write lattices</span>
        <span class="k">if</span> <span class="s2">&quot;LATTICE&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeCards</span><span class="p">(</span><span class="n">fgeo</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;LATTICE&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Input.writeCard"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.writeCard">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write a single card&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">disableComment</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">commentedCards</span><span class="p">):</span>
            <span class="n">if0</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#if 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">if0</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">comment</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">utfWrite</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">commentStr</span><span class="p">())</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">evalWhatStr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">es</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">utfWrite</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">toStr</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">if0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#endif</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Input.writeCards"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.writeCards">[docs]</a>    <span class="k">def</span> <span class="nf">writeCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geolevel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to_</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write cards of that fulfill a given condition(lambda)</span>
<span class="sd">        with all the preprocessor cards around them</span>
<span class="sd">        FIXME Write also non empty blocks: #if .. #define/#undef .. #endif</span>
<span class="sd">              Might end up in duplicate blocks when only #define/#undef</span>
<span class="sd">              exist inside the geometry</span>
<span class="sd">        geolevel</span>
<span class="sd">          -1 before defines</span>
<span class="sd">           0 before geobegin</span>
<span class="sd">           1 bodies and voxels</span>
<span class="sd">           2 regions</span>
<span class="sd">           3 lattices</span>
<span class="sd">           4 after geoend</span>
<span class="sd">        from_ .. to_   (to_ is not included)</span>
<span class="sd">        :param f:</span>
<span class="sd">        :param condition:</span>
<span class="sd">        :param format:</span>
<span class="sd">        :param geolevel:</span>
<span class="sd">        :param from_:</span>
<span class="sd">        :param to_:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nest</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">writing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Force a fixed format</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="nb">format</span>

        <span class="c1"># Loop over all cards</span>
        <span class="k">if</span> <span class="n">to_</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">to_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to_</span><span class="p">):</span>
            <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>

            <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;GEOEND&quot;</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># find format</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span>

            <span class="c1"># Preprocessor nesting</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">writing</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;#if&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifdef&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifndef&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">cid</span>
                    <span class="n">nest</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endif&quot;</span><span class="p">:</span>
                    <span class="n">nest</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">nest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">writing</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">elif</span> <span class="n">nest</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># misplaced #elif or #else</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">cid</span>
                        <span class="n">nest</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;#elif&quot;</span><span class="p">,</span> <span class="s2">&quot;#else&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># misplaced #elif or #else</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">cid</span>
                    <span class="n">nest</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;#define&quot;</span><span class="p">,</span> <span class="s2">&quot;#undef&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">geolevel</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Write cards on top nesting correct level</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">writing</span><span class="p">:</span>
                            <span class="c1"># Write everything up to now</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="ow">or</span> <span class="n">condition</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">writing</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">elif</span> <span class="n">geolevel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># For anything with high nesting write them anyway</span>
                        <span class="c1"># when defines are not required</span>
                        <span class="k">if</span> <span class="n">nest</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">writing</span><span class="p">:</span>
                            <span class="c1"># Write everything up to now</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">cid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="ow">or</span> <span class="n">condition</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">writing</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Target cards</span>
            <span class="k">elif</span> <span class="n">condition</span><span class="p">(</span><span class="n">card</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">writing</span><span class="p">:</span>
                        <span class="c1"># Write everything up to now</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">cid</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="ow">or</span> <span class="n">condition</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">writing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span>

            <span class="c1"># Change the format after the current card if needed</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># find format</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">checkFormat</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># In the error case where a #if..#endif is not closed</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">start</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="ow">or</span> <span class="n">condition</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeCard</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Pickle/UnPickle</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Input.dump"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;dump input to pickler&quot;&quot;&quot;</span>

        <span class="c1"># Input file information</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span><span class="p">)</span>
        <span class="n">pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span><span class="p">)</span>

        <span class="c1"># Cards</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pickler</span><span class="p">)</span></div>

<div class="viewcode-block" id="Input.load"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unpickler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;load input from unpickle&quot;&quot;&quot;</span>

        <span class="c1"># Input file information</span>
        <span class="c1"># version = unpickler.load() # TODO not used ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoFile</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoOutFile</span> <span class="o">=</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="c1"># Cards</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">unpickler</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCard</span><span class="p">(</span><span class="n">card</span><span class="p">)</span></div>

<div class="viewcode-block" id="Input.cardsSorted"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.cardsSorted">[docs]</a>    <span class="k">def</span> <span class="nf">cardsSorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return cards of a specific tag sorted with _pos</span>
<span class="sd">        Possibilities on which:</span>
<span class="sd">            0: enabled and active	(requires a call to preprocess before)</span>
<span class="sd">            1: enabled</span>
<span class="sd">            2: all</span>

<span class="sd">        Warning on REGION maybe the &quot;&amp;&quot; you want to get rid off</span>
<span class="sd">        :param tag:</span>
<span class="sd">        :param which:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;bodies&quot;</span><span class="p">:</span>
            <span class="c1"># Special case returns a dictionary...</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">BODY_TAGS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">tag</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">():</span>
                        <span class="n">lst</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">if</span> <span class="s2">&quot;VOXELS&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">():</span>
                        <span class="n">lst</span><span class="p">[</span><span class="s2">&quot;VOXEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>
                        <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># sort the list for faster processing</span>
            <span class="n">cards</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="n">cards</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Card</span><span class="o">.</span><span class="n">cmpPos_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cards</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cards</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">enable</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="n">cards</span>

            <span class="c1"># Special treatment</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;MATERIAL&quot;</span><span class="p">:</span>
                <span class="n">mats</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                    <span class="n">mats</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">_defaultMaterials</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mats</span><span class="p">:</span>
                        <span class="n">lst</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">card</span><span class="p">)</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># FIXME Must append at the end ONLY the icru that are assigned</span>
                <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mats</span><span class="p">:</span>
                        <span class="n">mat</span> <span class="o">=</span> <span class="n">_icruMatDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">mat</span><span class="p">:</span>
                            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

            <span class="c1"># Append or Insert voxel cards</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">,</span> <span class="s2">&quot;MATERIAL&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPOUND&quot;</span><span class="p">,</span> <span class="s2">&quot;CORRFACT&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">voxel</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="ow">or</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
                        <span class="c1"># add to the end</span>
                        <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;REGION&quot;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">:</span>
                        <span class="c1"># insert to the beginning</span>
                        <span class="n">lst</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;MATERIAL&quot;</span><span class="p">:</span>
                        <span class="c1"># insert to the beginning</span>
                        <span class="n">lst</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;COMPOUND&quot;</span><span class="p">:</span>
                        <span class="c1"># insert to the beginning</span>
                        <span class="n">lst</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;COMPOUND&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;CORRFACT&quot;</span><span class="p">:</span>
                        <span class="c1"># insert to the beginning</span>
                        <span class="n">lst</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;CORRFACT&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lst</span></div>

<div class="viewcode-block" id="Input.allcards"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.allcards">[docs]</a>    <span class="k">def</span> <span class="nf">allcards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an extend list with all cards including the ones from the voxel&quot;&quot;&quot;</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">voxel</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="ow">or</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cl</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cl</span></div>

<div class="viewcode-block" id="Input.cardsCache"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.cardsCache">[docs]</a>    <span class="k">def</span> <span class="nf">cardsCache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cache lists when they are requested&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">what</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">what</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="n">tag</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">lst</span>
            <span class="k">return</span> <span class="n">lst</span></div>

<div class="viewcode-block" id="Input.clearCache"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.clearCache">[docs]</a>    <span class="k">def</span> <span class="nf">clearCache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.bestPosition"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.bestPosition">[docs]</a>    <span class="k">def</span> <span class="nf">bestPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find best position from the sorting order in the file search which card is closer to one we&#39;ve asked</span>
<span class="sd">        :param tag:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ci</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">cards</span><span class="p">:</span>
            <span class="c1"># Similar cards exists then add it after the last one</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">_pos</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># but with indent=0</span>
            <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endif&quot;</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">pos</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">ci</span><span class="o">.</span><span class="n">order</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">mintag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">mincl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">notIgnore</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">cards</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">order</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mindist</span><span class="p">):</span>
                    <span class="n">mindist</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="n">mintag</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">tag</span>
                    <span class="n">mincl</span> <span class="o">=</span> <span class="n">cards</span>

        <span class="k">if</span> <span class="n">mintag</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mincl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">mindist</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">_pos</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mincl</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">_pos</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mincl</span><span class="p">])</span>

        <span class="c1"># but with indent=0</span>
        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endif&quot;</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># skip backwards any START, STOP card</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">pos</span></div>

<div class="viewcode-block" id="Input.addCard"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.addCard">[docs]</a>    <span class="k">def</span> <span class="nf">addCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a card to list at position pos</span>
<span class="sd">        WARNING: renumber is False (on contrast with delCard, moveCard)</span>
<span class="sd">        :param card:</span>
<span class="sd">        :param pos:</span>
<span class="sd">        :param renumber:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span>  <span class="c1"># Keep input file link</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">taglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">taglist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">taglist</span>

        <span class="n">taglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>  <span class="c1"># Local (tag list)</span>

        <span class="n">prevCard</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
                <span class="n">prevCard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Find prev card</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>  <span class="c1"># Global cardlist</span>
            <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prevCard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">card</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>

        <span class="c1"># Check indent level of previous card</span>
        <span class="k">if</span> <span class="n">prevCard</span> <span class="ow">and</span> <span class="n">prevCard</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">prevCard</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_INC</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="n">prevCard</span><span class="o">.</span><span class="n">_indent</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="n">prevCard</span><span class="o">.</span><span class="n">_indent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_DEC</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">_indent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.delCard"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.delCard">[docs]</a>    <span class="k">def</span> <span class="nf">delCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete card by position&quot;&quot;&quot;</span>
        <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>

        <span class="c1"># Delete from the main list</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="c1"># Find tag list</span>
        <span class="n">taglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
        <span class="n">taglist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taglist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.delTag"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.delTag">[docs]</a>    <span class="k">def</span> <span class="nf">delTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all cards with a specific tag&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">tag</span><span class="p">]:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.delGeometryCards"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.delGeometryCards">[docs]</a>    <span class="k">def</span> <span class="nf">delGeometryCards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete geometry cards&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delTag</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delTag</span><span class="p">(</span><span class="s2">&quot;LATTICE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">BODY_TAGS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delTag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">TRANSFORM_TAGS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delTag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delTag</span><span class="p">(</span><span class="s2">&quot;END&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.changeTag"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.changeTag">[docs]</a>    <span class="k">def</span> <span class="nf">changeTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">newtag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change card tag&quot;&quot;&quot;</span>
        <span class="c1"># Remove from previous list</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="n">cl</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>

        <span class="c1"># change the tag</span>
        <span class="n">card</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">newtag</span><span class="p">)</span>

        <span class="c1"># Add to new list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">taglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">taglist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">taglist</span>
        <span class="n">taglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.moveCard"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.moveCard">[docs]</a>    <span class="k">def</span> <span class="nf">moveCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move card (src) at position (dest)&quot;&quot;&quot;</span>
        <span class="n">card</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">src</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dest</span> <span class="o">&gt;=</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">card</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.replaceCard"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.replaceCard">[docs]</a>    <span class="k">def</span> <span class="nf">replaceCard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;replace card at position (pos) with card&quot;&quot;&quot;</span>
        <span class="c1"># remember old card</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>

        <span class="c1"># replace in the cardlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># remove old from the taglist</span>
        <span class="n">taglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
        <span class="n">taglist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">taglist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>

        <span class="c1"># add the new to the taglist</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">taglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span>
            <span class="n">taglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">taglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">card</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">taglist</span>
        <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="n">card</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">old</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">num</span>

<div class="viewcode-block" id="Input.transformBody"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.transformBody">[docs]</a>    <span class="k">def</span> <span class="nf">transformBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform a body card, using a 4x4 transformation matrix&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;SPH&quot;</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XCC&quot;</span><span class="p">,</span> <span class="s2">&quot;YCC&quot;</span><span class="p">,</span> <span class="s2">&quot;ZCC&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformInfCyl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RCC&quot;</span><span class="p">,</span> <span class="s2">&quot;TRC&quot;</span><span class="p">):</span>
            <span class="c1"># XXX MM comment: add a check to switch to</span>
            <span class="c1"># infinite cylinders if it&#39;s the case?</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            <span class="n">length</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyZ</span><span class="p">())</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">length</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">length</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XYP&quot;</span><span class="p">,</span> <span class="s2">&quot;XZP&quot;</span><span class="p">,</span> <span class="s2">&quot;YZP&quot;</span><span class="p">,</span> <span class="s2">&quot;PLA&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformPlane</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RPP&quot;</span><span class="p">,</span> <span class="s2">&quot;BOX&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformBox</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REC&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformREC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;WED&quot;</span><span class="p">,</span> <span class="s2">&quot;RAW&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformWED</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ELL&quot;</span><span class="p">:</span>
            <span class="n">focus1</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
            <span class="n">focus2</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP2</span><span class="p">()</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">focus1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">focus1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">focus1</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">focus2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">focus2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">focus2</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;XEC&quot;</span><span class="p">,</span> <span class="s2">&quot;YEC&quot;</span><span class="p">,</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformInfEllCyl</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ARB&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyPn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;QUA&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformQUA</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;Invalid card </span><span class="si">%s</span><span class="s2"> for transformation&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_transformPlane</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyN</span><span class="p">())</span>
        <span class="n">dire</span> <span class="o">=</span> <span class="n">normal</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dire</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;YZP&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">dire</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;XZP&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">dire</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;XYP&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;PLA&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">normal</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">normal</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_transformInfCyl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyN</span><span class="p">())</span>
        <span class="c1"># XXX no scaling for the moment</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">dirCheck</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dirCheck</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;-X&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;XCC&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">dirCheck</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;-Y&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;YCC&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">dirCheck</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;-Z&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;ZCC&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># XXX transform to old version</span>
            <span class="k">if</span> <span class="n">_useQUA</span><span class="p">:</span>
                <span class="c1"># convert card to &quot;QUA&quot; and then transform it</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;QUA&quot;</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XCC&quot;</span><span class="p">])</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;YCC&quot;</span><span class="p">])</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ZCC&quot;</span><span class="p">])</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">())</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">())</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="n">radius</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">length2</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_transformQUA</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point</span> <span class="o">-=</span> <span class="nb">dir</span> <span class="o">*</span> <span class="n">infinite</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">infinite</span><span class="p">)</span> <span class="o">*</span> <span class="nb">dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;RCC&quot;</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">dir</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_transformWED</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyX</span><span class="p">())</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyY</span><span class="p">())</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyZ</span><span class="p">())</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_transformREC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyX</span><span class="p">())</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyY</span><span class="p">())</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyZ</span><span class="p">())</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_transformInfEllCyl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyX</span><span class="p">())</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyY</span><span class="p">())</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyN</span><span class="p">())</span>
        <span class="n">dirX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">dirY</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">dirZ</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;N&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dirX</span><span class="p">,</span> <span class="n">dirY</span><span class="p">,</span> <span class="n">dirZ</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_useQUA</span><span class="p">:</span>
                <span class="c1"># convert card to &quot;QUA&quot; and then transform it</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyX</span><span class="p">()</span> <span class="o">+</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyY</span><span class="p">()</span>
                <span class="n">rx2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">ry2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">rz2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;QUA&quot;</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rx2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;XEC&quot;</span><span class="p">])</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">ry2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;YEC&quot;</span><span class="p">])</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rz2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">])</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">()</span> <span class="o">/</span> <span class="n">rx2</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">/</span> <span class="n">ry2</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">()</span> <span class="o">/</span> <span class="n">rz2</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">rx2</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ry2</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">z</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">rz2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_transformQUA</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Transforming in REC</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;REC&quot;</span><span class="p">)</span>

                <span class="n">center</span> <span class="o">-=</span> <span class="n">Z</span> <span class="o">*</span> <span class="n">infinite</span>
                <span class="n">Z</span> <span class="o">*=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">infinite</span>

                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">dirZ</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;-X&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;XEC&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">XY</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">XY</span><span class="o">.</span><span class="n">y</span><span class="p">())))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">XY</span><span class="o">.</span><span class="n">z</span><span class="p">())))</span>

        <span class="k">elif</span> <span class="n">dirZ</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;-Y&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;YEC&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">XY</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">XY</span><span class="o">.</span><span class="n">z</span><span class="p">())))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">XY</span><span class="o">.</span><span class="n">x</span><span class="p">())))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;ZEC&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">XY</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">XY</span><span class="o">.</span><span class="n">x</span><span class="p">())))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">XY</span><span class="o">.</span><span class="n">y</span><span class="p">())))</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_transformBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">*</span> <span class="n">card</span><span class="o">.</span><span class="n">bodyP</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyX</span><span class="p">())</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyY</span><span class="p">())</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">multNoTranslation</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">bodyZ</span><span class="p">())</span>

        <span class="n">XD</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">YD</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
        <span class="n">ZD</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;N&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">XD</span><span class="p">,</span> <span class="n">YD</span><span class="p">,</span> <span class="n">ZD</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;RPP&quot;</span><span class="p">)</span>
            <span class="n">diagonal</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">Z</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">diagonal</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s2">&quot;BOX&quot;</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_transformQUA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Cxx</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Cyy</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Czz</span>

        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Cxy</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Cxz</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Cyz</span>

        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Cx</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Cy</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>  <span class="c1"># Cz</span>

        <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># C</span>

        <span class="n">minv</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">minv</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>

        <span class="c1"># New = matrix^T * A * matrix</span>
        <span class="n">AN</span> <span class="o">=</span> <span class="n">minv</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">minv</span><span class="p">)</span>

        <span class="c1"># XXX optimize (convert to other objects if needed)</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">AN</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>

<div class="viewcode-block" id="Input.scanUnits"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.scanUnits">[docs]</a>    <span class="k">def</span> <span class="nf">scanUnits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scan for units&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Input.convert2Names"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.convert2Names">[docs]</a>    <span class="k">def</span> <span class="nf">convert2Names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert input to names and check for obsolete and/or non-valid cards&quot;&quot;&quot;</span>
        <span class="c1"># Find materials for duplicate checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span>

        <span class="c1"># Check geometry for FLUGG</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">geobegin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="s2">&quot;GEOBEGIN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">notflugg</span> <span class="o">=</span> <span class="n">geobegin</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;FLUGG&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">notflugg</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">matDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">materialList</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matDict</span><span class="p">:</span>
                <span class="n">matDict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">matDict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check for obsolete cards</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ACCURACY&quot;</span><span class="p">,</span> <span class="s2">&quot;OUTLEVEL&quot;</span><span class="p">,</span> <span class="s2">&quot;EGSCUT&quot;</span><span class="p">,</span> <span class="s2">&quot;EGSFIX&quot;</span><span class="p">,</span> <span class="s2">&quot;EGSFLUO&quot;</span><span class="p">,</span> <span class="s2">&quot;EGSRAY&quot;</span><span class="p">,</span> <span class="s2">&quot;EGS&quot;</span><span class="p">,</span> <span class="s2">&quot;LANDAU&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Disabling obsolete card: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">))</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">_developer</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;EVENTYPE&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Disabling obsolete card: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">))</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;EXTRAWEI&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changeAllTags</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;USERWEIG&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;DUMPTHEM&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changeAllTags</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;USERDUMP&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;MATERIAL&quot;</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">matDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">(),</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Material </span><span class="si">%s</span><span class="s2"> already exists with index=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)))</span>
                    <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>

            <span class="c1"># Check input</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">case</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Disabling unknown card.&quot;</span><span class="p">)</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                <span class="n">card</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">info</span> <span class="ow">is</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">none</span><span class="p">():</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Invalid tag name on card.&quot;</span><span class="p">)</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Invalid tag name&quot;</span><span class="p">]</span>
                <span class="n">card</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">invalid</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">invalid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: No matching case found for card&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Invalid what(s)=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">invalid</span><span class="p">)))</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>

            <span class="c1"># Convert card to names</span>
            <span class="k">if</span> <span class="n">notflugg</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.validate"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate all active cards&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">card</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.changeAllTags"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.changeAllTags">[docs]</a>    <span class="k">def</span> <span class="nf">changeAllTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Changing all cards tag from old to new&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Changing card(s) </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">old</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">new</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="n">old</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">changeTag</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.changeName"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.changeName">[docs]</a>    <span class="k">def</span> <span class="nf">changeName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change name to all cards&quot;&quot;&quot;</span>
        <span class="c1"># For bodies use special treatment</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;bn&quot;</span><span class="p">:</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\b</span><span class="si">%s</span><span class="s2">\b)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">old</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;REGION&quot;</span><span class="p">]:</span>
                <span class="n">newextra</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">extra</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">newextra</span> <span class="o">!=</span> <span class="n">card</span><span class="o">.</span><span class="n">extra</span><span class="p">():</span>
                    <span class="n">card</span><span class="o">.</span><span class="n">setExtra</span><span class="p">(</span><span class="n">newextra</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">findCase</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
                <span class="n">lst</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># skip step</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="n">old</span><span class="p">:</span>
                        <span class="n">card</span><span class="o">.</span><span class="n">setWhat</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.renumber"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.renumber">[docs]</a>    <span class="k">def</span> <span class="nf">renumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromPos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">toPos</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put the correct index to cards in the range given by fromPos:toPos&quot;&quot;&quot;</span>
        <span class="n">cardlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span>
        <span class="k">if</span> <span class="n">toPos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">toPos</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cardlist</span><span class="p">):</span>
            <span class="n">toPos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cardlist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fromPos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">card</span> <span class="o">=</span> <span class="n">cardlist</span><span class="p">[</span><span class="n">fromPos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="n">cardlist</span><span class="p">[</span><span class="n">fromPos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_indent</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_INC</span><span class="p">:</span>
                    <span class="n">indent</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fromPos</span><span class="p">,</span> <span class="n">toPos</span><span class="p">):</span>
            <span class="n">card</span> <span class="o">=</span> <span class="n">cardlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_DEC</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">indent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="n">indent</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_INC</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setModified</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkNumbering</span><span class="p">()</span>  <span class="c1"># FIXME XXX (delete this)</span></div>

<div class="viewcode-block" id="Input.checkNumbering"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.checkNumbering">[docs]</a>    <span class="k">def</span> <span class="nf">checkNumbering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the internal order of the cards&quot;&quot;&quot;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">_pos</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Cards out of order pos=#</span><span class="si">%d</span><span class="s2"> it should be #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_DEC</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">indent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span> <span class="o">!=</span> <span class="n">indent</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Indent out of order pos=#</span><span class="si">%d</span><span class="s2"> card._indent=</span><span class="si">%d</span><span class="s2"> it should be </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">_indent</span><span class="p">,</span> <span class="n">indent</span><span class="p">))</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">_INDENT_INC</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%d</span><span class="s2"> cards found out of order. Correcting error&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">say</span><span class="p">(</span><span class="s2">&quot;*** Please contact </span><span class="si">%s</span><span class="s2"> ***&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__email__</span><span class="p">))</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input.preprocess"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.preprocess">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">activeDefines</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pre-process all cards and set correspondingly the card.active flag</span>
<span class="sd">        nest[] contains the evaluation of the nesting</span>
<span class="sd">        -1: inactive - do not include any subsequent #if..</span>
<span class="sd">         0: false &amp; active - include substitute #if..</span>
<span class="sd">         1: true  &amp; active</span>
<span class="sd">         2: false &amp; active after else</span>
<span class="sd">         3: true  &amp; active after else</span>
<span class="sd">        FIXME values do not WORK!</span>
<span class="sd">        :param activeDefines:</span>
<span class="sd">        :return: list of error cards</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span>
        <span class="n">define</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">activeDefines</span><span class="p">:</span>
            <span class="n">useInputDefines</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">activeDefines</span><span class="p">:</span>
                <span class="n">define</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">_globalDict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if none or empty list e.g. default run = []</span>
            <span class="n">useInputDefines</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">nest</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">active13</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">active</span> <span class="o">=</span> <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setActive</span><span class="p">(</span><span class="n">active13</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">active13</span> <span class="o">=</span> <span class="n">active</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">card</span><span class="o">.</span><span class="n">setActive</span><span class="p">(</span><span class="n">active13</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">active13</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#define&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">useInputDefines</span><span class="p">:</span>
                    <span class="n">define</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">localDict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">active13</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#undef&quot;</span> <span class="ow">and</span> <span class="n">useInputDefines</span><span class="p">:</span>
                <span class="n">define</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;#if&quot;</span><span class="p">,</span> <span class="s2">&quot;#ifdef&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">active13</span><span class="p">:</span>
                    <span class="n">nest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">define</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ignore this nesting</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#ifndef&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">active13</span><span class="p">:</span>
                    <span class="n">nest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">define</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># ignore this nesting</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#elif&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Error unexpected #elif, card: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># terminate this nesting</span>
                <span class="k">elif</span> <span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">define</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">active</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Misplaced #elif after #else, card: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">active</span> <span class="o">=</span> <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">active13</span> <span class="o">=</span> <span class="n">active</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setActive</span><span class="p">(</span><span class="n">active13</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#else&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Error unexpected #else, card: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">active</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Misplaced #else, card: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">active</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">active</span> <span class="o">=</span> <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">active13</span> <span class="o">=</span> <span class="n">active</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setActive</span><span class="p">(</span><span class="n">active13</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;#endif&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Error unexpected #endif, card: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">card</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nest</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">active</span> <span class="o">=</span> <span class="n">nest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">active13</span> <span class="o">=</span> <span class="n">active</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">card</span><span class="o">.</span><span class="n">setActive</span><span class="p">(</span><span class="n">active13</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="Input.bodyProperties"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.bodyProperties">[docs]</a>    <span class="k">def</span> <span class="nf">bodyProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the body properties as a dictionary of the active/enabled bodies</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">translat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">card</span><span class="o">.</span><span class="n">isGeo</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">del</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@dx&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@dy&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@dz&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@expansion&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@transform&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">translat</span><span class="p">:</span>
                    <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@dx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translat</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@dy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translat</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@dz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translat</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expansion</span><span class="p">:</span>
                    <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@expansion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expansion</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">transform</span><span class="p">:</span>
                    <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@transform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;$start_translat&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">translat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Double </span><span class="si">%s</span><span class="s2"> found #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">translat</span> <span class="o">=</span> <span class="n">card</span>
                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;$start_transform&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Double </span><span class="si">%s</span><span class="s2"> found #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">transform</span> <span class="o">=</span> <span class="n">card</span>
                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;$start_expansion&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">expansion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Double </span><span class="si">%s</span><span class="s2"> found #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expansion</span> <span class="o">=</span> <span class="n">card</span>

                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;$end_translat&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">translat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> without $start_xxx found #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="n">translat</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;$end_transform&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> without $start_xxx found #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="n">transform</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">card</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;$end_expansion&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">expansion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> without $start_xxx found #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="n">expansion</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Input.regionProperties"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.regionProperties">[docs]</a>    <span class="k">def</span> <span class="nf">regionProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the region properties as a dictionary of the active/enabled regions</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">regionDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">regionList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">materialList</span><span class="p">(</span><span class="n">icru</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">matDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rotDefi</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Find Materials</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">_defaultMaterials</span><span class="p">:</span>
            <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">_icruMaterials</span><span class="p">:</span>
            <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># finally materials in voxels and input</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">card</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># Find regions</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">blckhole</span> <span class="o">=</span> <span class="n">matDict</span><span class="p">[</span><span class="s2">&quot;BLCKHOLE&quot;</span><span class="p">]</span>
        <span class="n">vacuum</span> <span class="o">=</span> <span class="n">matDict</span><span class="p">[</span><span class="s2">&quot;VACUUM&quot;</span><span class="p">]</span>

        <span class="c1"># Add a new region to dictionaries</span>
        <span class="k">def</span> <span class="nf">addRegion</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="c1"># Assign default values to region</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGION_BLACKHOLE</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blckhole</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@biasingA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># All particles biasing</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@biasingH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Hadrons</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@biasingE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># emf</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@biasingN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># low-neutrons</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@assignmat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Card that assigned the material</span>
            <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@cont&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># has continuation cards</span>

            <span class="n">regionDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
            <span class="n">regionList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>

        <span class="c1"># Input and voxel regions</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">addRegion</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">sdum</span><span class="p">())</span>

        <span class="c1"># add last region</span>
        <span class="k">if</span> <span class="n">regionList</span><span class="p">:</span>
            <span class="n">regionDict</span><span class="p">[</span><span class="s2">&quot;@LASTREG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regionList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Find transformations</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;ROT-DEFI&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">w1</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w1</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

            <span class="n">rotDefi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span>
            <span class="n">rotDefi</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c1"># Voxel assignmat if any</span>
        <span class="n">hasVoxels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">voxel</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="ow">or</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">hasVoxels</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">]:</span>
                <span class="n">material</span> <span class="o">=</span> <span class="n">matDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Material </span><span class="si">%s</span><span class="s2"> is not defined #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                    <span class="n">material</span> <span class="o">=</span> <span class="n">_defaultMaterials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Blackhole</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGION_VOXEL</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@assignmat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@materialDefined&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

        <span class="c1"># Check all assignmat</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">material</span> <span class="o">=</span> <span class="n">matDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">material</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Material </span><span class="si">%s</span><span class="s2"> is not defined #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                <span class="n">material</span> <span class="o">=</span> <span class="n">_defaultMaterials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Blackhole</span>

            <span class="n">matDecay</span> <span class="o">=</span> <span class="n">matDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">material</span><span class="p">)</span>

            <span class="n">fromReg</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fromReg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pat</span> <span class="o">=</span> <span class="n">_VOXELPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">pat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR: Region </span><span class="si">%s</span><span class="s2"> is not defined #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">fromReg</span> <span class="o">=</span> <span class="n">fromReg</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">evalWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">toReg</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">fromReg</span>

            <span class="n">step</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fromReg</span><span class="p">,</span> <span class="n">toReg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">regionList</span><span class="p">[</span><span class="n">rg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">hasVoxels</span> <span class="ow">and</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;VOXEL&quot;</span> <span class="ow">or</span> <span class="n">_VOXELPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">())):</span>
                    <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGION_VOXEL</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">material</span> <span class="ow">is</span> <span class="n">blckhole</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@assignmat&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">warnMultMat</span><span class="p">:</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: Multiple ASSIGNMAT for region </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;  Previous: #</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="s2">&quot;@assignmat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@assignmat&quot;</span><span class="p">]))</span>
                    <span class="n">say</span><span class="p">(</span><span class="s2">&quot;  Current : #</span><span class="si">%d</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">)))</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@assignmat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">material</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@matDecay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matDecay</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@materialDefined&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check Biasing cards</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;BIASING&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">what1</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">what1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">elif</span> <span class="n">what1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;@biasingH&quot;</span>
            <span class="k">elif</span> <span class="n">what1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;@biasingE&quot;</span>
            <span class="k">elif</span> <span class="n">what1</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;@biasingN&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;@biasingA&quot;</span>

            <span class="n">fromReg</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fromReg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fromReg</span> <span class="o">=</span> <span class="n">fromReg</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">toReg</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">fromReg</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fromReg</span><span class="p">,</span> <span class="n">toReg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">regionList</span><span class="p">[</span><span class="n">rg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">region</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># Check Lattices</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;LATTICE&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">fromReg</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">fromReg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fromReg</span> <span class="o">=</span> <span class="n">fromReg</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">regionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">toReg</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">toReg</span> <span class="o">=</span> <span class="n">fromReg</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">rotdefi</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fromReg</span><span class="p">,</span> <span class="n">toReg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">regionList</span><span class="p">[</span><span class="n">rg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">REGION_LATTICE</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@material&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vacuum</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@materialDefined&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@lattice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>
                <span class="n">region</span><span class="p">[</span><span class="s2">&quot;@rotdefi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotdefi</span>

        <span class="k">return</span> <span class="n">regionList</span></div>

<div class="viewcode-block" id="Input.addCardProperty"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.addCardProperty">[docs]</a>    <span class="k">def</span> <span class="nf">addCardProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">proptag</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">valueWhat</span><span class="p">,</span> <span class="n">fromWhat</span><span class="p">,</span> <span class="n">toWhat</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stepWhat</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sdum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append to card&#39;s properties the additional value from tag&#39;s</span>
<span class="sd">        :param tag: cards to append the extra property</span>
<span class="sd">        :param proptag: cards from where to get the property</span>
<span class="sd">        :param prop: property name to add in cards</span>
<span class="sd">        :param valueWhat: which value to add as property</span>
<span class="sd">        :param fromWhat: range of cards</span>
<span class="sd">        :param toWhat: range of cards</span>
<span class="sd">        :param stepWhat: range of cards</span>
<span class="sd">        :param sdum: filter cards with the specific sdum</span>
<span class="sd">        :param func: apply a function to value</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># create a dictionary of cards for faster accessing</span>
        <span class="n">cardlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;REGION&quot;</span><span class="p">:</span>
            <span class="n">cardlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cardlist</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">]</span>  <span class="c1"># Remove continuations of regions</span>

        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cardlist</span><span class="p">:</span>
            <span class="n">dictionary</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>
            <span class="n">card</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="n">proptag</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sdum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">!=</span> <span class="n">sdum</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">from_</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">fromWhat</span><span class="p">)][</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">from_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">to_</span> <span class="o">=</span> <span class="n">from_</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">toWhat</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">toW</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">toWhat</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">toW</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
                        <span class="n">to_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cardlist</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">to_</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">toW</span><span class="p">][</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="n">stepWhat</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">valueWhat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cardlist</span><span class="p">[</span><span class="n">from_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">to_</span><span class="p">:</span><span class="n">step</span><span class="p">]:</span>
                <span class="n">c</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Input.material"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.material">[docs]</a>    <span class="k">def</span> <span class="nf">material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">toName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert material to name/number</span>
<span class="sd">        :param mat:</span>
<span class="sd">        :param toName:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">materialList</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">toName</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># 1 based</span>
            <span class="k">if</span> <span class="n">mat</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mat</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mat</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># Accept -1 == 0 index</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid material index requested idx=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="n">mat</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lst</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Input.materialList"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.materialList">[docs]</a>    <span class="k">def</span> <span class="nf">materialList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">icru</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assigned</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_defaultMaterials</span><span class="p">]</span>

        <span class="c1"># Add first voxel materials</span>
        <span class="c1"># FIXME maybe apply it on the card and not on the Input!!!!</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">voxel</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="ow">or</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">]])</span>

        <span class="c1"># Add user defined materials</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 0 based!</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

            <span class="c1"># Append or replace</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
                <span class="n">lst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">lst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">icru</span><span class="p">:</span>
            <span class="c1"># Add all icru materials regardless of their order</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">_icruMaterials</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">assigned</span><span class="p">:</span>
            <span class="c1"># Add all materials assigned, especially for the ICRU ones</span>
            <span class="c1"># correct index assigned by FLUKA</span>
            <span class="c1"># FIXME Not very intelligent.</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;ASSIGNMA&quot;</span><span class="p">,</span> <span class="n">which</span><span class="p">):</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lst</span></div>

<div class="viewcode-block" id="Input.materialDict"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.materialDict">[docs]</a>    <span class="k">def</span> <span class="nf">materialDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">matDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Default materials</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">_defaultMaterials</span><span class="p">:</span>
            <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># ICRU materials</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">_icruMaterials</span><span class="p">:</span>
            <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># Voxel materials</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">voxel</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="ow">or</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">voxel</span><span class="p">[</span><span class="s2">&quot;@voxel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">]:</span>
                <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="c1"># ... and finally from the input</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">):</span>
            <span class="n">matDict</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">card</span>

        <span class="k">return</span> <span class="n">matDict</span></div>

<div class="viewcode-block" id="Input.materialZAID"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.materialZAID">[docs]</a>    <span class="k">def</span> <span class="nf">materialZAID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">material</span><span class="p">):</span>
        <span class="c1"># Check if it is a compound or a single material</span>

        <span class="c1"># Single isotope?</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">Z</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">A</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">material</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># Density</span>

        <span class="c1"># Compound search</span>
        <span class="n">ZAID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">compound</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;COMPOUND&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">compound</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">compound</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">!=</span> <span class="n">material</span><span class="o">.</span><span class="n">sdum</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">whats</span><span class="p">()),</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mat</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">negative</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">negative</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Find material</span>
                <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="n">mat</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Search default materials</span>
                    <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">_defaultMaterials</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="n">mat</span><span class="p">:</span>
                            <span class="k">break</span>

                <span class="c1"># Scan recursively</span>
                <span class="k">for</span> <span class="n">za</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">materialZAID</span><span class="p">(</span><span class="n">card</span><span class="p">):</span>
                    <span class="c1"># Scale fractions</span>
                    <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
                        <span class="c1"># Density</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">rho</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Mass or atom fraction</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="n">frac</span>
                    <span class="n">ZAID</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">za</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ZAID</span></div>

<div class="viewcode-block" id="Input.region"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.region">[docs]</a>    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">toName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert region to name/number</span>
<span class="sd">        :param reg:</span>
<span class="sd">        :param toName:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Regions removing continuation cards</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;REGION&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">toName</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="n">regions</span><span class="p">[</span><span class="n">reg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">what</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Input.getTransformation"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.getTransformation">[docs]</a>    <span class="k">def</span> <span class="nf">getTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rotdefi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FIXME I should combine the rotdefi with the self.cache!</span>
<span class="sd">        :param idx:  rotation to return, Can be prefixed with &quot;-&quot;, None to return a dictionary</span>
<span class="sd">        :param rotdefi:  cached dictionary</span>
<span class="sd">        :param inv: return the inverse of the idx matrix. Accepted even if idx is prefixed with &quot;-&quot;</span>
<span class="sd">        :return: rotation matrix from a rot-defi cards or a dictionary with all transformations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">_ROTPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="n">idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return dictionary of transformations</span>
            <span class="n">rotdefi</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">neg</span>

        <span class="c1"># Check if is cached</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rotdefi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">rotdefi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">rotdefi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="n">matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">matrix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Scan transformations</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;ROT-DEFI&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">ignore</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">w1</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w1</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># try with the name</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">rotdefi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">())</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">rotdefi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">rotdefi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rotdefi</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">())</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                        <span class="c1"># FIXME store the error somewhere...</span>
                        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;WARNING: ROT-DEFI Index and name do not match #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">say</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">matrix</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">last</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">last</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">last</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">rotdefi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">rotdefi</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">rotdefi</span><span class="p">[</span><span class="s2">&quot;rot#</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()):</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">numWhat</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">z</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix</span>

            <span class="k">if</span> <span class="n">phi</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="n">phi</span><span class="p">),</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">matrix</span>

            <span class="k">if</span> <span class="n">theta</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">bmath</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">matrix</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">matrix</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rotdefi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span>

        <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
            <span class="n">matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rotdefi</span>
        <span class="k">return</span> <span class="n">matrix</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Rot-Defi list</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Input.rotdefiList"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.rotdefiList">[docs]</a>    <span class="k">def</span> <span class="nf">rotdefiList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cards</span><span class="p">[</span><span class="s2">&quot;ROT-DEFI&quot;</span><span class="p">]:</span>
                <span class="n">w1</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">intWhat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">w1</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rot</span><span class="p">[</span><span class="s2">&quot;rot#</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rot</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">sdum</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">item</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">item</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">rot</span>
        <span class="k">return</span> <span class="n">lst</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># @return a list of linked ROT-DEFI cards with the same idx</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Input.rotdefiCards"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.rotdefiCards">[docs]</a>    <span class="k">def</span> <span class="nf">rotdefiCards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cardsSorted</span><span class="p">(</span><span class="s2">&quot;ROT-DEFI&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">sdum</span><span class="p">()</span> <span class="o">==</span> <span class="n">idx</span><span class="p">]</span></div>

    <span class="c1"># ----------------------------------------------------------------------</span>
    <span class="c1"># Refresh cards information</span>
    <span class="c1"># 1. ?? (renumber??)</span>
    <span class="c1"># 2. Reload voxels</span>
    <span class="c1"># 3. Properties?</span>
    <span class="c1"># ----------------------------------------------------------------------</span>
<div class="viewcode-block" id="Input.refresh"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.Input.refresh">[docs]</a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">voxel</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">]:</span>
            <span class="n">voxel</span><span class="o">.</span><span class="n">loadVoxel</span><span class="p">()</span></div></div>


<span class="k">def</span> <span class="nf">_str2num</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if argument w is a valid fortran number and</span>
<span class="sd">    return argument converted to a valid python number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># TODO not used ?</span>
            <span class="c1"># p = string.index(&quot;+-.0123456789&quot;, w[0])</span>
            <span class="c1"># p = string.index(&quot;.0123456789d DeE&quot;, w[1])</span>
            <span class="c1"># p = string.index(&quot;.0123456789&quot;, w[-1])</span>
            <span class="n">we</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
            <span class="n">we</span> <span class="o">=</span> <span class="n">we</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
            <span class="n">we</span> <span class="o">=</span> <span class="n">we</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">wn</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">we</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wn</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span>


<span class="k">def</span> <span class="nf">_intWhat</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_str2num</span><span class="p">(</span><span class="n">what</span><span class="p">[</span><span class="n">n</span><span class="p">])))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_body2name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BODY_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_region2name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">REGION_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_NAMEPAT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">REGION_PREFIX</span> <span class="o">+</span> <span class="n">name</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../apidoc/pymchelper.flair.Input.html#pymchelper.flair.Input.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize classes:</span>
<span class="sd">        CardInfo</span>
<span class="sd">        Particle</span>
<span class="sd">    :param filename:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_defaultMaterials</span><span class="p">,</span> <span class="n">_defaultMatDict</span><span class="p">,</span> <span class="n">_icruMaterials</span><span class="p">,</span> <span class="n">_icruMatDict</span>
    <span class="k">global</span> <span class="n">_neutronGroups</span><span class="p">,</span> <span class="n">_lowMaterials</span><span class="p">,</span> <span class="n">_usermvax</span>
    <span class="k">global</span> <span class="n">NGROUPS</span><span class="p">,</span> <span class="n">BODY_TAGS</span><span class="p">,</span> <span class="n">BODY_NOVXL_TAGS</span><span class="p">,</span> <span class="n">FLAIR_TAGS</span><span class="p">,</span> <span class="n">OBJECT_TAGS</span><span class="p">,</span> <span class="n">TRANSFORM_TAGS</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="n">_database</span><span class="p">)</span>

    <span class="c1"># read card database and prepare CardInfo classes</span>
    <span class="n">cardini</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">cardini</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">CardInfo</span><span class="p">(</span><span class="n">ERROR</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="p">[[</span><span class="s2">&quot;-&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[[</span><span class="s2">&quot;?&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Error in tag...&quot;</span><span class="p">)</span>

    <span class="c1"># Go through all cards</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cardini</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="c1"># Ignore sections with lower case letters</span>
        <span class="c1"># it does not include the &#39;#xxx&#39; sections</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="c1"># name is complete, tag is only 8 characters max</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">meaning</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;meaning&quot;</span><span class="p">)</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># Capitalize each group</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)):</span>
            <span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

        <span class="c1"># Ranges</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">assert_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;range.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rg</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">range_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rg</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;defaults.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">default</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="c1"># Get extra info</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;extra.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Correct sdum</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

            <span class="c1"># Get assert info</span>
            <span class="n">ass</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;assert.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">assert_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ass</span><span class="p">)</span>

        <span class="c1"># Cleanup a bit, check for empty range_, assert_</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="n">range_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">empty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assert_</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">empty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
            <span class="n">assert_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># append to CardInfo database</span>
        <span class="n">cinfo</span> <span class="o">=</span> <span class="n">CardInfo</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">range_</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">assert_</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">meaning</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">disable</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;disable&quot;</span><span class="p">)</span>
            <span class="n">cinfo</span><span class="o">.</span><span class="n">setDisableComment</span><span class="p">(</span><span class="n">disable</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">cinfo</span>

    <span class="c1"># Create bodies cards</span>
    <span class="n">BODY_NOVXL_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                       <span class="k">if</span> <span class="s2">&quot;Geometry&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">group</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;END&quot;</span><span class="p">]</span>
    <span class="n">BODY_TAGS</span> <span class="o">=</span> <span class="n">BODY_NOVXL_TAGS</span><span class="p">[:]</span>
    <span class="n">BODY_TAGS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;VOXELS&quot;</span><span class="p">)</span>

    <span class="n">BODY_NOVXL_TAGS</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">BODY_TAGS</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1"># Geometry transformation tags</span>
    <span class="n">TRANSFORM_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">]</span>
    <span class="n">TRANSFORM_TAGS</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c1"># Create flair tags</span>
    <span class="n">FLAIR_TAGS</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">CardInfo</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;Flair&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
    <span class="n">FLAIR_TAGS</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">FLAIR_TAGS</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;!coffee&quot;</span><span class="p">)</span>

    <span class="c1"># Object tags = Flair tags + ROT-DEFI</span>
    <span class="n">OBJECT_TAGS</span> <span class="o">=</span> <span class="n">FLAIR_TAGS</span><span class="p">[:]</span>
    <span class="n">OBJECT_TAGS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ROT-DEFI&quot;</span><span class="p">)</span>

    <span class="c1"># Particles</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;particles&quot;</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cardini</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pid</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pid&quot;</span><span class="p">:</span>
            <span class="n">tag</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">pid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;mass.&quot;</span> <span class="o">+</span> <span class="nb">id</span><span class="p">)</span>
            <span class="c1"># comment = cardini.get(section, &quot;comment.&quot; + id) #  TODO not used ?</span>
            <span class="n">pdg</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;pdg.&quot;</span> <span class="o">+</span> <span class="nb">id</span><span class="p">)</span>
            <span class="n">Particle</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">pdg</span><span class="p">)</span>
    <span class="n">Particle</span><span class="o">.</span><span class="n">makeLists</span><span class="p">()</span>

    <span class="c1"># Read default materials and create fake MATERIAL card&#39;s</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;materials&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;mat.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;desc.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">Amass</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;Amass.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;Z.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;rho.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Amass</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">desc</span><span class="p">)</span>
        <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">_defaultMaterials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">_defaultMatDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Read special ICRU materials</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;mat.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;desc.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">Amass</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;Amass.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;Z.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;rho.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">Card</span><span class="p">(</span><span class="s2">&quot;MATERIAL&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Amass</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span> <span class="n">desc</span><span class="p">)</span>
        <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;@n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">_icruMaterials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">_icruMatDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># Low neutrons energy groups</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;n-groups&quot;</span>
    <span class="c1"># Read number of groups</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;groups&quot;</span><span class="p">)</span>
        <span class="n">NGROUPS</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">say</span><span class="p">(</span><span class="s2">&quot;ERROR! No neutron energy groups defined&quot;</span><span class="p">)</span>

    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\S*) *(.*)$&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">NGROUPS</span><span class="p">:</span>
        <span class="n">groupsList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupsListS</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;ene.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">energy</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
            <span class="n">groupsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">groupsListS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">_neutronGroups</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupsList</span>
        <span class="n">_neutronGroupsS</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupsListS</span>

    <span class="c1"># Low neutrons energy groups</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">NGROUPS</span><span class="p">:</span>
        <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;low-neut&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;elem.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">mat</span> <span class="o">=</span> <span class="n">LowNeutMaterial</span><span class="p">()</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">elem</span> <span class="o">=</span> <span class="n">elem</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;mat.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;temp.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;db.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;name.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;ids.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">id1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">id2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">id3</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">mat</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">cardini</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&quot;g.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">materials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">_lowMaterials</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">materials</span>

    <span class="c1"># Read user routines</span>
    <span class="n">section</span> <span class="o">=</span> <span class="s2">&quot;usermvax&quot;</span>
    <span class="k">for</span> <span class="n">routine</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">cardini</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
        <span class="n">_usermvax</span><span class="p">[</span><span class="n">routine</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

    <span class="k">del</span> <span class="n">cardini</span></div>


<span class="k">if</span> <span class="n">__first</span><span class="p">:</span>
    <span class="n">__first</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">init</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">inp</span> <span class="o">=</span> <span class="n">Input</span><span class="p">()</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">convert2Names</span><span class="p">()</span>
    <span class="n">inp</span><span class="o">.</span><span class="n">regionProperties</span><span class="p">()</span>
    <span class="c1"># say(inp.materialList())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># f = open(sys.argv[3],&quot;w&quot;)</span>
        <span class="c1"># inp.writeGeometry(f, FORMAT_FREE, FORMAT_FREE)</span>
        <span class="c1"># f.close()</span>
        <span class="n">inp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Leszek Grzanka.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>