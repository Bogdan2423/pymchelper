
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymchelper.writers.trip98ddd &#8212; pymchelper 1.10.5 documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">pymchelper</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide.html">
  Userâ€™s Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../install.html">
  Detailed Installation Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../developer.html">
  Developer documentation
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for pymchelper.writers.trip98ddd</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="TRiP98DDDWriter"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.TRiP98DDDWriter">[docs]</a><span class="k">class</span> <span class="nc">TRiP98DDDWriter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writer for TRiP98 DDD files. File format is described here:</span>
<span class="sd">    http://bio.gsi.de/DOCS/TRiP98/PRO/DOCS/trip98fmtddd.html</span>

<span class="sd">    Only liquid water target is supported now.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_suffix_template</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{projectile:s}</span><span class="s1">.</span><span class="si">{material:s}</span><span class="s1">.</span><span class="si">{unit:s}{energy:s}</span><span class="s1">&#39;</span>

    <span class="n">_ddd_header_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;!filetype    ddd</span>
<span class="s2">!fileversion   </span><span class="si">{fileversion:s}</span><span class="s2"></span>
<span class="s2">!filedate      </span><span class="si">{filedate:s}</span><span class="s2"></span>
<span class="s2">!projectile    </span><span class="si">{projectile:s}</span><span class="s2"></span>
<span class="s2">!material      </span><span class="si">{material:s}</span><span class="s2"></span>
<span class="s2">!composition   </span><span class="si">{composition:s}</span><span class="s2"></span>
<span class="s2">!density </span><span class="si">{density:f}</span><span class="s2"></span>
<span class="s2">!energy </span><span class="si">{energy:f}</span><span class="s2"></span>
<span class="s2">#</span>
<span class="s2"># </span><span class="si">{creator:s}</span><span class="s2"></span>
<span class="s2">#</span>
<span class="s2">#   z[g/cm**2] dE/dz[MeV/(g/cm**2)] FWHM1[g/cm**2] factor FWHM2[g/cm**2]</span>
<span class="s2">!ddd</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_MeV_u</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">energy</span>  <span class="c1"># energy in MeV/u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectile</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">projectile</span>  <span class="c1"># projectile code, i.e. 1H, 12C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">ngauss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ddd&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span> <span class="o">+=</span> <span class="s2">&quot;.ddd&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">3e-3</span>
        <span class="n">env_var_name</span> <span class="o">=</span> <span class="s1">&#39;DDD_TAIL_THRESHOLD&#39;</span>
        <span class="k">if</span> <span class="n">env_var_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">env_var_name</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting tail threshold based on </span><span class="si">{:s}</span><span class="s2"> to </span><span class="si">{:f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_var_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span>

<div class="viewcode-block" id="TRiP98DDDWriter.write"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.TRiP98DDDWriter.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">):</span>

        <span class="c1"># guess projectile and energy from MC data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">element_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Be&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;Mg&#39;</span><span class="p">,</span> <span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Ca&#39;</span><span class="p">,</span> <span class="s1">&#39;Sc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Zn&#39;</span><span class="p">,</span> <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;Rb&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Zr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mo&#39;</span><span class="p">,</span> <span class="s1">&#39;Tc&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Ru&#39;</span><span class="p">,</span> <span class="s1">&#39;Rh&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="s1">&#39;Sn&#39;</span><span class="p">,</span> <span class="s1">&#39;Sb&#39;</span><span class="p">,</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Xe&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs&#39;</span><span class="p">,</span> <span class="s1">&#39;Ba&#39;</span><span class="p">,</span> <span class="s1">&#39;La&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Ce&#39;</span><span class="p">,</span> <span class="s1">&#39;Pr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nd&#39;</span><span class="p">,</span> <span class="s1">&#39;Pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Sm&#39;</span><span class="p">,</span> <span class="s1">&#39;Eu&#39;</span><span class="p">,</span> <span class="s1">&#39;Gd&#39;</span><span class="p">,</span> <span class="s1">&#39;Tb&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy&#39;</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">,</span> <span class="s1">&#39;Er&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm&#39;</span><span class="p">,</span> <span class="s1">&#39;Yb&#39;</span><span class="p">,</span> <span class="s1">&#39;Lu&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Os&#39;</span><span class="p">,</span> <span class="s1">&#39;Ir&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="s1">&#39;Hg&#39;</span><span class="p">,</span> <span class="s1">&#39;Tl&#39;</span><span class="p">,</span> <span class="s1">&#39;Pb&#39;</span><span class="p">,</span> <span class="s1">&#39;Bi&#39;</span><span class="p">,</span> <span class="s1">&#39;Po&#39;</span><span class="p">,</span> <span class="s1">&#39;At&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Rn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ra&#39;</span><span class="p">,</span> <span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;Th&#39;</span><span class="p">,</span> <span class="s1">&#39;Pa&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Np&#39;</span><span class="p">,</span> <span class="s1">&#39;Pu&#39;</span><span class="p">,</span> <span class="s1">&#39;Am&#39;</span><span class="p">,</span> <span class="s1">&#39;Cm&#39;</span><span class="p">,</span> <span class="s1">&#39;Bk&#39;</span><span class="p">,</span> <span class="s1">&#39;Cf&#39;</span><span class="p">,</span> <span class="s1">&#39;Es&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Fm&#39;</span><span class="p">,</span> <span class="s1">&#39;Md&#39;</span><span class="p">,</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="s1">&#39;Lr&#39;</span><span class="p">,</span> <span class="s1">&#39;Rf&#39;</span><span class="p">,</span> <span class="s1">&#39;Db&#39;</span><span class="p">,</span> <span class="s1">&#39;Sg&#39;</span><span class="p">,</span> <span class="s1">&#39;Bh&#39;</span><span class="p">,</span> <span class="s1">&#39;Hs&#39;</span><span class="p">,</span> <span class="s1">&#39;Mt&#39;</span><span class="p">,</span> <span class="s1">&#39;Ds&#39;</span><span class="p">,</span> <span class="s1">&#39;Rg&#39;</span><span class="p">,</span> <span class="s1">&#39;Cn&#39;</span><span class="p">,</span> <span class="s1">&#39;Nh&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Fl&#39;</span><span class="p">,</span> <span class="s1">&#39;Mc&#39;</span><span class="p">,</span> <span class="s1">&#39;Lv&#39;</span><span class="p">,</span> <span class="s1">&#39;Ts&#39;</span><span class="p">,</span> <span class="s1">&#39;Og&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:d}{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">projectile_a</span><span class="p">),</span>
                    <span class="n">element_names</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">projectile_z</span><span class="p">)],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projectile</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Projectile not available in raw data, setting to empty string&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_MeV_u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy_MeV_u</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="s1">&#39;Tmax_MeV/amu&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy_MeV_u</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Projectile energy not available in raw data, setting to 0&#39;</span><span class="p">)</span>

        <span class="c1">#     The usual naming convention is &lt;pp&gt;.&lt;tt&gt;.&lt;uuu&gt;&lt;eeeee&gt;.ddd, where &lt;pp&gt; denotes the projectile,</span>
        <span class="c1">#     &lt;tt&gt; the target material, &lt;uuu&gt; the unit (keV, MeV, GeV) and &lt;eeeee&gt; the energy in these units,</span>
        <span class="c1">#     with the decimal point after the middle digit. Example: 12C.H2O.MeV27000.spc refers to 270 MeV/u.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_suffix_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">projectile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projectile</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;MeV&#39;</span><span class="p">,</span>
                                                   <span class="n">energy</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_MeV_u</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

        <span class="c1"># save to single page to a file without number (i.e. output.ddd)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_single_page</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">estimator</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># split output path into directory, basename and extension</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="n">file_base_part</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddd_filename</span><span class="p">))</span>

            <span class="c1"># loop over all pages and save an image for each of them</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">pages</span><span class="p">):</span>

                <span class="c1"># calculate output filename. it will include page number padded with zeros.</span>
                <span class="c1"># for 10-99 pages the filename would look like: output_p01.ddd, ... output_p99.ddd</span>
                <span class="c1"># for 100-999 pages the filename would look like: output_p001.ddd, ... output_p999.ddd</span>
                <span class="n">zero_padded_page_no</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">pages</span><span class="p">))))</span>
                <span class="n">output_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_p</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base_part</span><span class="p">,</span> <span class="n">zero_padded_page_no</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>

                <span class="c1"># save the output file</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_single_page</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="TRiP98DDDWriter.write_single_page"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.TRiP98DDDWriter.write_single_page">[docs]</a>    <span class="k">def</span> <span class="nf">write_single_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="kn">from</span> <span class="nn">pymchelper.shieldhit.detector.detector_type</span> <span class="k">import</span> <span class="n">SHDetType</span>
        <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">dettyp</span> <span class="o">!=</span> <span class="n">SHDetType</span><span class="o">.</span><span class="n">ddd</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Incompatible estimator </span><span class="si">{:s}</span><span class="s2"> used, use </span><span class="si">{:s}</span><span class="s2"> instead&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">dettyp</span><span class="p">,</span> <span class="n">SHDetType</span><span class="o">.</span><span class="n">ddd</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="c1"># extract data from detector data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_data</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>

        <span class="c1"># in order to avoid fitting data to noisy region far behind Bragg peak tail,</span>
        <span class="c1"># find the range of z coordinate which contains (1-threshold) of the deposited energy</span>
        <span class="n">cum_dose</span> <span class="o">=</span> <span class="n">LateralDepthDoseProfile</span><span class="o">.</span><span class="n">cumulative_dose</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_1d</span><span class="p">)</span>
        <span class="n">cum_dose_left</span> <span class="o">=</span> <span class="n">LateralDepthDoseProfile</span><span class="o">.</span><span class="n">cumulative_dose_left</span><span class="p">(</span><span class="n">cum_dose</span><span class="p">)</span>

        <span class="n">thr_ind</span> <span class="o">=</span> <span class="n">cum_dose_left</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cum_dose_left</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">z_fitting_cm_1d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">z_cm_1d</span><span class="p">[:</span><span class="n">thr_ind</span><span class="p">]</span>
        <span class="n">dose_fitting_MeV_g_1d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_1d</span><span class="p">[:</span><span class="n">thr_ind</span><span class="p">]</span>

        <span class="c1"># r_fitting_cm_2d, z_fitting_cm_2d = np.meshgrid(data.r_cm_1d, z_fitting_cm_1d)</span>
        <span class="c1"># dose_fitting_MeV_g_2d = data.dose_MeV_g_2d[0:thr_ind]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting base data..&quot;</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">DebuggingPlots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">base_data</span><span class="p">(</span><span class="n">zmax_cm</span><span class="o">=</span><span class="n">z_fitting_cm_1d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>
            <span class="n">fig_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_depth_dose.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">DebuggingPlots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">base_data</span><span class="p">(</span><span class="n">zmax_cm</span><span class="o">=</span><span class="n">z_fitting_cm_1d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fig_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_depth_dose_log.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">DebuggingPlots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">map2d</span><span class="p">()</span>
                <span class="n">fig_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_dose_map.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">)</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">DebuggingPlots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">map2d</span><span class="p">(</span><span class="n">zlog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fig_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_dose_map_log.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">)</span>

        <span class="n">fit_results</span> <span class="o">=</span> <span class="n">FitResultCollection</span><span class="p">(</span><span class="n">z_fitting_cm_1d</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting...&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Number of bins in R dimension is </span><span class="si">{:d}</span><span class="s2"> and is lower than 10.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">1</span>

            <span class="c1"># for each depth fit a lateral beam with gaussian models</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">z_cm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z_fitting_cm_1d</span><span class="p">):</span>

                <span class="n">dose_at_z</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

                <span class="c1"># take into account only this position in r for which dose is positive</span>
                <span class="n">r_fitting_cm</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="p">[</span><span class="n">dose_at_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">dose_fitting_1d_positive_MeV_g</span> <span class="o">=</span> <span class="n">dose_at_z</span><span class="p">[</span><span class="n">dose_at_z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

                <span class="c1"># perform the fit</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">params_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lateral_fit</span><span class="p">(</span><span class="n">r_fitting_cm</span><span class="p">,</span>
                                                         <span class="n">dose_fitting_1d_positive_MeV_g</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># fitting failed, i.e. due to missing scipy</span>
                    <span class="k">return</span> <span class="mi">1</span>

                <span class="n">fwhm1_cm</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">fwhm2_cm</span><span class="p">,</span> <span class="n">dz0_MeV_cm_g</span> <span class="o">=</span> <span class="n">params</span>
                <span class="n">fwhm1_cm_error</span><span class="p">,</span> <span class="n">factor_error</span><span class="p">,</span> <span class="n">fwhm2_cm_error</span><span class="p">,</span> <span class="n">dz0_MeV_cm_g_error</span> <span class="o">=</span> <span class="n">params_error</span>

                <span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_cm</span>

                <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm1_cm</span>
                <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm1_cm_error</span>

                <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dz0_MeV_cm_g&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz0_MeV_cm_g</span>
                <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;dz0_MeV_cm_g&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz0_MeV_cm_g_error</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm2_cm</span>
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm2_cm_error</span>

                    <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span>
                    <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor_error</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Plotting fitting results...&quot;</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">DebuggingPlots</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit_summary</span><span class="p">(</span>
                <span class="n">fit_results</span>
            <span class="p">)</span>
            <span class="n">fig_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_fitting.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_filename</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">pymchelper</span> <span class="k">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">_pmcversion</span>
        <span class="n">_creator_info</span> <span class="o">=</span> <span class="s2">&quot;Created with pymchelper </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_pmcversion</span><span class="p">)</span>

        <span class="c1"># prepare header of DDD file</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddd_header_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fileversion</span><span class="o">=</span><span class="s1">&#39;19980520&#39;</span><span class="p">,</span>
            <span class="n">filedate</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%c</span><span class="s1">&#39;</span><span class="p">),</span>  <span class="c1"># Locale&#39;s appropriate date and time representation</span>
            <span class="n">projectile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projectile</span><span class="p">,</span>
            <span class="n">material</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span>
            <span class="n">composition</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">creator</span><span class="o">=</span><span class="n">_creator_info</span><span class="p">,</span>
            <span class="n">energy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_MeV_u</span><span class="p">)</span>

        <span class="n">filename_with_suffix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filename_with_suffix</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
        <span class="n">filename_with_suffix</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span>
        <span class="n">filename_with_suffix</span> <span class="o">+=</span> <span class="s1">&#39;.ddd&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename_with_suffix</span><span class="p">))</span>

        <span class="c1"># write the contents of the files</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_with_suffix</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ddd_file</span><span class="p">:</span>
            <span class="n">ddd_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="c1"># TODO write to DDD gaussian amplitude, not the dose in central bin</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z_cm</span><span class="p">,</span> <span class="n">dose</span><span class="p">,</span> <span class="n">fwhm1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">fwhm2_cm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">z_fitting_cm_1d</span><span class="p">,</span>
                                                                  <span class="n">dose_fitting_MeV_g_1d</span><span class="p">,</span>
                                                                  <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">],</span>
                                                                  <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">],</span>
                                                                  <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]):</span>
                    <span class="n">ddd_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">dose</span><span class="p">,</span> <span class="n">fwhm1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">fwhm2_cm</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z_cm</span><span class="p">,</span> <span class="n">dose</span><span class="p">,</span> <span class="n">fwhm_cm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">z_fitting_cm_1d</span><span class="p">,</span> <span class="n">dose_fitting_MeV_g_1d</span><span class="p">,</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">]):</span>
                    <span class="n">ddd_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">dose</span><span class="p">,</span> <span class="n">fwhm_cm</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngauss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z_cm</span><span class="p">,</span> <span class="n">dose</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">z_fitting_cm_1d</span><span class="p">,</span> <span class="n">dose_fitting_MeV_g_1d</span><span class="p">):</span>
                    <span class="n">ddd_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:g}</span><span class="s1"> </span><span class="si">{:g}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">dose</span><span class="p">))</span>

        <span class="k">return</span> <span class="mi">0</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_extract_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">r_step_cm</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_step_cm</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">max_val</span>

        <span class="k">if</span> <span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">z_step_cm</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z_step_cm</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">max_val</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">LateralDepthDoseProfile</span><span class="p">(</span><span class="n">r_cm_1d</span><span class="o">=</span><span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                       <span class="n">z_cm_1d</span><span class="o">=</span><span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                       <span class="n">dose_MeV_g_2d</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">data_raw</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">n</span><span class="p">)),</span>
                                       <span class="n">dose_error_MeV_g_2d</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">error_raw</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">estimator</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">estimator</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">n</span><span class="p">)),</span>
                                       <span class="n">r_step_cm</span><span class="o">=</span><span class="n">r_step_cm</span><span class="p">,</span>
                                       <span class="n">z_step_cm</span><span class="o">=</span><span class="n">z_step_cm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_lateral_fit</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">r_cm</span><span class="p">,</span> <span class="n">dose_MeV_g</span><span class="p">,</span> <span class="n">ngauss</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">r_cm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">dose_MeV_g</span><span class="p">)</span>

        <span class="n">start_amp_MeV_g</span> <span class="o">=</span> <span class="n">dose_MeV_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">start_sigma_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>

        <span class="n">min_amp_MeV_g</span> <span class="o">=</span> <span class="mf">1e-10</span> <span class="o">*</span> <span class="n">dose_MeV_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">min_sigma_cm</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="o">*</span> <span class="n">start_sigma_cm</span>

        <span class="n">max_amp_MeV_g</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dose_MeV_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">max_sigma_cm</span> <span class="o">=</span> <span class="mf">1e4</span> <span class="o">*</span> <span class="n">start_sigma_cm</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;scipy package missing, to install type `pip install scipy`&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ngauss</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">FittingMethods</span><span class="o">.</span><span class="n">gauss_r_MeV_cm_g</span><span class="p">,</span>
                                       <span class="n">xdata</span><span class="o">=</span><span class="n">r_cm</span><span class="p">,</span>
                                       <span class="n">ydata</span><span class="o">=</span><span class="n">dose_MeV_g</span> <span class="o">*</span> <span class="n">r_cm</span><span class="p">,</span>
                                       <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">start_amp_MeV_g</span><span class="p">,</span> <span class="n">start_sigma_cm</span><span class="p">],</span>
                                       <span class="n">bounds</span><span class="o">=</span><span class="p">([[</span><span class="n">min_amp_MeV_g</span><span class="p">,</span> <span class="n">min_sigma_cm</span><span class="p">],</span> <span class="p">[</span><span class="n">max_amp_MeV_g</span><span class="p">,</span> <span class="n">max_sigma_cm</span><span class="p">]]),</span>
                                       <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="c1"># TODO return also parameter errors</span>
                <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>

                <span class="n">dz0_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span> <span class="o">=</span> <span class="n">popt</span>
                <span class="n">dz0_MeV_cm_g_error</span><span class="p">,</span> <span class="n">sigma_cm_error</span> <span class="o">=</span> <span class="n">perr</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">dz0_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">dz0_MeV_cm_g_error</span><span class="p">,</span> <span class="n">sigma_cm_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">factor_error</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">fwhm2_cm</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">fwhm2_cm_error</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">elif</span> <span class="n">ngauss</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">start_weigth</span> <span class="o">=</span> <span class="mf">0.99</span>
            <span class="n">start_sigma2_add_cm</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="n">min_weigth</span> <span class="o">=</span> <span class="mf">0.55</span>
            <span class="n">min_sigma2_add_cm</span> <span class="o">=</span> <span class="mf">1e-1</span>

            <span class="n">max_weigth</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-12</span>
            <span class="n">max_sigma2_add_cm</span> <span class="o">=</span> <span class="mf">20.0</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">FittingMethods</span><span class="o">.</span><span class="n">gauss2_r_MeV_cm_g</span><span class="p">,</span>
                                       <span class="n">xdata</span><span class="o">=</span><span class="n">r_cm</span><span class="p">,</span>
                                       <span class="n">ydata</span><span class="o">=</span><span class="n">dose_MeV_g</span> <span class="o">*</span> <span class="n">r_cm</span><span class="p">,</span>
                                       <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">start_amp_MeV_g</span><span class="p">,</span> <span class="n">start_sigma_cm</span><span class="p">,</span> <span class="n">start_weigth</span><span class="p">,</span> <span class="n">start_sigma2_add_cm</span><span class="p">],</span>
                                       <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="n">min_amp_MeV_g</span><span class="p">,</span> <span class="n">min_sigma_cm</span><span class="p">,</span> <span class="n">min_weigth</span><span class="p">,</span> <span class="n">min_sigma2_add_cm</span><span class="p">],</span>
                                               <span class="p">[</span><span class="n">max_amp_MeV_g</span><span class="p">,</span> <span class="n">max_sigma_cm</span><span class="p">,</span> <span class="n">max_weigth</span><span class="p">,</span> <span class="n">max_sigma2_add_cm</span><span class="p">]),</span>
                                       <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">perr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov</span><span class="p">))</span>
                <span class="n">dz0_MeV_cm_g_error</span><span class="p">,</span> <span class="n">sigma_cm_error</span><span class="p">,</span> <span class="n">factor_error</span><span class="p">,</span> <span class="n">sigma2_add_cm_error</span> <span class="o">=</span> <span class="n">perr</span>
                <span class="n">dz0_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">sigma2_add_cm</span> <span class="o">=</span> <span class="n">popt</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">dz0_MeV_cm_g_error</span><span class="p">,</span> <span class="n">sigma_cm_error</span><span class="p">,</span> <span class="n">factor_error</span><span class="p">,</span> <span class="n">sigma2_add_cm_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">dz0_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">sigma2_add_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># TODO return also parameter errors</span>
            <span class="n">sigma2_cm</span> <span class="o">=</span> <span class="n">sigma_cm</span> <span class="o">+</span> <span class="n">sigma2_add_cm</span>
            <span class="n">sigma2_cm_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma_cm_error</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigma2_add_cm_error</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">fwhm2_cm</span> <span class="o">=</span> <span class="n">sigma2_cm</span> <span class="o">*</span> <span class="n">FittingMethods</span><span class="o">.</span><span class="n">_sigma_to_fwhm</span>
            <span class="n">fwhm2_cm_error</span> <span class="o">=</span> <span class="n">sigma2_cm_error</span> <span class="o">*</span> <span class="n">FittingMethods</span><span class="o">.</span><span class="n">_sigma_to_fwhm</span>

        <span class="n">fwhm1_cm</span> <span class="o">=</span> <span class="n">sigma_cm</span> <span class="o">*</span> <span class="n">FittingMethods</span><span class="o">.</span><span class="n">_sigma_to_fwhm</span>

        <span class="n">fwhm1_cm_error</span> <span class="o">=</span> <span class="n">sigma_cm_error</span> <span class="o">*</span> <span class="n">FittingMethods</span><span class="o">.</span><span class="n">_sigma_to_fwhm</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">fwhm1_cm</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">fwhm2_cm</span><span class="p">,</span> <span class="n">dz0_MeV_cm_g</span>
        <span class="n">params_error</span> <span class="o">=</span> <span class="n">fwhm1_cm_error</span><span class="p">,</span> <span class="n">factor_error</span><span class="p">,</span> <span class="n">fwhm2_cm_error</span><span class="p">,</span> <span class="n">dz0_MeV_cm_g_error</span>

        <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">params_error</span></div>


<div class="viewcode-block" id="FitResultCollection"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FitResultCollection">[docs]</a><span class="k">class</span> <span class="nc">FitResultCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit results collection (along Z axis)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span>
                             <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;factor&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;dz0_MeV_cm_g&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                    <span class="p">]</span>
                             <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,),</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                     <span class="p">(</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                     <span class="p">(</span><span class="s1">&#39;factor&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                     <span class="p">(</span><span class="s1">&#39;dz0_MeV_cm_g&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                     <span class="p">]</span>
                              <span class="p">)</span></div>


<div class="viewcode-block" id="LateralDepthDoseProfile"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.LateralDepthDoseProfile">[docs]</a><span class="k">class</span> <span class="nc">LateralDepthDoseProfile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base data for fitting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_cm_1d</span><span class="p">,</span> <span class="n">z_cm_1d</span><span class="p">,</span> <span class="n">dose_MeV_g_2d</span><span class="p">,</span> <span class="n">dose_error_MeV_g_2d</span><span class="p">,</span> <span class="n">r_step_cm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_step_cm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># 1D arrays of r,z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span> <span class="o">=</span> <span class="n">r_cm_1d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_cm_1d</span> <span class="o">=</span> <span class="n">z_cm_1d</span>

        <span class="c1"># 2D arrays of r,z, dose and error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_cm_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cm_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cm_1d</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span> <span class="o">=</span> <span class="n">dose_MeV_g_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dose_error_MeV_g_2d</span> <span class="o">=</span> <span class="n">dose_error_MeV_g_2d</span>

        <span class="c1"># dose in the very central bin</span>
        <span class="k">if</span> <span class="n">z_step_cm</span><span class="p">:</span>
            <span class="n">bin_width_z_cm</span> <span class="o">=</span> <span class="n">z_step_cm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cm_1d</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">bin_width_z_cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cm_1d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_cm_1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Z depth step cannot be estimated&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r_step_cm</span><span class="p">:</span>
            <span class="n">bin_width_r_cm</span> <span class="o">=</span> <span class="n">r_step_cm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">bin_width_r_cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Z depth step cannot be estimated&quot;</span><span class="p">)</span>

        <span class="c1"># Bin volume increases as we move away from beam axis</span>
        <span class="c1"># i-th bin volume = dz * pi * (r_i_max^2 - r_i_min^2  )</span>
        <span class="c1">#   r_i_max = r_i + dr / 2</span>
        <span class="c1">#   r_i_min = r_i - dr / 2</span>
        <span class="c1">#  r_i_max^2 - r_i_min^2 = (r_i_max - r_i_min)*(r_i_max + r_i_min) = dr * 2 * r_i    thus</span>
        <span class="c1"># i-th bin volume = 2 * pi * dr * r_i * dz</span>
        <span class="n">bin_volume_data_cm3_1d</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bin_width_r_cm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span> <span class="o">*</span> <span class="n">bin_width_z_cm</span>
        <span class="c1"># we assume density of 1 g/c3</span>
        <span class="n">density_g_cm3</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">energy_in_bin_MeV_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span> <span class="o">*</span> <span class="n">bin_volume_data_cm3_1d</span> <span class="o">*</span> <span class="n">density_g_cm3</span>
        <span class="n">total_bin_mass_g</span> <span class="o">=</span> <span class="n">density_g_cm3</span> <span class="o">*</span> <span class="n">bin_width_z_cm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r_cm_1d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_width_r_cm</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">total_energy_at_depth_MeV_1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_in_bin_MeV_2d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dose_MeV_g_1d</span> <span class="o">=</span> <span class="n">total_energy_at_depth_MeV_1d</span> <span class="o">/</span> <span class="n">total_bin_mass_g</span>

<div class="viewcode-block" id="LateralDepthDoseProfile.cumulative_dose"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.LateralDepthDoseProfile.cumulative_dose">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cumulative_dose</span><span class="p">(</span><span class="n">dose_1d</span><span class="p">):</span>
        <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">dose_1d</span><span class="p">)</span>
        <span class="n">cumsum</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dose_1d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cumsum</span></div>

<div class="viewcode-block" id="LateralDepthDoseProfile.cumulative_dose_left"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.LateralDepthDoseProfile.cumulative_dose_left">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cumulative_dose_left</span><span class="p">(</span><span class="n">cumsum</span><span class="p">):</span>
        <span class="n">cum_dose_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cumsum</span><span class="p">)</span>
        <span class="n">cum_dose_left</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">cum_dose_left</span> <span class="o">+=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">cum_dose_left</span></div></div>


<div class="viewcode-block" id="FittingMethods"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods">[docs]</a><span class="k">class</span> <span class="nc">FittingMethods</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functions describing Gaussian functions modelling lateral dose distributions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_sigma_to_fwhm</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>

<div class="viewcode-block" id="FittingMethods.gauss_MeV_g"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods.gauss_MeV_g">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gauss_MeV_g</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">amp_MeV_cm_g</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma_cm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma_cm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="FittingMethods.gauss_r_MeV_cm_g"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods.gauss_r_MeV_cm_g">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gauss_r_MeV_cm_g</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">gauss_MeV_g</span><span class="p">(</span><span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma_cm</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_cm</span></div>

<div class="viewcode-block" id="FittingMethods.gauss2_MeV_g"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods.gauss2_MeV_g">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gauss2_MeV_g</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sigma2_add_cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">amp_MeV_cm_g</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">sigma1_cm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma1_cm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">+</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma1_cm</span> <span class="o">+</span> <span class="n">sigma2_add_cm</span><span class="p">))</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma1_cm</span> <span class="o">+</span> <span class="n">sigma2_add_cm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FittingMethods.gauss2_MeV_g_1st"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods.gauss2_MeV_g_1st">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gauss2_MeV_g_1st</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sigma2_add_cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">amp_MeV_cm_g</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">sigma1_cm</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma1_cm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="FittingMethods.gauss2_MeV_g_2nd"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods.gauss2_MeV_g_2nd">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gauss2_MeV_g_2nd</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sigma2_add_cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">amp_MeV_cm_g</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">weight</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma1_cm</span> <span class="o">+</span> <span class="n">sigma2_add_cm</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="n">x_cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma1_cm</span> <span class="o">+</span> <span class="n">sigma2_add_cm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="FittingMethods.gauss2_r_MeV_cm_g"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.FittingMethods.gauss2_r_MeV_cm_g">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">gauss2_r_MeV_cm_g</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sigma2_add_cm</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">gauss2_MeV_g</span><span class="p">(</span><span class="n">x_cm</span><span class="p">,</span> <span class="n">amp_MeV_cm_g</span><span class="p">,</span> <span class="n">sigma1_cm</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">sigma2_add_cm</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_cm</span></div></div>


<div class="viewcode-block" id="DebuggingPlots"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.DebuggingPlots">[docs]</a><span class="k">class</span> <span class="nc">DebuggingPlots</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Debugging plots, mostly needed to inspect if Gaussian function fitting was successful</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">base_data</span>

<div class="viewcode-block" id="DebuggingPlots.base_data"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.DebuggingPlots.base_data">[docs]</a>    <span class="k">def</span> <span class="nf">base_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zmax_cm</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="c1"># set matplotlib logging level to ERROR, in order not to pollute our log space</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Matplotlib not installed, output won&#39;t be generated&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">z_cm_1d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_1d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dose&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">zmax_cm</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitting area, covers </span><span class="si">{:g}</span><span class="s2"> </span><span class="si">% o</span><span class="s2">f dose&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z [cm]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;dose [MeV/g]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logy</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="DebuggingPlots.map2d"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.DebuggingPlots.map2d">[docs]</a>    <span class="k">def</span> <span class="nf">map2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">zlog</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">colors</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Matplotlib not installed, output won&#39;t be generated&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="c1"># configure scale on Z axis</span>
        <span class="k">if</span> <span class="n">zlog</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                  <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                    <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">z_cm_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">r_cm_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dose_MeV_g_2d</span><span class="p">,</span>
                           <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gnuplot2&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dose&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Z [cm]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;R [cm]&quot;</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;dose [MeV/g]&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

        <span class="c1"># if z_fitting_cm_1d is not None and np.any(fwhm1_cm):</span>
        <span class="c1">#     plt.plot(z_fitting_cm_1d, fwhm1_cm, color=&#39;g&#39;, label=&quot;fwhm1&quot;)</span>
        <span class="c1"># if z_fitting_cm_1d is not None and np.any(fwhm2_cm):</span>
        <span class="c1">#     plt.plot(z_fitting_cm_1d, fwhm2_cm, color=&#39;r&#39;, label=&quot;fwhm2&quot;)</span>

        <span class="c1"># plot legend only if some of the FWHM 1-D overlays are present</span>
        <span class="c1"># adding legend to only pcolormesh plot will result in a warning about missing labels</span>
        <span class="c1"># if z_fitting_cm_1d is not None and (np.any(fwhm1_cm) or np.any(fwhm2_cm)):</span>
        <span class="c1">#     plt.legend(loc=0)</span>
        <span class="c1"># plt.xlabel(&quot;z [cm]&quot;)</span>
        <span class="c1"># plt.ylabel(&quot;r [cm]&quot;)</span>
        <span class="c1"># plt.xlim((z_fitting_cm_2d.min(), z_fitting_cm_2d.max()))</span>
        <span class="c1"># if np.any(fwhm1_cm) and np.any(fwhm2_cm):</span>
        <span class="c1">#     plt.ylim((r_fitting_cm_2d.min(), max(max(fwhm1_cm), max(fwhm2_cm))))</span>
        <span class="c1"># plt.clim((1e-8 * dose_fitting_MeV_g2d.max(), dose_fitting_MeV_g2d.max()))</span>
        <span class="c1"># out_filename = prefix + &#39;dosemap&#39; + suffix + &#39;.png&#39;</span>
        <span class="c1"># logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1"># plt.savefig(out_filename)</span>
        <span class="c1"># if self.verbosity &gt; 1:</span>
        <span class="c1">#     plt.yscale(&#39;log&#39;)</span>
        <span class="c1">#     out_filename = prefix + &#39;dosemap_log&#39; + suffix + &#39;.png&#39;</span>
        <span class="c1">#     logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#     plt.savefig(out_filename)</span>
        <span class="c1"># plt.close()</span>
        <span class="c1">#</span>
        <span class="c1"># if self.verbosity &gt; 2 and (np.any(fwhm1_cm) or np.any(fwhm2_cm)):</span>
        <span class="c1">#     # TODO add plotting sum of 2 gausses</span>
        <span class="c1">#</span>
        <span class="c1">#     sigma1_cm = fwhm1_cm / self._sigma_to_fwhm</span>
        <span class="c1">#     sigma2_cm = fwhm2_cm / self._sigma_to_fwhm</span>
        <span class="c1">#     gauss_amplitude_MeV_g = dz0_MeV_cm_g_data</span>
        <span class="c1">#     for z_cm, sigma1_at_z_cm, sigma2_at_z_cm, factor, amplitude_MeV_g in \</span>
        <span class="c1">#             zip(z_fitting_cm_1d, sigma1_cm, sigma2_cm, weight, gauss_amplitude_MeV_g):</span>
        <span class="c1">#         dose_mc_MeV_g = self.dose_data_MeV_g_2d[self.z_data_cm_2d == z_cm]</span>
        <span class="c1">#         title = &quot;Z = {:4.3f} cm,  sigma1 = {:4.3f} cm&quot;.format(z_cm, sigma1_at_z_cm)</span>
        <span class="c1">#         plt.plot(self.r_data_cm_1d, dose_mc_MeV_g, &#39;k.&#39;, label=&quot;data&quot;)</span>
        <span class="c1">#         if self.ngauss == 1:</span>
        <span class="c1">#             gauss_data_MeV_g = self.gauss_MeV_g(self.r_data_cm_1d, amplitude_MeV_g, sigma1_at_z_cm)</span>
        <span class="c1">#             plt.plot(self.r_data_cm_1d, gauss_data_MeV_g, label=&quot;fit&quot;)</span>
        <span class="c1">#         elif self.ngauss == 2:</span>
        <span class="c1">#             gauss_data_MeV_g = self.gauss2_MeV_g(self.r_data_cm_1d, amplitude_MeV_g,</span>
        <span class="c1">#                                                  sigma1_at_z_cm, factor, sigma2_at_z_cm)</span>
        <span class="c1">#             gauss_data_MeV_g_1st = self.gauss2_MeV_g_1st(self.r_data_cm_1d, amplitude_MeV_g,</span>
        <span class="c1">#                                                          sigma1_at_z_cm, factor, sigma2_at_z_cm)</span>
        <span class="c1">#             gauss_data_MeV_g_2nd = self.gauss2_MeV_g_2nd(self.r_data_cm_1d, amplitude_MeV_g,</span>
        <span class="c1">#                                                          sigma1_at_z_cm, factor, sigma2_at_z_cm)</span>
        <span class="c1">#             plt.plot(self.r_data_cm_1d, gauss_data_MeV_g, label=&quot;fit&quot;)</span>
        <span class="c1">#             plt.plot(self.r_data_cm_1d, gauss_data_MeV_g_1st, label=&quot;fit 1st gauss&quot;)</span>
        <span class="c1">#             plt.plot(self.r_data_cm_1d, gauss_data_MeV_g_2nd, label=&quot;fit 2nd gauss&quot;)</span>
        <span class="c1">#             title += &quot;, sigma2 = {:4.3f} cm, factor = {:4.6f}&quot;.format(sigma2_at_z_cm, factor)</span>
        <span class="c1">#         logger.debug(&quot;Plotting at &quot; + title)</span>
        <span class="c1">#         plt.title(title)</span>
        <span class="c1">#         plt.legend(loc=0)</span>
        <span class="c1">#         plt.yscale(&#39;log&#39;)</span>
        <span class="c1">#         plt.xlabel(&quot;r [cm]&quot;)</span>
        <span class="c1">#         plt.ylabel(&quot;dose [MeV/g]&quot;)</span>
        <span class="c1">#         plt.ylim([dose_mc_MeV_g.min(), dose_mc_MeV_g.max()])</span>
        <span class="c1">#         if self.ngauss == 1:</span>
        <span class="c1">#             plt.ylim([dose_mc_MeV_g.min(), max(gauss_data_MeV_g.max(), dose_mc_MeV_g.max())])</span>
        <span class="c1">#         out_filename = prefix + &quot;fit_details_{:4.3f}_log&quot;.format(z_cm) + suffix + &#39;.png&#39;</span>
        <span class="c1">#         logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#         plt.savefig(out_filename)</span>
        <span class="c1">#</span>
        <span class="c1">#         plt.xscale(&#39;log&#39;)</span>
        <span class="c1">#         plt.xlim([0, self.r_data_cm_1d.max()])</span>
        <span class="c1">#         out_filename = prefix + &quot;fit_details_{:4.3f}_loglog&quot;.format(z_cm) + suffix + &#39;.png&#39;</span>
        <span class="c1">#         logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#         plt.savefig(out_filename)</span>
        <span class="c1">#</span>
        <span class="c1">#         plt.xscale(&#39;linear&#39;)</span>
        <span class="c1">#         plt.xlim([0, 5.0 * sigma2_at_z_cm])</span>
        <span class="c1">#         plt.ylim([dose_mc_MeV_g[self.r_data_cm_1d &lt; 5.0 * sigma2_at_z_cm].min(), dose_mc_MeV_g.max()])</span>
        <span class="c1">#         out_filename = prefix + &quot;fit_details_{:4.3f}_small_log&quot;.format(z_cm) + suffix + &#39;.png&#39;</span>
        <span class="c1">#         logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#         plt.savefig(out_filename)</span>
        <span class="c1">#</span>
        <span class="c1">#         plt.close()</span>
        <span class="c1">#</span>
        <span class="c1">#         plt.plot(self.r_data_cm_1d, dose_mc_MeV_g * self.r_data_cm_1d, &#39;k.&#39;, label=&quot;data&quot;)</span>
        <span class="c1">#         plt.plot(self.r_data_cm_1d, gauss_data_MeV_g * self.r_data_cm_1d, label=&quot;fit&quot;)</span>
        <span class="c1">#         plt.legend(loc=0)</span>
        <span class="c1">#         plt.ylabel(&quot;dose * r [MeV cm/g]&quot;)</span>
        <span class="c1">#         plt.ylim([(dose_mc_MeV_g * self.r_data_cm_1d).min(), (dose_mc_MeV_g * self.r_data_cm_1d).max()])</span>
        <span class="c1">#         plt.yscale(&#39;log&#39;)</span>
        <span class="c1">#         out_filename = prefix + &quot;fit_details_{:4.3f}_r_log&quot;.format(z_cm) + suffix + &#39;.png&#39;</span>
        <span class="c1">#         logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#         plt.savefig(out_filename)</span>
        <span class="c1">#         plt.xscale(&#39;log&#39;)</span>
        <span class="c1">#         out_filename = prefix + &quot;fit_details_{:4.3f}_r_loglog&quot;.format(z_cm) + suffix + &#39;.png&#39;</span>
        <span class="c1">#         logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#         plt.savefig(out_filename)</span>
        <span class="c1">#         plt.close()</span>

<div class="viewcode-block" id="DebuggingPlots.fit_summary"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.trip98ddd.html#pymchelper.writers.trip98ddd.DebuggingPlots.fit_summary">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fit_summary</span><span class="p">(</span><span class="n">fit_results</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="c1"># set matplotlib logging level to ERROR, in order not to pollute our log space</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Matplotlib not installed, output won&#39;t be generated&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="c1"># left Y axis dedicated to FWHM, right one to weight</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">lns1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fwhm1&#39;</span><span class="p">)</span>
        <span class="n">upper_fwhm1_line</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">]</span>
        <span class="n">lower_fwhm1_line</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;fwhm1_cm&#39;</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">lower_fwhm1_line</span><span class="p">,</span> <span class="n">upper_fwhm1_line</span><span class="p">,</span>
                         <span class="n">where</span><span class="o">=</span><span class="n">upper_fwhm1_line</span> <span class="o">&gt;=</span> <span class="n">lower_fwhm1_line</span><span class="p">,</span>
                         <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                         <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lns2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;fwhm2&#39;</span><span class="p">)</span>
            <span class="n">upper_fwhm2_line</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]</span>
            <span class="n">lower_fwhm2_line</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">lower_fwhm2_line</span><span class="p">,</span> <span class="n">upper_fwhm2_line</span><span class="p">,</span>
                             <span class="n">where</span><span class="o">=</span><span class="n">upper_fwhm2_line</span> <span class="o">&gt;=</span> <span class="n">lower_fwhm2_line</span><span class="p">,</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">lns3</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;factor&#39;</span><span class="p">)</span>
            <span class="n">upper_weight_line</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">]</span>
            <span class="n">lower_weight_line</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;factor&#39;</span><span class="p">]</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">fit_results</span><span class="o">.</span><span class="n">z_cm</span><span class="p">,</span> <span class="n">lower_weight_line</span><span class="p">,</span> <span class="n">upper_weight_line</span><span class="p">,</span>
                             <span class="n">where</span><span class="o">=</span><span class="n">upper_weight_line</span> <span class="o">&gt;=</span> <span class="n">lower_weight_line</span><span class="p">,</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;weight of FWHM1 (factor)&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Z [cm]&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;FWHM [cm]&#39;</span><span class="p">)</span>

        <span class="c1"># add by hand line plots and labels to legend</span>
        <span class="n">line_objs</span> <span class="o">=</span> <span class="n">lns1</span>
        <span class="k">if</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fwhm2_cm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_objs</span> <span class="o">+=</span> <span class="n">lns2</span>
            <span class="n">line_objs</span> <span class="o">+=</span> <span class="n">lns3</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">line_obj</span><span class="o">.</span><span class="n">get_label</span><span class="p">()</span> <span class="k">for</span> <span class="n">line_obj</span> <span class="ow">in</span> <span class="n">line_objs</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">line_objs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>
        <span class="c1">#</span>
        <span class="c1"># r_step_cm = self.r_data_cm_1d[1] - self.r_data_cm_1d[0]</span>
        <span class="c1"># r_max_cm = self.r_data_cm_1d[-1] + 0.5 * r_step_cm</span>

        <span class="c1"># beam model for single gaussian is following:</span>
        <span class="c1">#  G(r, sigma) = 1 / (2pi sigma) * exp( - 0.5 r^2 / sigma^2)</span>
        <span class="c1">#  D(z,r) = D(z,0) * G(r, sigma)</span>
        <span class="c1"># for double gaussian it is following:</span>
        <span class="c1">#  D(z,r) = D(z,0) * ( w * G(r, sigma1) + (1-w) * G(r, sigma2))</span>
        <span class="c1">#</span>
        <span class="c1"># to get depth dose profile D(z) we need to calculate average dose in some volume at depth z</span>
        <span class="c1"># (calculating average dose in a subspace separated by two planes at z=z0 and z=z0+dz will lead to zero dose)</span>
        <span class="c1"># we cannot use simple arithmetic mean, as we are dealing with cylindrical scoring and bin mass depends on r</span>
        <span class="c1">#</span>
        <span class="c1"># let rmax be radius of biggest bin in cylindrical scoring</span>
        <span class="c1"># we calculate D(z) which will correspond to depth-dose profile measured with ion. chamber of radius rmax</span>
        <span class="c1"># it is basically energy E(z) deposited in slice of radius rmax and thickness dz divided by slice mass</span>
        <span class="c1"># D(z) = E(z) / m(z) = E(z) / (pi rmax^2 dz rho)</span>
        <span class="c1"># energy E(z) is the sum of energy in all cylindrical shell in a slice and can be calculated as integral</span>
        <span class="c1"># thin shell has surface at radius r has surface: 2 pi r dr, thus</span>
        <span class="c1"># E(z) = \int_0^rmax D(r,z) rho dz 2 pi r dr</span>
        <span class="c1"># finally:</span>
        <span class="c1"># D(z) = \int_0^rmax D(r,z) rho dz 2 pi r dr / (pi rmax^2 dz rho)   which leads to:</span>
        <span class="c1">#</span>
        <span class="c1"># D(z) = 2 / rmax^2 \int_0^rmax D(r,z) r dr</span>
        <span class="c1">#</span>
        <span class="c1"># for single gaussian model this gives:</span>
        <span class="c1">#</span>
        <span class="c1"># D(z) = 2 / rmax^2 \int_0^rmax D(z,0) * G(r, sigma) r dr = D(z,0) / rmax^2 \int_0^rmax G(r, sigma) r dr</span>
        <span class="c1">#      = D(z,0) / (2 pi sigma rmax^2) \int_0^rmax exp( - 0.5 r^2 / sigma^2) r dr</span>
        <span class="c1">#</span>
        <span class="c1"># integral \int exp( - 0.5 r^2 / sigma^2) r dr is easy to calculate:</span>
        <span class="c1"># https://www.wolframalpha.com/input/?i=%5Cint+exp(+-+0.5+r%5E2+%2F+sigma%5E2)+r+dr</span>
        <span class="c1">#</span>
        <span class="c1">#  \int exp( - 0.5 r^2 / sigma^2) r dr = -sigma^2 exp( - 0.5 r^2 / sigma^2)</span>
        <span class="c1">#</span>
        <span class="c1"># which leads to</span>
        <span class="c1">#</span>
        <span class="c1"># \int_0^rmax exp( - 0.5 r^2 / sigma^2) r dr = sigma^2 ( 1 - exp( - 0.5 rmax^2 / sigma^2))</span>
        <span class="c1">#</span>
        <span class="c1"># this means depth-dose curve for single gaussian model can be expressed as:</span>
        <span class="c1">#</span>
        <span class="c1"># D(z) = D(z,0) / (2 pi sigma rmax^2) * sigma^2 ( 1 - exp( - 0.5 rmax^2 / sigma^2))</span>
        <span class="c1">#</span>
        <span class="c1"># or</span>
        <span class="c1">#</span>
        <span class="c1"># D(z) = sigma * D(z,0) * ( 1 - exp( - 0.5 rmax^2 / sigma^2)) / (2 pi rmax^2)</span>
        <span class="c1">#</span>
        <span class="c1"># double gaussian can be calculated in similar way and leads to:</span>
        <span class="c1">#</span>
        <span class="c1"># D(z) = D(z,0) / (2 pi rmax^2) * ( w * sigma1 * ( 1 - exp( - 0.5 rmax^2 / sigma1^2)) +</span>
        <span class="c1">#                                 ( (1-w) * sigma2 * ( 1 - exp( - 0.5 rmax^2 / sigma2^2)))</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># if self.ngauss == 1:</span>
        <span class="c1">#     sigma1_cm = fwhm1_cm_data / self._sigma_to_fwhm</span>
        <span class="c1">#     # sigma * D(z,0) / (2 pi rmax^2)</span>
        <span class="c1">#     fit_dose_MeV_g = sigma1_cm * dz0_MeV_cm_g_data / (2.0 * np.pi * r_max_cm ** 2)</span>
        <span class="c1">#     # missing ( 1 - exp( - 0.5 rmax^2 / sigma^2))</span>
        <span class="c1">#     fit_dose_MeV_g *= (np.ones_like(sigma1_cm) - np.exp(-0.5 * r_max_cm / sigma1_cm**2))</span>
        <span class="c1">#     plt.plot(z_fitting_cm_1d, fit_dose_MeV_g, &#39;r&#39;, label=&#39;dose fit&#39;)</span>
        <span class="c1"># if self.ngauss == 2:</span>
        <span class="c1">#     sigma1_cm = fwhm1_cm_data / self._sigma_to_fwhm</span>
        <span class="c1">#     sigma2_cm = fwhm2_cm_data / self._sigma_to_fwhm</span>
        <span class="c1">#     w = weight_data</span>
        <span class="c1">#</span>
        <span class="c1">#     # ( w * sigma1 * ( 1 - exp( - 0.5 rmax^2 / sigma1^2))</span>
        <span class="c1">#     fit_dose_MeV_g = w * sigma1_cm * \</span>
        <span class="c1">#         (np.ones_like(sigma1_cm) - np.exp(-0.5 * r_max_cm / sigma1_cm**2))</span>
        <span class="c1">#</span>
        <span class="c1">#     # ( (1-w) * sigma2 * ( 1 - exp( - 0.5 rmax^2 / sigma2^2)))</span>
        <span class="c1">#     fit_dose_MeV_g += (np.ones_like(w) - w) * sigma2_cm * \</span>
        <span class="c1">#         (np.ones_like(sigma2_cm) - np.exp(-0.5 * r_max_cm / sigma2_cm**2))</span>
        <span class="c1">#</span>
        <span class="c1">#     # D(z,0) / (2 pi rmax^2)</span>
        <span class="c1">#     fit_dose_MeV_g *= dz0_MeV_cm_g_data / (2.0 * np.pi * r_max_cm ** 2)</span>
        <span class="c1">#     plt.plot(z_fitting_cm_1d, fit_dose_MeV_g, &#39;r&#39;, label=&#39;dose fit&#39;)</span>
        <span class="c1">#</span>
        <span class="c1"># plt.plot(z_fitting_cm_1d, dose_fitting_MeV_g_1d, &#39;b&#39;, label=&#39;dose MC&#39;)</span>
        <span class="c1"># plt.xlabel(&#39;z [cm]&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;dose [MeV/g]&#39;)</span>
        <span class="c1"># plt.legend(loc=0)</span>
        <span class="c1"># out_filename = prefix + &#39;dose_fit.png&#39;</span>
        <span class="c1"># logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1"># plt.savefig(out_filename)</span>
        <span class="c1"># if self.verbosity &gt; 1:</span>
        <span class="c1">#     plt.yscale(&#39;log&#39;)</span>
        <span class="c1">#     out_filename = prefix + &#39;dose_fit_log.png&#39;</span>
        <span class="c1">#     logger.info(&#39;Saving &#39; + out_filename)</span>
        <span class="c1">#     plt.savefig(out_filename)</span>
        <span class="c1"># plt.close()</span>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Leszek Grzanka.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.1.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>