
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymchelper.writers.fortranformatter &#8212; pymchelper 1.10.11 documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">pymchelper</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide.html">
  Userâ€™s Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../install.html">
  Installation Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../developer.html">
  Developer documentation
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for pymchelper.writers.fortranformatter</h1><div class="highlight"><pre>
<span></span><span class="n">PROC_MIN_FIELD_WIDTH</span> <span class="o">=</span> <span class="mi">46</span>
<span class="n">PROC_DECIMAL_CHAR</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
<span class="n">PROC_NO_LEADING_BLANK</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># based on https://bitbucket.org/brendanarnold/py-fortranformat</span>


<span class="k">def</span> <span class="nf">_swapchar</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">newch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to make chars in a string mutableish</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;index out of range&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">newch</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>


<span class="k">def</span> <span class="nf">_compose_nan_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ftype</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Allow at least &#39;NaN&#39; to be printed</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># n.b. this is what is set in Gfortran 4.4.0</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="n">w</span>
    <span class="k">return</span> <span class="s1">&#39;NaN&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_calculate_sign</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">negative_flag</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">negative_flag</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">elif</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;incl_plus&#39;</span><span class="p">]:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_compose_inf_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="c1"># Allow at least &#39;Inf&#39; to be printed</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="n">w</span>
        <span class="c1"># Change sign if negative</span>
        <span class="k">if</span> <span class="n">sign_bit</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
            <span class="c1"># Require sign if negative, if no space then overflow</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="n">w</span>
        <span class="c1"># Output long version if long enough</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">sign</span> <span class="o">+</span> <span class="s1">&#39;Infinity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="c1"># Output shortened version with sign if long enough</span>
        <span class="k">elif</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">sign</span> <span class="o">+</span> <span class="s1">&#39;Inf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="c1"># Should only output short version with no sign if positive</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Inf&#39;</span>


<span class="k">def</span> <span class="nf">_compose_float_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ftype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adapted from code in glibfortran which is written in C so is somwhat</span>
<span class="sd">    &#39;bit-pushy&#39; in nature. Writes the value to an initial string (buffer)</span>
<span class="sd">    and then pulls the subsequent strings from that</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unspecified precision&#39;</span><span class="p">)</span>
    <span class="c1"># Make sure they are ints</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="c1"># ==== write_float ==== (function)</span>
    <span class="n">edigits</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Largest number of exponent digits expected</span>
    <span class="c1"># Otherwise convert knowing what the required precision is (i.e. knowing d)</span>
    <span class="n">ndigits</span> <span class="o">=</span> <span class="n">d</span>
    <span class="k">if</span> <span class="n">ndigits</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PROC_MIN_FIELD_WIDTH</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">edigits</span><span class="p">):</span>
        <span class="n">ndigits</span> <span class="o">=</span> <span class="n">PROC_MIN_FIELD_WIDTH</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">edigits</span>
    <span class="c1"># ==== WRITE_FLOAT ==== (macro)</span>
    <span class="c1"># Determine sign of value</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">sign_bit</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign_bit</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="c1"># handle the nan and inf cases</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_compose_nan_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
    <span class="n">infinity</span> <span class="o">=</span> <span class="mf">1e1000000</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="n">infinity</span><span class="p">,</span> <span class="n">infinity</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_compose_inf_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="c1"># Round the input if the input is less than 1</span>
    <span class="n">zero_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># === DTOA === (macro)</span>
    <span class="c1"># write the tmp value to the string buffer</span>
    <span class="c1"># sprintf seems to allow negative number of decimal places,</span>
    <span class="c1"># need to correct for this</span>
    <span class="k">if</span> <span class="n">ndigits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;%+-#</span><span class="si">{:d}</span><span class="s2">e&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PROC_MIN_FIELD_WIDTH</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;%+-#</span><span class="si">{:d}</span><span class="s2">.</span><span class="si">{:d}</span><span class="s2">e&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PROC_MIN_FIELD_WIDTH</span><span class="p">,</span> <span class="n">ndigits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">tmp</span>
    <span class="c1"># === WRITE_FLOAT === (macro)</span>
    <span class="k">return</span> <span class="n">_output_float</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">,</span> <span class="n">zero_flag</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">,</span> <span class="n">edigits</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_output_float</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">,</span> <span class="n">zero_flag</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">,</span> <span class="n">edigits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO</span>
<span class="sd">    :param w:</span>
<span class="sd">    :param d:</span>
<span class="sd">    :param e:</span>
<span class="sd">    :param state:</span>
<span class="sd">    :param ft:</span>
<span class="sd">    :param buff:</span>
<span class="sd">    :param sign_bit:</span>
<span class="sd">    :param zero_flag:</span>
<span class="sd">    :param ndigits:</span>
<span class="sd">    :param edigits:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># nbefore - number of digits before the decimal point</span>
    <span class="c1"># nzero - number of zeros after the decimal point</span>
    <span class="c1"># nafter - number of digits after the decimal point</span>
    <span class="c1"># nzero_real - number of zeros after the decimal point</span>
    <span class="c1">#               regardles of the precision</span>

    <span class="c1"># Some hacks to change None to -1 (C convention)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">nzero_real</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">_calculate_sign</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">sign_bit</span><span class="p">)</span>
    <span class="c1"># Some debug</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">ndigits</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span>
    <span class="c1"># Read in the exponent</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buff</span><span class="p">[</span><span class="n">ndigits</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># Handle zero case</span>
    <span class="k">if</span> <span class="n">zero_flag</span><span class="p">:</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">_calculate_sign</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Handle special case</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="c1"># Get rid of the decimal and the initial sign i.e. normalise the digits</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">buff</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
    <span class="c1"># Find out where to place the decimal point</span>
    <span class="k">if</span> <span class="n">ft</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Precision not greater &quot;</span> <span class="s2">&quot;than zero in format specifier &#39;E&#39; or &#39;D&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Scale factor out of range &quot;</span> <span class="s2">&quot;in format specifier &#39;E&#39; or &#39;D&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zero_flag</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">-</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nbefore</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nzero</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span>
            <span class="n">nafter</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nbefore</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">nzero</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nafter</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nbefore</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nzero</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nafter</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">expchar</span> <span class="o">=</span> <span class="n">ft</span>
    <span class="c1"># Round the value</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nbefore</span> <span class="o">+</span> <span class="n">nafter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ndigits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nzero_real</span> <span class="o">==</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">):</span>
            <span class="c1"># We rounded to zero but shouldn&#39;t have</span>
            <span class="n">nzero</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">nafter</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="n">digits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ndigits</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nbefore</span> <span class="o">+</span> <span class="n">nafter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ndigits</span><span class="p">:</span>
        <span class="n">ndigits</span> <span class="o">=</span> <span class="n">nbefore</span> <span class="o">+</span> <span class="n">nafter</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ndigits</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># Propagate the carry</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">digit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">digit</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">digits</span> <span class="o">=</span> <span class="n">_swapchar</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">digit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">digits</span> <span class="o">=</span> <span class="n">_swapchar</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c1"># Did the carry overflow?</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">digits</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="n">digits</span>
                <span class="k">if</span> <span class="n">ft</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nzero</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nzero</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="n">nafter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nbefore</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">ft</span> <span class="o">==</span> <span class="s1">&#39;EN&#39;</span><span class="p">:</span>
                    <span class="n">nbefore</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">nbefore</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">nbefore</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">ex</span> <span class="o">+=</span> <span class="mi">3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ex</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Calculate the format of the exponent field</span>
    <span class="k">if</span> <span class="n">expchar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># i = abs(ex)</span>
        <span class="c1"># while i &gt;= 10:</span>
        <span class="c1">#     edigits = edigits + 1</span>
        <span class="c1">#     i = i / 10.0</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Width not specified, must be no more than 3 digits</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="o">&gt;</span> <span class="mi">999</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ex</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">999</span><span class="p">):</span>
                <span class="n">edigits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edigits</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ex</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ex</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">99</span><span class="p">):</span>
                    <span class="n">expchar</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
            <span class="n">edigits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
            <span class="c1"># Exponenet width specified, check it is wide enough</span>
            <span class="k">if</span> <span class="n">edigits</span> <span class="o">&gt;</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">edigits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edigits</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">edigits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Zero values always output as positive,</span>
    <span class="c1"># even if the value was egative before rounding</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ndigits</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ndigits</span><span class="p">:</span>
        <span class="c1"># The output is zero so set sign accordingly</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">_calculate_sign</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Pick a field size if none was specified</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">nbefore</span> <span class="o">+</span> <span class="n">nzero</span> <span class="o">+</span> <span class="n">nafter</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
    <span class="c1"># Work out how much padding is needed</span>
    <span class="n">nblanks</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-</span> <span class="p">(</span><span class="n">nbefore</span> <span class="o">+</span> <span class="n">nzero</span> <span class="o">+</span> <span class="n">nafter</span> <span class="o">+</span> <span class="n">edigits</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sign</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">nblanks</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="c1"># Check value fits in specified width</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nblanks</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">edigits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="n">w</span>
    <span class="c1"># See if we have space for a zero before the decimal point</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nbefore</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nblanks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">leadzero</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nblanks</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leadzero</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Pad to full field width</span>
    <span class="k">if</span> <span class="n">nblanks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># dtp-&gt;u.p.no_leading_blank</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">nblanks</span>
    <span class="c1"># Attach the sign</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="n">sign</span>
    <span class="c1"># Add the lead zero if necessary</span>
    <span class="k">if</span> <span class="n">leadzero</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span>
    <span class="c1"># Output portion before the decimal point padded with zeros</span>
    <span class="k">if</span> <span class="n">nbefore</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nbefore</span> <span class="o">&gt;</span> <span class="n">ndigits</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">digits</span><span class="p">[:</span><span class="n">ndigits</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nbefore</span> <span class="o">-</span> <span class="n">ndigits</span><span class="p">))</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">ndigits</span><span class="p">:]</span>
            <span class="n">ndigits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">nbefore</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">digits</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
            <span class="n">ndigits</span> <span class="o">-=</span> <span class="n">i</span>
    <span class="c1"># Output the decimal point</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="n">PROC_DECIMAL_CHAR</span>
    <span class="c1"># Output the leading zeros after the decimal point</span>
    <span class="k">if</span> <span class="n">nzero</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="n">nzero</span>
    <span class="c1"># Output the digits after the decimal point, padded with zeros</span>
    <span class="k">if</span> <span class="n">nafter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nafter</span> <span class="o">&gt;</span> <span class="n">ndigits</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">ndigits</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">nafter</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nafter</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">digits</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">zeros</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">nafter</span><span class="p">:]</span>
        <span class="n">ndigits</span> <span class="o">-=</span> <span class="n">nafter</span>
    <span class="c1"># Output the exponent</span>
    <span class="k">if</span> <span class="n">expchar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">expchar</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">expchar</span>
            <span class="n">edigits</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;%+0&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">edigits</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;d&#39;</span>
        <span class="n">tmp_buff</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">ex</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">tmp_buff</span>
    <span class="k">return</span> <span class="n">out</span>


<div class="viewcode-block" id="format_d"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.fortranformatter.html#pymchelper.writers.fortranformatter.format_d">[docs]</a><span class="k">def</span> <span class="nf">format_d</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO</span>
<span class="sd">    :param w:</span>
<span class="sd">    :param d:</span>
<span class="sd">    :param val:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ftype</span> <span class="o">=</span> <span class="s1">&#39;D&#39;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;blanks_as_zeros&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;incl_plus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;halt_if_no_vals&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">_compose_float_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span></div>


<div class="viewcode-block" id="format_e"><a class="viewcode-back" href="../../../apidoc/pymchelper.writers.fortranformatter.html#pymchelper.writers.fortranformatter.format_e">[docs]</a><span class="k">def</span> <span class="nf">format_e</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO</span>
<span class="sd">    :param w:</span>
<span class="sd">    :param d:</span>
<span class="sd">    :param val:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ftype</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;blanks_as_zeros&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;incl_plus&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;halt_if_no_vals&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">_compose_float_string</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span></div>
</pre></div>

              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Leszek Grzanka.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>